<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‚ú® Planner Premium ULTRA</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root { --primary: #6B46C1; --secondary: #EC4899; --success: #10B981; --danger: #EF4444; --dark: #1F2937; --light: #F9FAFB; --gray: #E5E7EB; }
        body { font-family: 'Segoe UI', sans-serif; background: linear-gradient(135deg, #667eea, #764ba2); color: var(--dark); min-height: 100vh; }
        .auth-container { min-height: 100vh; display: flex; align-items: center; justify-content: center; padding: 1rem; }
        .auth-box { background: white; border-radius: 20px; padding: 2rem; width: 100%; max-width: 400px; box-shadow: 0 25px 50px rgba(0,0,0,0.25); }
        .auth-logo { text-align: center; margin-bottom: 1.5rem; }
        .auth-logo-icon { font-size: 3em; }
        .auth-logo h1 { font-size: 1.4em; background: linear-gradient(135deg, var(--primary), var(--secondary)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
        .auth-tabs { display: flex; margin-bottom: 1.5rem; background: var(--gray); border-radius: 10px; padding: 4px; }
        .auth-tab { flex: 1; padding: 0.6rem; border: none; background: transparent; cursor: pointer; font-weight: 600; border-radius: 8px; color: #666; font-size: 0.9em; }
        .auth-tab.active { background: white; color: var(--primary); }
        .auth-form { display: none; }
        .auth-form.active { display: block; }
        .form-group { margin-bottom: 1rem; }
        .form-group label { display: block; margin-bottom: 0.3rem; font-weight: 600; font-size: 0.85em; }
        .form-group input, .form-group select { width: 100%; padding: 0.75rem; border: 2px solid var(--gray); border-radius: 8px; font-size: 1em; }
        .form-group input:focus { outline: none; border-color: var(--primary); }
        .color-row { display: flex; gap: 0.5rem; align-items: center; }
        .color-row input[type="color"] { width: 50px; height: 40px; border: none; border-radius: 6px; cursor: pointer; }
        .color-preview { flex: 1; height: 40px; border-radius: 6px; border: 2px solid var(--gray); }
        .btn-auth { width: 100%; padding: 0.9rem; border: none; border-radius: 10px; font-weight: 700; cursor: pointer; background: linear-gradient(135deg, var(--primary), var(--secondary)); color: white; font-size: 1em; }
        .btn-auth:disabled { opacity: 0.6; }
        .auth-msg { padding: 0.7rem; border-radius: 8px; margin-bottom: 1rem; font-size: 0.85em; display: none; }
        .auth-error { background: #FEE2E2; color: #DC2626; }
        .auth-success { background: #D1FAE5; color: #059669; }
        .forgot-link { text-align: center; margin-top: 1rem; }
        .forgot-link a { color: var(--primary); font-size: 0.85em; cursor: pointer; text-decoration: underline; }
        .app-container { display: none; background: linear-gradient(135deg, #F9FAFB, #F3E8FF); min-height: 100vh; }
        .app-container.active { display: block; }
        .navbar { background: linear-gradient(135deg, var(--primary), var(--secondary)); color: white; padding: 1rem; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 0.5rem; }
        .navbar-title { font-size: 1.2em; font-weight: 800; }
        .navbar-user { display: flex; align-items: center; gap: 0.5rem; }
        .user-badge { background: rgba(255,255,255,0.2); padding: 0.4rem 0.8rem; border-radius: 15px; font-size: 0.8em; }
        .btn-nav { background: rgba(255,255,255,0.2); border: 1px solid white; color: white; padding: 0.4rem 0.8rem; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 0.8em; }
        .btn-nav:hover { background: white; color: var(--primary); }
        .container { max-width: 1000px; margin: 0 auto; padding: 1.5rem 1rem; }
        .welcome { background: white; border-radius: 12px; padding: 1.2rem; margin-bottom: 1.5rem; box-shadow: 0 4px 15px rgba(0,0,0,0.08); }
        .planner-types { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 1.5rem; }
        .planner-card { background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 15px rgba(0,0,0,0.08); cursor: pointer; border-top: 4px solid; transition: transform 0.2s; }
        .planner-card:hover { transform: translateY(-3px); }
        .planner-header { color: white; padding: 1rem; text-align: center; }
        .planner-icon { font-size: 2em; }
        .planner-title { font-size: 0.95em; font-weight: 700; margin-top: 0.3rem; }
        .planner-body { padding: 1rem; }
        .btn-criar { width: 100%; padding: 0.6rem; background: linear-gradient(135deg, var(--primary), var(--secondary)); color: white; border: none; border-radius: 6px; font-weight: 700; cursor: pointer; font-size: 0.9em; }
        .meus-planners { background: white; border-radius: 12px; padding: 1.2rem; box-shadow: 0 4px 15px rgba(0,0,0,0.08); }
        .meus-planners h2 { margin-bottom: 1rem; font-size: 1.1em; }
        .planners-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 1rem; }
        .planner-item { color: white; border-radius: 10px; padding: 1rem; }
        .planner-item-nome { font-weight: 700; margin-bottom: 0.2rem; }
        .planner-item-info { font-size: 0.75em; opacity: 0.9; margin-bottom: 0.6rem; }
        .planner-item-acoes { display: flex; gap: 0.3rem; }
        .planner-item-acoes button { flex: 1; padding: 0.4rem; background: rgba(255,255,255,0.2); color: white; border: 1px solid white; border-radius: 4px; cursor: pointer; font-size: 0.7em; font-weight: 600; }
        .planner-item-acoes button:hover { background: white; color: #333; }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); overflow-y: auto; }
        .modal-content { background: white; margin: 5% auto; padding: 1.5rem; border-radius: 12px; width: 90%; max-width: 500px; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; }
        .modal-header h2 { font-size: 1.2em; }
        .close-modal { font-size: 1.5em; cursor: pointer; background: none; border: none; color: #999; }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 0.8rem; }
        .form-actions { display: flex; gap: 0.5rem; margin-top: 1rem; }
        .btn-primario, .btn-secundario { flex: 1; padding: 0.6rem; border: none; border-radius: 6px; font-weight: 700; cursor: pointer; font-size: 0.9em; }
        .btn-primario { background: linear-gradient(135deg, var(--primary), var(--secondary)); color: white; }
        .btn-secundario { background: var(--gray); color: var(--dark); }
        .contador { background: linear-gradient(135deg, var(--primary), var(--secondary)); color: white; padding: 0.8rem; border-radius: 8px; text-align: center; margin-bottom: 1rem; }
        .contador-numero { font-size: 1.5em; font-weight: 700; }
        .tarefa-item { background: var(--light); padding: 0.7rem; border-radius: 6px; margin-bottom: 0.5rem; display: flex; gap: 0.6rem; align-items: center; border-left: 3px solid var(--primary); }
        .tarefa-item.concluida { opacity: 0.5; }
        .tarefa-item.concluida .tarefa-titulo { text-decoration: line-through; }
        .tarefa-checkbox { width: 18px; height: 18px; cursor: pointer; }
        .tarefa-conteudo { flex: 1; }
        .tarefa-titulo { font-weight: 600; font-size: 0.9em; }
        .tarefa-meta { font-size: 0.7em; color: #666; }
        .btn-del { padding: 0.2rem 0.5rem; background: var(--danger); color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.75em; }
        .empty-msg { color: #999; text-align: center; padding: 1rem; font-size: 0.85em; }
        .loading { text-align: center; padding: 2rem; }
        .spinner { width: 40px; height: 40px; border: 4px solid var(--gray); border-top-color: var(--primary); border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 1rem; }
        @keyframes spin { to { transform: rotate(360deg); } }
        @media (max-width: 600px) { .form-row { grid-template-columns: 1fr; } }
    </style>
</head>
<body>
    <div class="loading" id="loadingScreen">
        <div class="spinner"></div>
        <p>Carregando...</p>
    </div>

    <div class="auth-container" id="authContainer" style="display:none;">
        <div class="auth-box">
            <div class="auth-logo">
                <div class="auth-logo-icon">‚ú®</div>
                <h1>Planner Premium ULTRA</h1>
                <p style="color:#666; font-size:0.85em; margin-top:0.3rem;">Sistema SaaS Profissional</p>
            </div>
            <div class="auth-tabs">
                <button class="auth-tab active" onclick="showTab('login')">Entrar</button>
                <button class="auth-tab" onclick="showTab('signup')">Criar Conta</button>
                <button class="auth-tab" onclick="showTab('recover')">Recuperar</button>
            </div>
            <div id="authError" class="auth-msg auth-error"></div>
            <div id="authSuccess" class="auth-msg auth-success"></div>

            <form id="loginForm" class="auth-form active" onsubmit="handleLogin(event)">
                <div class="form-group"><label>Email</label><input type="email" id="loginEmail" required></div>
                <div class="form-group"><label>Senha</label><input type="password" id="loginPassword" required></div>
                <button type="submit" class="btn-auth" id="loginBtn">Entrar</button>
            </form>

            <form id="signupForm" class="auth-form" onsubmit="handleSignup(event)">
                <div class="form-group"><label>Nome Completo</label><input type="text" id="signupName" required></div>
                <div class="form-group"><label>Email</label><input type="email" id="signupEmail" required></div>
                <div class="form-group"><label>Senha (m√≠n. 6)</label><input type="password" id="signupPassword" minlength="6" required></div>
                <div class="form-group"><label>Confirmar Senha</label><input type="password" id="signupConfirm" required></div>
                <button type="submit" class="btn-auth" id="signupBtn">Criar Conta</button>
            </form>

            <form id="recoverForm" class="auth-form" onsubmit="handleRecover(event)">
                <p style="font-size:0.85em; color:#666; margin-bottom:1rem;">Digite seu email cadastrado. Enviaremos uma nova senha.</p>
                <div class="form-group"><label>Email Cadastrado</label><input type="email" id="recoverEmail" required></div>
                <button type="submit" class="btn-auth" id="recoverBtn">Enviar Nova Senha</button>
            </form>
        </div>
    </div>

    <div class="app-container" id="appContainer">
        <div class="navbar">
            <div class="navbar-title">‚ú® Planner Premium</div>
            <div class="navbar-user">
                <span class="user-badge">üë§ <span id="userName">User</span></span>
                <button class="btn-nav" onclick="logout()">Sair</button>
            </div>
        </div>
        <div class="container">
            <div class="welcome">
                <h1 style="font-size:1.3em;">Ol√°, <span id="welcomeName">User</span>! üëã</h1>
                <p style="color:#666; font-size:0.85em;">Seus dados est√£o salvos na nuvem ‚òÅÔ∏è</p>
            </div>
            <h2 style="margin-bottom:0.8rem; font-size:1em;">Criar Novo Planner</h2>
            <div class="planner-types">
                <div class="planner-card" style="border-top-color:#10B981;" onclick="criarPlanner('todo')">
                    <div class="planner-header" style="background:linear-gradient(135deg,#10B981,#059669);"><div class="planner-icon">‚úÖ</div><div class="planner-title">To-Do</div></div>
                    <div class="planner-body"><button class="btn-criar">Criar</button></div>
                </div>
                <div class="planner-card" style="border-top-color:#3B82F6;" onclick="criarPlanner('projeto')">
                    <div class="planner-header" style="background:linear-gradient(135deg,#3B82F6,#1D4ED8);"><div class="planner-icon">üèóÔ∏è</div><div class="planner-title">Projetos</div></div>
                    <div class="planner-body"><button class="btn-criar">Criar</button></div>
                </div>
                <div class="planner-card" style="border-top-color:#F59E0B;" onclick="criarPlanner('habitos')">
                    <div class="planner-header" style="background:linear-gradient(135deg,#F59E0B,#D97706);"><div class="planner-icon">üî•</div><div class="planner-title">H√°bitos</div></div>
                    <div class="planner-body"><button class="btn-criar">Criar</button></div>
                </div>
                <div class="planner-card" style="border-top-color:#8B5CF6;" onclick="criarPlanner('financeiro')">
                    <div class="planner-header" style="background:linear-gradient(135deg,#8B5CF6,#6D28D9);"><div class="planner-icon">üí∞</div><div class="planner-title">Financeiro</div></div>
                    <div class="planner-body"><button class="btn-criar">Criar</button></div>
                </div>
            </div>
            <div class="meus-planners">
                <h2>üìã Meus Planners</h2>
                <div class="planners-grid" id="meusPlanners"><p class="empty-msg">Carregando...</p></div>
            </div>
        </div>
    </div>

    <div id="modalCriar" class="modal">
        <div class="modal-content">
            <div class="modal-header"><h2><span id="modalIcone"></span> <span id="modalTitulo">Novo</span></h2><button class="close-modal" onclick="fecharModal('modalCriar')">&times;</button></div>
            <div class="form-group"><label>Nome *</label><input type="text" id="inputNome"></div>
            <div class="form-group"><label>Cor</label><div class="color-row"><input type="color" id="inputCor" value="#6B46C1" oninput="document.getElementById('colorPrev').style.background=this.value"><div class="color-preview" id="colorPrev" style="background:#6B46C1"></div></div></div>
            <div class="form-row">
                <div class="form-group"><label>√çcone</label><input type="text" id="inputIcone" maxlength="2" value="‚ú®"></div>
                <div class="form-group"><label>Alarme</label><input type="time" id="inputAlarme" value="09:00"></div>
            </div>
            <div class="form-group"><label>Data In√≠cio</label><input type="date" id="inputData"></div>
            <div class="form-actions"><button class="btn-secundario" onclick="fecharModal('modalCriar')">Cancelar</button><button class="btn-primario" onclick="salvarPlanner()">Criar</button></div>
        </div>
    </div>

    <div id="modalVer" class="modal">
        <div class="modal-content">
            <div class="modal-header"><h2><span id="verIcone"></span> <span id="verNome">Planner</span></h2><button class="close-modal" onclick="fecharModal('modalVer')">&times;</button></div>
            <div class="contador"><div class="contador-numero" id="contadorTarefas">0</div><div style="font-size:0.8em;">Tarefas</div></div>
            <div id="alarmeBox" style="background:#FEF3C7; padding:0.6rem; border-radius:6px; margin-bottom:1rem; font-size:0.8em; display:none;">üîî Alarme: <b id="alarmeHora"></b></div>
            <div class="form-group"><label>Nova Tarefa</label><input type="text" id="inputTarefa" placeholder="T√≠tulo"></div>
            <div class="form-row">
                <div class="form-group"><label>Prioridade</label><select id="inputPrio"><option value="baixa">üü¢ Baixa</option><option value="media" selected>üü° M√©dia</option><option value="alta">üî¥ Alta</option></select></div>
                <div class="form-group"><label>Data</label><input type="date" id="inputDataT"></div>
            </div>
            <div class="form-group"><label>Hora Lembrete</label><input type="time" id="inputHoraT"></div>
            <button class="btn-primario" style="width:100%; margin-bottom:1rem;" onclick="addTarefa()">+ Adicionar</button>
            <div id="listaTarefas"></div>
            <div class="form-actions" style="margin-top:1rem;">
                <button class="btn-secundario" onclick="shareWpp()">üì±</button>
                <button class="btn-secundario" onclick="shareEmail()">üìß</button>
                <button class="btn-primario" onclick="downloadTxt()">üì•</button>
            </div>
            <button class="btn-secundario" style="width:100%; margin-top:0.5rem;" onclick="fecharModal('modalVer')">Fechar</button>
        </div>
    </div>

    <script>
        let currentUser = null, planners = [], plannerAberto = null, tipoAtual = '';
        const tipos = {
            'todo': { nome: 'To-Do', icone: '‚úÖ', cor: '#10B981' },
            'projeto': { nome: 'Projeto', icone: 'üèóÔ∏è', cor: '#3B82F6' },
            'habitos': { nome: 'H√°bitos', icone: 'üî•', cor: '#F59E0B' },
            'financeiro': { nome: 'Financeiro', icone: 'üí∞', cor: '#8B5CF6' }
        };

        // Storage helpers
        async function getStorage(key) {
            try { const r = await window.storage.get(key, true); return r ? JSON.parse(r.value) : null; } 
            catch { return null; }
        }
        async function setStorage(key, val) {
            try { await window.storage.set(key, JSON.stringify(val), true); return true; } 
            catch { return false; }
        }

        // Init
        async function init() {
            document.getElementById('inputData').value = new Date().toISOString().split('T')[0];
            document.getElementById('loadingScreen').style.display = 'none';
            document.getElementById('authContainer').style.display = 'flex';
        }
        init();

        // Auth UI
        function showTab(t) {
            document.querySelectorAll('.auth-tab').forEach((el,i) => el.classList.toggle('active', (t==='login'&&i===0)||(t==='signup'&&i===1)||(t==='recover'&&i===2)));
            document.getElementById('loginForm').classList.toggle('active', t==='login');
            document.getElementById('signupForm').classList.toggle('active', t==='signup');
            document.getElementById('recoverForm').classList.toggle('active', t==='recover');
            hideMsg();
        }
        function showError(m) { document.getElementById('authError').textContent=m; document.getElementById('authError').style.display='block'; document.getElementById('authSuccess').style.display='none'; }
        function showSuccess(m) { document.getElementById('authSuccess').textContent=m; document.getElementById('authSuccess').style.display='block'; document.getElementById('authError').style.display='none'; }
        function hideMsg() { document.getElementById('authError').style.display='none'; document.getElementById('authSuccess').style.display='none'; }

        // Signup
        async function handleSignup(e) {
            e.preventDefault();
            const name = document.getElementById('signupName').value.trim();
            const email = document.getElementById('signupEmail').value.trim().toLowerCase();
            const pass = document.getElementById('signupPassword').value;
            const conf = document.getElementById('signupConfirm').value;
            if (pass !== conf) { showError('Senhas n√£o coincidem!'); return; }
            if (pass.length < 6) { showError('Senha m√≠nimo 6 caracteres!'); return; }
            
            document.getElementById('signupBtn').disabled = true;
            document.getElementById('signupBtn').textContent = 'Criando...';
            
            const existing = await getStorage('user_' + email);
            if (existing) { showError('Email j√° cadastrado!'); document.getElementById('signupBtn').disabled=false; document.getElementById('signupBtn').textContent='Criar Conta'; return; }
            
            const user = { name, email, password: pass, created: new Date().toISOString() };
            await setStorage('user_' + email, user);
            await setStorage('planners_' + email, []);
            
            showSuccess('Conta criada! Entrando...');
            setTimeout(() => loginUser(user), 1000);
        }

        // Login
        async function handleLogin(e) {
            e.preventDefault();
            const email = document.getElementById('loginEmail').value.trim().toLowerCase();
            const pass = document.getElementById('loginPassword').value;
            
            document.getElementById('loginBtn').disabled = true;
            document.getElementById('loginBtn').textContent = 'Entrando...';
            
            const user = await getStorage('user_' + email);
            if (!user) { showError('Email n√£o encontrado! Crie uma conta.'); document.getElementById('loginBtn').disabled=false; document.getElementById('loginBtn').textContent='Entrar'; return; }
            if (user.password !== pass) { showError('Senha incorreta!'); document.getElementById('loginBtn').disabled=false; document.getElementById('loginBtn').textContent='Entrar'; return; }
            
            loginUser(user);
        }

        // Recover
        async function handleRecover(e) {
            e.preventDefault();
            const email = document.getElementById('recoverEmail').value.trim().toLowerCase();
            
            document.getElementById('recoverBtn').disabled = true;
            document.getElementById('recoverBtn').textContent = 'Enviando...';
            
            const user = await getStorage('user_' + email);
            if (!user) { 
                showError('Email n√£o encontrado!'); 
                document.getElementById('recoverBtn').disabled=false; 
                document.getElementById('recoverBtn').textContent='Enviar Nova Senha'; 
                return; 
            }
            
            // Gera nova senha
            const newPass = Math.random().toString(36).slice(-8);
            user.password = newPass;
            await setStorage('user_' + email, user);
            
            // Abre email com a nova senha
            const subject = 'Sua nova senha - Planner Premium ULTRA';
            const body = `Ol√° ${user.name}!\n\nSua nova senha √©: ${newPass}\n\nAcesse o Planner e fa√ßa login com esta senha.\n\nEquipe Planner Premium ULTRA`;
            window.location.href = `mailto:${email}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
            
            showSuccess(`Nova senha gerada! Abrindo email para: ${email}`);
            document.getElementById('recoverBtn').disabled=false; 
            document.getElementById('recoverBtn').textContent='Enviar Nova Senha';
        }

        async function loginUser(user) {
            currentUser = user;
            planners = await getStorage('planners_' + user.email) || [];
            document.getElementById('authContainer').style.display = 'none';
            document.getElementById('appContainer').classList.add('active');
            document.getElementById('userName').textContent = user.name.split(' ')[0];
            document.getElementById('welcomeName').textContent = user.name.split(' ')[0];
            renderPlanners();
            if ('Notification' in window && Notification.permission === 'default') Notification.requestPermission();
        }

        function logout() {
            currentUser = null; planners = [];
            document.getElementById('appContainer').classList.remove('active');
            document.getElementById('authContainer').style.display = 'flex';
            document.getElementById('loginBtn').disabled=false; document.getElementById('loginBtn').textContent='Entrar';
            document.getElementById('signupBtn').disabled=false; document.getElementById('signupBtn').textContent='Criar Conta';
            showTab('login'); hideMsg();
        }

        async function savePlanners() { await setStorage('planners_' + currentUser.email, planners); }

        function renderPlanners() {
            const c = document.getElementById('meusPlanners');
            if (!planners.length) { c.innerHTML = '<p class="empty-msg">Nenhum planner. Crie o primeiro!</p>'; return; }
            c.innerHTML = planners.map(p => `
                <div class="planner-item" style="background:linear-gradient(135deg,${p.cor},${p.cor}dd);">
                    <div class="planner-item-nome">${p.icone} ${p.nome}</div>
                    <div class="planner-item-info">${p.tarefas.length} tarefas ${p.alarme?'üîî'+p.alarme:''}</div>
                    <div class="planner-item-acoes">
                        <button onclick="abrirPlanner(${p.id})">Abrir</button>
                        <button onclick="deletarPlanner(${p.id})">Deletar</button>
                    </div>
                </div>`).join('');
        }

        function criarPlanner(tipo) {
            tipoAtual = tipo;
            const t = tipos[tipo];
            document.getElementById('modalIcone').textContent = t.icone;
            document.getElementById('modalTitulo').textContent = 'Novo ' + t.nome;
            document.getElementById('inputNome').value = '';
            document.getElementById('inputCor').value = t.cor;
            document.getElementById('colorPrev').style.background = t.cor;
            document.getElementById('inputIcone').value = t.icone;
            document.getElementById('modalCriar').style.display = 'block';
        }

        async function salvarPlanner() {
            const nome = document.getElementById('inputNome').value.trim();
            if (!nome) { alert('Digite um nome!'); return; }
            planners.push({
                id: Date.now(),
                tipo: tipoAtual,
                nome: nome,
                icone: document.getElementById('inputIcone').value || 'üìã',
                cor: document.getElementById('inputCor').value,
                alarme: document.getElementById('inputAlarme').value,
                data: document.getElementById('inputData').value,
                tarefas: []
            });
            await savePlanners();
            fecharModal('modalCriar');
            renderPlanners();
        }

        function abrirPlanner(id) {
            const p = planners.find(x => x.id === id);
            if (!p) return;
            plannerAberto = id;
            document.getElementById('verIcone').textContent = p.icone;
            document.getElementById('verNome').textContent = p.nome;
            document.getElementById('contadorTarefas').textContent = p.tarefas.length;
            if (p.alarme) {
                document.getElementById('alarmeBox').style.display = 'block';
                document.getElementById('alarmeHora').textContent = p.alarme;
            } else {
                document.getElementById('alarmeBox').style.display = 'none';
            }
            renderTarefas();
            document.getElementById('modalVer').style.display = 'block';
        }

        function renderTarefas() {
            const p = planners.find(x => x.id === plannerAberto);
            const c = document.getElementById('listaTarefas');
            if (!p.tarefas.length) { c.innerHTML = '<p class="empty-msg">Nenhuma tarefa.</p>'; return; }
            c.innerHTML = p.tarefas.map((t, i) => `
                <div class="tarefa-item ${t.done ? 'concluida' : ''}" style="border-left-color:${t.prio==='alta'?'#EF4444':t.prio==='media'?'#F59E0B':'#10B981'};">
                    <input type="checkbox" class="tarefa-checkbox" ${t.done ? 'checked' : ''} onchange="toggleT(${i})">
                    <div class="tarefa-conteudo">
                        <div class="tarefa-titulo">${t.titulo}</div>
                        <div class="tarefa-meta">${t.data ? 'üìÖ'+t.data : ''} ${t.hora ? '‚è∞'+t.hora : ''}</div>
                    </div>
                    <button class="btn-del" onclick="delT(${i})">‚úï</button>
                </div>`).join('');
        }

        async function addTarefa() {
            const titulo = document.getElementById('inputTarefa').value.trim();
            if (!titulo) { alert('Digite o t√≠tulo!'); return; }
            const p = planners.find(x => x.id === plannerAberto);
            p.tarefas.push({
                titulo: titulo,
                prio: document.getElementById('inputPrio').value,
                data: document.getElementById('inputDataT').value,
                hora: document.getElementById('inputHoraT').value,
                done: false
            });
            await savePlanners();
            document.getElementById('inputTarefa').value = '';
            document.getElementById('inputDataT').value = '';
            document.getElementById('inputHoraT').value = '';
            document.getElementById('contadorTarefas').textContent = p.tarefas.length;
            renderTarefas();
        }

        async function toggleT(i) {
            const p = planners.find(x => x.id === plannerAberto);
            p.tarefas[i].done = !p.tarefas[i].done;
            await savePlanners();
            renderTarefas();
        }

        async function delT(i) {
            const p = planners.find(x => x.id === plannerAberto);
            p.tarefas.splice(i, 1);
            await savePlanners();
            document.getElementById('contadorTarefas').textContent = p.tarefas.length;
            renderTarefas();
        }

        async function deletarPlanner(id) {
            if (!confirm('Deletar?')) return;
            planners = planners.filter(x => x.id !== id);
            await savePlanners();
            renderPlanners();
        }

        function fecharModal(id) { document.getElementById(id).style.display = 'none'; }

        function shareWpp() {
            const p = planners.find(x => x.id === plannerAberto);
            let m = `‚ú® *${p.icone} ${p.nome}*\n\nüìã Tarefas:\n`;
            p.tarefas.forEach(t => m += `${t.done?'‚úÖ':'‚¨ú'} ${t.titulo}${t.data?' ('+t.data+')':''}\n`);
            if (p.alarme) m += `\nüîî Alarme: ${p.alarme}`;
            window.open('https://wa.me/?text=' + encodeURIComponent(m), '_blank');
        }

        function shareEmail() {
            const p = planners.find(x => x.id === plannerAberto);
            let b = `${p.icone} ${p.nome}\n\nTAREFAS:\n`;
            p.tarefas.forEach((t,i) => b += `${i+1}. [${t.done?'X':' '}] ${t.titulo}${t.data?' - '+t.data:''}${t.hora?' √†s '+t.hora:''}\n`);
            if (p.alarme) b += `\nAlarme: ${p.alarme}`;
            window.location.href = `mailto:?subject=${encodeURIComponent(p.nome+' - Planner')}&body=${encodeURIComponent(b)}`;
        }

        function downloadTxt() {
            const p = planners.find(x => x.id === plannerAberto);
            let t = `‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n   ${p.icone} ${p.nome.toUpperCase()}\n‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\n`;
            if (p.alarme) t += `üîî Alarme: ${p.alarme}\n`;
            t += `\nTAREFAS (${p.tarefas.length}):\n‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n`;
            p.tarefas.forEach((x,i) => t += `${x.done?'‚úÖ':'‚¨ú'} ${x.titulo}${x.data?' | '+x.data:''}${x.hora?' | '+x.hora:''}\n`);
            t += `\n‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n   Planner Premium ULTRA ‚ú®\n‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê`;
            const blob = new Blob([t], {type:'text/plain;charset=utf-8'});
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = p.nome.replace(/\s/g,'_') + '.txt';
            a.click();
        }

        window.onclick = e => { if (e.target.classList.contains('modal')) e.target.style.display = 'none'; };
    </script>
</body>
</html>

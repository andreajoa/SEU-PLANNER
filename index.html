<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‚ú® Planner Premium ULTRA</title>
    
    <!-- PWA Support -->
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#6B46C1">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="/icon-192.png">
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://js.stripe.com/v3/"></script>
    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-messaging-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bcryptjs/2.4.3/bcrypt.min.js"></script>
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root { 
            --primary: #6B46C1; --secondary: #EC4899; --success: #10B981; 
            --danger: #EF4444; --warning: #F59E0B; --dark: #1F2937; 
            --light: #F9FAFB; --gray: #E5E7EB; 
        }
        body { font-family: 'Segoe UI', sans-serif; background: linear-gradient(135deg, #667eea, #764ba2); color: var(--dark); min-height: 100vh; }
        
        @keyframes levelUp {
            0% { transform: scale(0.5) rotate(-10deg); opacity: 0; }
            50% { transform: scale(1.2) rotate(5deg); opacity: 1; }
            100% { transform: scale(1) rotate(0deg); opacity: 1; }
        }
        
        @keyframes confetti {
            0% { transform: translateY(0) rotate(0deg); opacity: 1; }
            100% { transform: translateY(100vh) rotate(720deg); opacity: 0; }
        }
        
        .confetti { position: fixed; width: 10px; height: 10px; z-index: 10000; pointer-events: none; }
        
        .level-up-modal {
            display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            z-index: 9999; background: white; padding: 3rem; border-radius: 20px;
            box-shadow: 0 25px 50px rgba(0,0,0,0.3); text-align: center; animation: levelUp 0.6s ease;
        }
        
        .level-up-modal.active { display: block; }
        .level-up-icon { font-size: 5em; margin-bottom: 1rem; }
        .level-up-title { font-size: 2em; font-weight: 800; background: linear-gradient(135deg, var(--primary), var(--secondary)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        
        .auth-container { min-height: 100vh; display: flex; align-items: center; justify-content: center; padding: 1rem; }
        .auth-box { background: white; border-radius: 20px; padding: 2rem; width: 100%; max-width: 400px; box-shadow: 0 25px 50px rgba(0,0,0,0.25); }
        .auth-logo { text-align: center; margin-bottom: 1.5rem; }
        .auth-logo-icon { font-size: 3em; }
        .auth-logo h1 { font-size: 1.4em; background: linear-gradient(135deg, var(--primary), var(--secondary)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
        .trial-badge { background: linear-gradient(135deg, #10B981, #059669); color: white; padding: 0.5rem 1rem; border-radius: 20px; font-size: 0.85em; font-weight: 700; margin: 0.8rem 0; display: inline-block; }
        .auth-tabs { display: flex; margin-bottom: 1.5rem; background: var(--gray); border-radius: 10px; padding: 4px; }
        .auth-tab { flex: 1; padding: 0.6rem; border: none; background: transparent; cursor: pointer; font-weight: 600; border-radius: 8px; color: #666; font-size: 0.9em; }
        .auth-tab.active { background: white; color: var(--primary); }
        .auth-form { display: none; }
        .auth-form.active { display: block; }
        .form-group { margin-bottom: 1rem; }
        .form-group label { display: block; margin-bottom: 0.3rem; font-weight: 600; font-size: 0.85em; }
        .form-group input, .form-group select { width: 100%; padding: 0.75rem; border: 2px solid var(--gray); border-radius: 8px; font-size: 1em; }
        .form-group input:focus { outline: none; border-color: var(--primary); }
        .btn-auth { width: 100%; padding: 0.9rem; border: none; border-radius: 10px; font-weight: 700; cursor: pointer; background: linear-gradient(135deg, var(--primary), var(--secondary)); color: white; font-size: 1em; }
        .btn-auth:disabled { opacity: 0.6; cursor: not-allowed; }
        .auth-msg { padding: 0.7rem; border-radius: 8px; margin-bottom: 1rem; font-size: 0.85em; display: none; }
        .auth-error { background: #FEE2E2; color: #DC2626; }
        .auth-success { background: #D1FAE5; color: #059669; }
        
        .trial-banner { padding: 1rem; text-align: center; font-weight: 700; font-size: 0.9em; }
        .trial-banner.warning { background: linear-gradient(135deg, #F59E0B, #D97706); color: white; }
        .trial-banner.danger { background: linear-gradient(135deg, #EF4444, #DC2626); color: white; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.8; } }
        
        .paywall-overlay { display: none; position: fixed; z-index: 9999; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); align-items: center; justify-content: center; padding: 1rem; }
        .paywall-overlay.active { display: flex; }
        .paywall-box { background: white; border-radius: 20px; padding: 2.5rem; max-width: 500px; width: 100%; text-align: center; }
        .paywall-icon { font-size: 4em; margin-bottom: 1rem; }
        .paywall-title { font-size: 2em; font-weight: 800; margin-bottom: 0.5rem; background: linear-gradient(135deg, var(--primary), var(--secondary)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .price-box { background: linear-gradient(135deg, #F3E8FF, #E9D5FF); border-radius: 15px; padding: 1.5rem; margin-bottom: 1.5rem; }
        .price-amount { font-size: 3em; font-weight: 800; color: var(--primary); }
        .btn-subscribe { width: 100%; padding: 1.2rem; border: none; border-radius: 12px; font-weight: 800; font-size: 1.1em; cursor: pointer; background: linear-gradient(135deg, var(--primary), var(--secondary)); color: white; }
        
        .app-container { display: none; background: linear-gradient(135deg, #F9FAFB, #F3E8FF); min-height: 100vh; }
        .app-container.active { display: block; }
        .navbar { background: linear-gradient(135deg, var(--primary), var(--secondary)); color: white; padding: 1rem; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 0.5rem; }
        .navbar-title { font-size: 1.2em; font-weight: 800; }
        .navbar-user { display: flex; align-items: center; gap: 0.5rem; flex-wrap: wrap; }
        .user-badge { background: rgba(255,255,255,0.2); padding: 0.4rem 0.8rem; border-radius: 15px; font-size: 0.75em; }
        .level-badge { background: linear-gradient(135deg, #F59E0B, #D97706); padding: 0.4rem 0.8rem; border-radius: 15px; font-size: 0.75em; font-weight: 700; cursor: pointer; }
        .streak-badge { background: linear-gradient(135deg, #EF4444, #DC2626); padding: 0.4rem 0.8rem; border-radius: 15px; font-size: 0.75em; font-weight: 700; }
        .btn-nav { background: rgba(255,255,255,0.2); border: 1px solid white; color: white; padding: 0.4rem 0.8rem; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 0.8em; }
        .btn-nav:hover { background: white; color: var(--primary); }
        
        .tab-menu { display: flex; gap: 0.5rem; background: white; padding: 0.5rem; border-radius: 10px; margin: 1rem auto; max-width: 600px; }
        .tab-btn { flex: 1; padding: 0.7rem; border: none; background: transparent; cursor: pointer; font-weight: 600; border-radius: 6px; font-size: 0.9em; }
        .tab-btn.active { background: linear-gradient(135deg, var(--primary), var(--secondary)); color: white; }
        
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        .container { max-width: 1200px; margin: 0 auto; padding: 1.5rem 1rem; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 1.5rem; }
        .stat-card { background: white; border-radius: 12px; padding: 1.5rem; box-shadow: 0 4px 15px rgba(0,0,0,0.08); text-align: center; }
        .stat-icon { font-size: 2.5em; margin-bottom: 0.5rem; }
        .stat-value { font-size: 2em; font-weight: 800; color: var(--primary); }
        .stat-label { color: #666; font-size: 0.85em; margin-top: 0.3rem; }
        
        .xp-bar { background: var(--gray); border-radius: 20px; height: 30px; overflow: hidden; margin: 1rem 0; position: relative; }
        .xp-fill { background: linear-gradient(135deg, #10B981, #059669); height: 100%; transition: width 0.5s ease; display: flex; align-items: center; justify-content: center; color: white; font-weight: 700; font-size: 0.85em; }
        
        .achievements-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 1rem; }
        .achievement { background: white; border-radius: 10px; padding: 1rem; text-align: center; box-shadow: 0 4px 15px rgba(0,0,0,0.08); }
        .achievement.locked { opacity: 0.3; }
        .achievement-icon { font-size: 2.5em; }
        .achievement-name { font-size: 0.75em; font-weight: 600; margin-top: 0.3rem; }
        
        .chart-container { background: white; border-radius: 12px; padding: 1.5rem; box-shadow: 0 4px 15px rgba(0,0,0,0.08); margin-bottom: 1.5rem; }
        .chart-title { font-size: 1.1em; font-weight: 700; margin-bottom: 1rem; }
        
        .planner-types { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 1.5rem; }
        .planner-card { background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 15px rgba(0,0,0,0.08); cursor: pointer; border-top: 4px solid; transition: transform 0.2s; }
        .planner-card:hover { transform: translateY(-3px); }
        .planner-header { color: white; padding: 1rem; text-align: center; }
        .planner-icon { font-size: 2em; }
        .planner-title { font-size: 0.95em; font-weight: 700; margin-top: 0.3rem; }
        .planner-body { padding: 1rem; }
        .btn-criar { width: 100%; padding: 0.6rem; background: linear-gradient(135deg, var(--primary), var(--secondary)); color: white; border: none; border-radius: 6px; font-weight: 700; cursor: pointer; font-size: 0.9em; }
        
        .planners-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 1rem; }
        .planner-item { color: white; border-radius: 10px; padding: 1rem; }
        .planner-item-nome { font-weight: 700; margin-bottom: 0.2rem; }
        .planner-item-info { font-size: 0.75em; opacity: 0.9; margin-bottom: 0.6rem; }
        .planner-item-acoes { display: flex; gap: 0.3rem; }
        .planner-item-acoes button { flex: 1; padding: 0.4rem; background: rgba(255,255,255,0.2); color: white; border: 1px solid white; border-radius: 4px; cursor: pointer; font-size: 0.7em; font-weight: 600; }
        
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); overflow-y: auto; }
        .modal-content { background: white; margin: 2% auto; padding: 1.5rem; border-radius: 12px; width: 90%; max-width: 600px; max-height: 90vh; overflow-y: auto; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; }
        .close-modal { font-size: 1.5em; cursor: pointer; background: none; border: none; color: #999; }
        
        .tarefa-item { background: var(--light); padding: 0.7rem; border-radius: 6px; margin-bottom: 0.5rem; display: flex; gap: 0.6rem; align-items: center; border-left: 3px solid var(--primary); }
        .tarefa-checkbox { width: 18px; height: 18px; cursor: pointer; }
        .tarefa-conteudo { flex: 1; }
        .tarefa-titulo { font-weight: 600; font-size: 0.9em; }
        .btn-del { padding: 0.2rem 0.5rem; background: var(--danger); color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.75em; }
        
        .btn-primario { padding: 0.8rem; background: linear-gradient(135deg, var(--primary), var(--secondary)); color: white; border: none; border-radius: 8px; font-weight: 700; cursor: pointer; }
        .btn-secundario { padding: 0.8rem; background: var(--gray); color: var(--dark); border: none; border-radius: 8px; font-weight: 700; cursor: pointer; }
        
        .loading { text-align: center; padding: 2rem; }
        .spinner { width: 40px; height: 40px; border: 4px solid var(--gray); border-top-color: var(--primary); border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 1rem; }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        .install-banner { background: linear-gradient(135deg, #10B981, #059669); color: white; padding: 1rem; text-align: center; font-weight: 700; display: none; }
        .install-banner button { background: white; color: #059669; border: none; padding: 0.5rem 1rem; border-radius: 6px; font-weight: 700; cursor: pointer; margin-left: 1rem; }
    </style>
</head>
<body>
    <div class="loading" id="loadingScreen">
        <div class="spinner"></div>
        <p>Inicializando sistemas seguros...</p>
    </div>

    <div id="installBanner" class="install-banner">
        üì± Instale o app na tela inicial!
        <button onclick="installPWA()">Instalar</button>
    </div>

    <div class="auth-container" id="authContainer" style="display:none;">
        <div class="auth-box">
            <div class="auth-logo">
                <div class="auth-logo-icon">‚ú®</div>
                <h1>Planner Premium ULTRA</h1>
                <div class="trial-badge">üéÅ 7 dias gr√°tis ‚Ä¢ R$ 19,99/m√™s</div>
            </div>
            <div class="auth-tabs">
                <button class="auth-tab active" onclick="showTab('login')">Entrar</button>
                <button class="auth-tab" onclick="showTab('signup')">Criar Conta</button>
            </div>
            <div id="authError" class="auth-msg auth-error"></div>
            <div id="authSuccess" class="auth-msg auth-success"></div>

            <form id="loginForm" class="auth-form active" onsubmit="handleLogin(event)">
                <div class="form-group"><label>Email</label><input type="email" id="loginEmail" required autocomplete="email"></div>
                <div class="form-group"><label>Senha</label><input type="password" id="loginPassword" required autocomplete="current-password"></div>
                <button type="submit" class="btn-auth" id="loginBtn">Entrar</button>
            </form>

            <form id="signupForm" class="auth-form" onsubmit="handleSignup(event)">
                <div class="form-group"><label>Nome Completo</label><input type="text" id="signupName" required autocomplete="name"></div>
                <div class="form-group"><label>Email</label><input type="email" id="signupEmail" required autocomplete="email"></div>
                <div class="form-group"><label>Senha (m√≠n. 6)</label><input type="password" id="signupPassword" minlength="6" required autocomplete="new-password"></div>
                <button type="submit" class="btn-auth" id="signupBtn">üéÅ Come√ßar Trial Gr√°tis</button>
            </form>
        </div>
    </div>

    <div class="paywall-overlay" id="paywallOverlay">
        <div class="paywall-box">
            <div class="paywall-icon">üîí</div>
            <h1 class="paywall-title">Trial Expirado</h1>
            <p style="color:#666; margin-bottom:2rem;">Assine agora para continuar!</p>
            <div class="price-box">
                <div class="price-amount">R$ 19,99</div>
                <div style="color:#666; font-size:0.9em;">por m√™s</div>
            </div>
            <button class="btn-subscribe" onclick="redirectToStripe()">üí≥ Assinar Agora</button>
        </div>
    </div>

    <div class="level-up-modal" id="levelUpModal">
        <div class="level-up-icon">üéâ</div>
        <h2 class="level-up-title">Level Up!</h2>
        <p style="font-size:1.5em; margin:1rem 0;">N√≠vel <span id="newLevel">2</span></p>
        <button class="btn-primario" onclick="closeLevelUp()">Continuar</button>
    </div>

    <div id="trialBanner" class="trial-banner" style="display:none;"></div>

    <div class="app-container" id="appContainer">
        <div class="navbar">
            <div class="navbar-title">‚ú® Planner Premium</div>
            <div class="navbar-user">
                <span class="level-badge" onclick="openTab('stats')" id="levelBadge">‚≠ê N√≠vel 1</span>
                <span class="streak-badge" id="streakBadge">üî• 0 dias</span>
                <span class="user-badge">üë§ <span id="userName">User</span></span>
                <button class="btn-nav" onclick="requestNotificationPermission()">üîî Ativar</button>
                <button class="btn-nav" onclick="syncToCalendar()">üìÖ Calendar</button>
                <button class="btn-nav" onclick="logout()">Sair</button>
            </div>
        </div>

        <div class="container">
            <div class="tab-menu">
                <button class="tab-btn active" onclick="openTab('planners')">üìã Planners</button>
                <button class="tab-btn" onclick="openTab('stats')">üìä Estat√≠sticas</button>
                <button class="tab-btn" onclick="openTab('achievements')">üèÜ Conquistas</button>
            </div>

            <div id="plannersTab" class="tab-content active">
                <h2 style="margin-bottom:0.8rem;">Criar Novo Planner</h2>
                <div class="planner-types">
                    <div class="planner-card" style="border-top-color:#10B981;" onclick="criarPlanner('todo')">
                        <div class="planner-header" style="background:linear-gradient(135deg,#10B981,#059669);"><div class="planner-icon">‚úÖ</div><div class="planner-title">To-Do</div></div>
                        <div class="planner-body"><button class="btn-criar">Criar</button></div>
                    </div>
                    <div class="planner-card" style="border-top-color:#3B82F6;" onclick="criarPlanner('projeto')">
                        <div class="planner-header" style="background:linear-gradient(135deg,#3B82F6,#1D4ED8);"><div class="planner-icon">üèóÔ∏è</div><div class="planner-title">Projetos</div></div>
                        <div class="planner-body"><button class="btn-criar">Criar</button></div>
                    </div>
                    <div class="planner-card" style="border-top-color:#F59E0B;" onclick="criarPlanner('habitos')">
                        <div class="planner-header" style="background:linear-gradient(135deg,#F59E0B,#D97706);"><div class="planner-icon">üî•</div><div class="planner-title">H√°bitos</div></div>
                        <div class="planner-body"><button class="btn-criar">Criar</button></div>
                    </div>
                    <div class="planner-card" style="border-top-color:#8B5CF6;" onclick="criarPlanner('financeiro')">
                        <div class="planner-header" style="background:linear-gradient(135deg,#8B5CF6,#6D28D9);"><div class="planner-icon">üí∞</div><div class="planner-title">Financeiro</div></div>
                        <div class="planner-body"><button class="btn-criar">Criar</button></div>
                    </div>
                </div>
                <div style="background:white; border-radius:12px; padding:1.5rem; box-shadow: 0 4px 15px rgba(0,0,0,0.08);">
                    <h2 style="margin-bottom:1rem;">üìã Meus Planners</h2>
                    <div class="planners-grid" id="meusPlanners"></div>
                </div>
            </div>

            <div id="statsTab" class="tab-content">
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon">‚≠ê</div>
                        <div class="stat-value" id="statLevel">1</div>
                        <div class="stat-label">N√≠vel</div>
                        <div class="xp-bar">
                            <div class="xp-fill" id="xpBar" style="width:0%;">0/100 XP</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">üî•</div>
                        <div class="stat-value" id="statStreak">0</div>
                        <div class="stat-label">Dias de Streak</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">‚úÖ</div>
                        <div class="stat-value" id="statCompleted">0</div>
                        <div class="stat-label">Tarefas Conclu√≠das</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">üìà</div>
                        <div class="stat-value" id="statRate">0%</div>
                        <div class="stat-label">Taxa de Conclus√£o</div>
                    </div>
                </div>
                
                <div class="chart-container">
                    <h3 class="chart-title">üìä Produtividade Semanal</h3>
                    <canvas id="weeklyChart" height="80"></canvas>
                </div>
                
                <div class="chart-container">
                    <h3 class="chart-title">üéØ Tarefas por Prioridade</h3>
                    <canvas id="priorityChart" height="80"></canvas>
                </div>
            </div>

            <div id="achievementsTab" class="tab-content">
                <h2 style="margin-bottom:1rem;">üèÜ Conquistas Desbloqueadas</h2>
                <div class="achievements-grid" id="achievementsList"></div>
            </div>
        </div>
    </div>

    <div id="modalCriar" class="modal">
        <div class="modal-content">
            <div class="modal-header"><h2><span id="modalIcone"></span> <span id="modalTitulo">Novo</span></h2><button class="close-modal" onclick="fecharModal('modalCriar')">&times;</button></div>
            <div class="form-group"><label>Nome *</label><input type="text" id="inputNome"></div>
            <div class="form-group"><label>Data de In√≠cio</label><input type="date" id="inputData"></div>
            <div style="display:flex; gap:0.5rem;">
                <button class="btn-secundario" style="flex:1;" onclick="fecharModal('modalCriar')">Cancelar</button>
                <button class="btn-primario" style="flex:1;" onclick="salvarPlanner()">Criar</button>
            </div>
        </div>
    </div>

    <div id="modalVer" class="modal">
        <div class="modal-content">
            <div class="modal-header"><h2><span id="verIcone"></span> <span id="verNome">Planner</span></h2><button class="close-modal" onclick="fecharModal('modalVer')">&times;</button></div>
            <div class="form-group"><label>Nova Tarefa</label><input type="text" id="inputTarefa"></div>
            <div style="display:flex; gap:0.5rem; margin-bottom:1rem;">
                <select id="inputPrio" style="flex:1; padding:0.7rem; border:2px solid #E5E7EB; border-radius:6px;">
                    <option value="baixa">üü¢ Baixa</option>
                    <option value="media">üü° M√©dia</option>
                    <option value="alta">üî¥ Alta</option>
                </select>
                <input type="date" id="inputDataT" style="flex:1; padding:0.7rem; border:2px solid #E5E7EB; border-radius:6px;">
            </div>
            <button class="btn-primario" style="width:100%; margin-bottom:1rem;" onclick="addTarefa()">+ Adicionar</button>
            <div id="listaTarefas"></div>
        </div>

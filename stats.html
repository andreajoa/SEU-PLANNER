<!DOCTYPE html>
<html class="light" lang="pt-BR">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>Planner Premium ULTRA - Estatísticas</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet"/>
    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#6c47c2",
                        "background-light": "#f7f6f8",
                        "background-dark": "#17141e",
                        "card-light": "#ffffff",
                        "card-dark": "#23202e",
                        "text-primary-light": "#131018",
                        "text-primary-dark": "#ffffff",
                        "text-secondary-light": "#6a5c8a",
                        "text-secondary-dark": "#a098b5",
                    },
                    fontFamily: {
                        "display": ["Plus Jakarta Sans", "sans-serif"]
                    },
                    borderRadius: { "DEFAULT": "0.5rem", "lg": "1rem", "xl": "1.5rem", "2xl": "1.75rem", "full": "9999px" },
                },
            },
        }
    </script>
    <style>
        /* Custom scrollbar hiding for clean mobile look */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
    </style>
</head>
<body class="bg-background-light dark:bg-background-dark font-display min-h-screen flex flex-col antialiased transition-colors duration-300">
    <!-- Header -->
    <header class="sticky top-0 z-50 flex items-center justify-between px-6 py-4 bg-background-light/95 dark:bg-background-dark/95 backdrop-blur-md border-b border-gray-100 dark:border-gray-800/50">
        <div class="flex items-center gap-4">
            <button id="back-btn" class="size-10 flex items-center justify-center rounded-full bg-white dark:bg-card-dark text-text-primary-light dark:text-text-primary-dark shadow-sm ring-1 ring-gray-900/5 dark:ring-white/10 transition hover:bg-gray-50 dark:hover:bg-gray-800">
                <span class="material-symbols-outlined text-[24px]">arrow_back</span>
            </button>
            <h1 class="text-2xl font-bold text-text-primary-light dark:text-text-primary-dark tracking-tight">Estatísticas</h1>
        </div>
        <button id="settings-btn" class="flex size-10 items-center justify-center rounded-full bg-white dark:bg-card-dark text-text-primary-light dark:text-text-primary-dark shadow-sm ring-1 ring-gray-900/5 dark:ring-white/10 transition hover:bg-gray-50 dark:hover:bg-gray-800">
            <span class="material-symbols-outlined text-[24px]">settings</span>
        </button>
    </header>
    
    <!-- Main Content -->
    <main class="flex-1 overflow-y-auto overflow-x-hidden p-4 pb-24 space-y-6">
        <!-- Stats Grid -->
        <div class="grid grid-cols-2 gap-4">
            <!-- Level Card -->
            <div class="col-span-1 flex flex-col justify-between rounded-2xl bg-card-light dark:bg-card-dark p-4 shadow-[0_2px_8px_rgba(0,0,0,0.04)] dark:shadow-none ring-1 ring-gray-100 dark:ring-gray-800">
                <div class="mb-3 flex size-10 items-center justify-center rounded-xl bg-primary/10 text-primary">
                    <span class="material-symbols-outlined" style="font-variation-settings: 'FILL' 1;">stars</span>
                </div>
                <div>
                    <h2 class="text-2xl font-bold text-text-primary-light dark:text-text-primary-dark" id="level-value">N/A</h2>
                    <div class="mt-2 flex items-center justify-between text-xs font-medium text-text-secondary-light dark:text-text-secondary-dark mb-1">
                        <span id="current-xp">0 XP</span>
                        <span id="next-level-xp" class="opacity-60">100 XP</span>
                    </div>
                    <div class="h-2 w-full overflow-hidden rounded-full bg-gray-100 dark:bg-gray-700">
                        <div id="xp-progress-bar" class="h-full rounded-full bg-gradient-to-r from-primary to-purple-400" style="width: 0%"></div>
                    </div>
                </div>
            </div>
            
            <!-- Streak Card -->
            <div class="col-span-1 flex flex-col justify-between rounded-2xl bg-card-light dark:bg-card-dark p-4 shadow-[0_2px_8px_rgba(0,0,0,0.04)] dark:shadow-none ring-1 ring-gray-100 dark:ring-gray-800">
                <div class="mb-3 flex size-10 items-center justify-center rounded-xl bg-orange-500/10 text-orange-500">
                    <span class="material-symbols-outlined" style="font-variation-settings: 'FILL' 1;">local_fire_department</span>
                </div>
                <div>
                    <h2 class="text-2xl font-bold text-text-primary-light dark:text-text-primary-dark" id="streak-value">N/A</h2>
                    <p class="text-xs font-medium text-text-secondary-light dark:text-text-secondary-dark mt-1">Dias Consecutivos</p>
                </div>
            </div>
            
            <!-- Total Tasks Card -->
            <div class="col-span-1 flex flex-col justify-between rounded-2xl bg-card-light dark:bg-card-dark p-4 shadow-[0_2px_8px_rgba(0,0,0,0.04)] dark:shadow-none ring-1 ring-gray-100 dark:ring-gray-800">
                <div class="mb-3 flex size-10 items-center justify-center rounded-xl bg-green-500/10 text-green-600">
                    <span class="material-symbols-outlined" style="font-variation-settings: 'FILL' 1;">check_circle</span>
                </div>
                <div>
                    <h2 class="text-2xl font-bold text-text-primary-light dark:text-text-primary-dark" id="total-tasks-value">N/A</h2>
                    <p class="text-xs font-medium text-text-secondary-light dark:text-text-secondary-dark mt-1">Tarefas Completas</p>
                </div>
            </div>
            
            <!-- Completion Rate Card -->
            <div class="col-span-1 flex flex-col justify-between rounded-2xl bg-card-light dark:bg-card-dark p-4 shadow-[0_2px_8px_rgba(0,0,0,0.04)] dark:shadow-none ring-1 ring-gray-100 dark:ring-gray-800">
                <div class="mb-3 flex size-10 items-center justify-center rounded-xl bg-blue-500/10 text-blue-500">
                    <span class="material-symbols-outlined" style="font-variation-settings: 'FILL' 1;">trending_up</span>
                </div>
                <div>
                    <h2 class="text-2xl font-bold text-text-primary-light dark:text-text-primary-dark" id="completion-rate-value">N/A</h2>
                    <p class="text-xs font-medium text-green-600 dark:text-green-400 mt-1 flex items-center gap-0.5">
                        <span class="material-symbols-outlined text-[14px]">arrow_upward</span>
                        vs. semana anterior
                    </p>
                </div>
            </div>
        </div>
        
        <!-- Weekly Productivity Chart -->
        <div class="rounded-2xl bg-card-light dark:bg-card-dark p-6 shadow-[0_2px_8px_rgba(0,0,0,0.04)] dark:shadow-none ring-1 ring-gray-100 dark:ring-gray-800">
            <div class="flex items-center justify-between mb-6">
                <div>
                    <h3 class="text-lg font-bold text-text-primary-light dark:text-text-primary-dark">Produtividade Semanal</h3>
                    <p class="text-sm text-text-secondary-light dark:text-text-secondary-dark">Tarefas completas nos últimos 7 dias</p>
                </div>
                <button id="chart-options-btn" class="text-primary hover:bg-primary/5 p-1.5 rounded-lg transition-colors">
                    <span class="material-symbols-outlined">more_horiz</span>
                </button>
            </div>
            <div class="h-64 w-full">
                <canvas id="weekly-chart"></canvas>
            </div>
        </div>
        
        <!-- Priority Chart (Doughnut style visualization) -->
        <div class="rounded-2xl bg-card-light dark:bg-card-dark p-6 shadow-[0_2px_8px_rgba(0,0,0,0.04)] dark:shadow-none ring-1 ring-gray-100 dark:ring-gray-800">
            <h3 class="text-lg font-bold text-text-primary-light dark:text-text-primary-dark mb-6">Tarefas por Prioridade</h3>
            <div class="flex flex-col sm:flex-row items-center gap-8">
                <div class="relative size-40 shrink-0">
                    <canvas id="priority-chart"></canvas>
                </div>
                <!-- Legend -->
                <div id="priority-legend" class="flex flex-1 w-full flex-col gap-3">
                    <!-- Legend items will be added dynamically -->
                </div>
            </div>
        </div>
        
        <!-- Category Breakdown -->
        <div class="rounded-2xl bg-card-light dark:bg-card-dark p-6 shadow-[0_2px_8px_rgba(0,0,0,0.04)] dark:shadow-none ring-1 ring-gray-100 dark:ring-gray-800">
            <h3 class="text-lg font-bold text-text-primary-light dark:text-text-primary-dark mb-6">Tarefas por Categoria</h3>
            <div class="h-64 w-full">
                <canvas id="category-chart"></canvas>
            </div>
        </div>
    </main>
    
    <!-- Bottom Navigation -->
    <nav class="fixed bottom-0 left-0 right-0 z-50 bg-white/90 dark:bg-card-dark/95 backdrop-blur-lg border-t border-gray-100 dark:border-gray-800 pb-safe pt-2">
        <div class="flex justify-around items-end h-16 pb-2">
            <a class="group flex flex-col items-center gap-1 w-full" href="index.html">
                <span class="material-symbols-outlined text-gray-400 group-hover:text-primary transition-colors text-[28px]">home</span>
                <span class="text-[10px] font-medium text-gray-400 group-hover:text-primary transition-colors">Home</span>
            </a>
            <a class="group flex flex-col items-center gap-1 w-full" href="#">
                <span class="material-symbols-outlined text-gray-400 group-hover:text-primary transition-colors text-[28px]">calendar_month</span>
                <span class="text-[10px] font-medium text-gray-400 group-hover:text-primary transition-colors">Calendário</span>
            </a>
            <!-- Active Stats Tab -->
            <a class="relative -top-6 group flex flex-col items-center justify-center w-full" href="#">
                <div class="flex size-14 items-center justify-center rounded-full bg-primary text-white shadow-lg shadow-primary/40 ring-4 ring-white dark:ring-background-dark transform transition-transform group-active:scale-95">
                    <span class="material-symbols-outlined text-[28px]" style="font-variation-settings: 'FILL' 1;">bar_chart</span>
                </div>
                <span class="mt-1 text-[10px] font-bold text-primary">Estatísticas</span>
            </a>
            <a class="group flex flex-col items-center gap-1 w-full" href="achievements.html">
                <span class="material-symbols-outlined text-gray-400 group-hover:text-primary transition-colors text-[28px]">emoji_events</span>
                <span class="text-[10px] font-medium text-gray-400 group-hover:text-primary transition-colors">Conquistas</span>
            </a>
        </div>
    </nav>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/auth.js"></script>
    <script src="js/gamification.js"></script>
    <script>
        // Stats dashboard class
        class StatsDashboard {
            constructor() {
                this.weeklyChart = null;
                this.priorityChart = null;
                this.categoryChart = null;
                
                this.init();
            }
            
            init() {
                this.bindEvents();
                this.loadAndRenderStats();
                
                // Update stats when the page loads
                this.updateStats();
            }
            
            bindEvents() {
                // Back button
                document.getElementById('back-btn').addEventListener('click', () => {
                    window.location.href = 'index.html';
                });
                
                // Settings button
                document.getElementById('settings-btn').addEventListener('click', () => {
                    // In a real app, this would open settings
                    alert('Configurações será implementado');
                });
                
                // Chart options button
                document.getElementById('chart-options-btn').addEventListener('click', () => {
                    // In a real app, this would show chart options
                    alert('Opções do gráfico será implementado');
                });
            }
            
            // Load tasks from localStorage (mock implementation)
            loadTasks() {
                const tasks = JSON.parse(localStorage.getItem('planner_tasks') || '[]');
                return tasks;
            }
            
            // Load user data
            loadUserData() {
                return gamification.getUserStats();
            }
            
            // Update stats display
            updateStats() {
                const userData = this.loadUserData();
                const tasks = this.loadTasks();
                
                if (userData) {
                    // Update level
                    document.getElementById('level-value').textContent = `Lvl ${userData.level}`;
                    
                    // Update XP progress
                    const xpProgress = gamification.xpProgressPercentage(userData.xp);
                    document.getElementById('current-xp').textContent = `${userData.xp} XP`;
                    document.getElementById('next-level-xp').textContent = `${gamification.xpForNextLevel(userData.level)} XP`;
                    document.getElementById('xp-progress-bar').style.width = `${xpProgress}%`;
                    
                    // Update streak
                    document.getElementById('streak-value').textContent = `${userData.streak} dias`;
                    
                    // Update completed tasks
                    const completedTasks = tasks.filter(task => task.done).length;
                    document.getElementById('total-tasks-value').textContent = completedTasks;
                    
                    // Update completion rate
                    const completionRate = tasks.length > 0 ? Math.round((completedTasks / tasks.length) * 100) : 0;
                    document.getElementById('completion-rate-value').textContent = `${completionRate}%`;
                }
            }
            
            // Render weekly productivity chart
            renderWeeklyChart() {
                const ctx = document.getElementById('weekly-chart').getContext('2d');
                
                // Get tasks from the last 7 days
                const tasks = this.loadTasks();
                const today = new Date();
                const last7Days = [];
                
                // Calculate tasks completed for each day in the last 7 days
                for (let i = 6; i >= 0; i--) {
                    const date = new Date(today);
                    date.setDate(date.getDate() - i);
                    const dateStr = date.toISOString().split('T')[0];
                    
                    // For mock data, we'll use a pattern
                    const tasksForDay = tasks.filter(task => {
                        // In a real app, we would check the completion date
                        // For now, we'll use the creation date as a proxy
                        return task.created_at && task.created_at.split('T')[0] === dateStr && task.done;
                    }).length;
                    
                    // For demo purposes, generate some mock data
                    last7Days.push(Math.floor(Math.random() * 10) + 1);
                }
                
                // Destroy existing chart if it exists
                if (this.weeklyChart) {
                    this.weeklyChart.destroy();
                }
                
                this.weeklyChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'Sáb'],
                        datasets: [{
                            label: 'Tarefas Completas',
                            data: last7Days,
                            borderColor: '#6c47c2',
                            backgroundColor: 'rgba(108, 71, 194, 0.1)',
                            borderWidth: 3,
                            pointBackgroundColor: '#6c47c2',
                            pointBorderColor: '#fff',
                            pointBorderWidth: 2,
                            pointRadius: 5,
                            pointHoverRadius: 7,
                            fill: true,
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                backgroundColor: 'rgba(0, 0, 0, 0.8)',
                                titleColor: '#fff',
                                bodyColor: '#fff',
                                borderColor: '#6c47c2',
                                borderWidth: 1,
                                padding: 12,
                                displayColors: false
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                grid: {
                                    color: 'rgba(0, 0, 0, 0.05)',
                                    drawBorder: false
                                },
                                ticks: {
                                    color: 'rgba(0, 0, 0, 0.6)',
                                    stepSize: 1
                                }
                            },
                            x: {
                                grid: {
                                    display: false
                                },
                                ticks: {
                                    color: 'rgba(0, 0, 0, 0.6)'
                                }
                            }
                        }
                    }
                });
            }
            
            // Render priority chart
            renderPriorityChart() {
                const ctx = document.getElementById('priority-chart').getContext('2d');
                
                // Mock data for priority distribution
                const priorityData = {
                    'Crítica': 5,
                    'Urgente': 8,
                    'Alta': 12,
                    'Média': 20,
                    'Baixa': 15
                };
                
                // Calculate total
                const total = Object.values(priorityData).reduce((sum, val) => sum + val, 0);
                
                // Prepare data for chart
                const labels = Object.keys(priorityData);
                const data = Object.values(priorityData);
                const backgroundColors = [
                    'rgba(239, 68, 68, 0.7)',    // Critical - Red
                    'rgba(239, 68, 68, 0.7)',    // Urgent - Red
                    'rgba(239, 68, 68, 0.7)',    // High - Red
                    'rgba(245, 158, 11, 0.7)',   // Medium - Orange
                    'rgba(16, 185, 129, 0.7)'    // Low - Green
                ];
                
                // Destroy existing chart if it exists
                if (this.priorityChart) {
                    this.priorityChart.destroy();
                }
                
                this.priorityChart = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: labels,
                        datasets: [{
                            data: data,
                            backgroundColor: backgroundColors,
                            borderWidth: 0,
                            hoverOffset: 10
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        cutout: '70%',
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                enabled: false // Disable tooltip as we're showing custom legend
                            }
                        }
                    }
                });
                
                // Render custom legend
                this.renderPriorityLegend(labels, data, backgroundColors, priorityData);
            }
            
            // Render custom priority legend
            renderPriorityLegend(labels, data, backgroundColors, priorityData) {
                const legendContainer = document.getElementById('priority-legend');
                legendContainer.innerHTML = '';
                
                labels.forEach((label, index) => {
                    const percentage = total > 0 ? Math.round((data[index] / total) * 100) : 0;
                    
                    const legendItem = document.createElement('div');
                    legendItem.className = 'flex items-center justify-between p-2 rounded-lg hover:bg-gray-50 dark:hover:bg-white/5 transition-colors';
                    legendItem.innerHTML = `
                        <div class="flex items-center gap-3">
                            <div class="size-3 rounded-full" style="background-color: ${backgroundColors[index]}"></div>
                            <span class="text-sm font-medium text-text-primary-light dark:text-text-primary-dark">${label}</span>
                        </div>
                        <span class="text-sm font-bold text-text-primary-light dark:text-text-primary-dark">${percentage}%</span>
                    `;
                    
                    legendContainer.appendChild(legendItem);
                });
            }
            
            // Render category chart
            renderCategoryChart() {
                const ctx = document.getElementById('category-chart').getContext('2d');
                
                // Mock data for category distribution
                const categoryData = {
                    'Trabalho': 15,
                    'Pessoal': 12,
                    'Saúde': 8,
                    'Estudos': 10,
                    'Finanças': 5,
                    'Outro': 7
                };
                
                // Prepare data for chart
                const labels = Object.keys(categoryData);
                const data = Object.values(categoryData);
                const backgroundColors = [
                    'rgba(59, 130, 246, 0.7)',   // Work - Blue
                    'rgba(16, 185, 129, 0.7)',   // Personal - Green
                    'rgba(245, 158, 11, 0.7)',   // Health - Orange
                    'rgba(139, 92, 246, 0.7)',   // Studies - Purple
                    'rgba(245, 158, 11, 0.7)',   // Finance - Orange
                    'rgba(156, 163, 175, 0.7)'   // Other - Gray
                ];
                
                // Destroy existing chart if it exists
                if (this.categoryChart) {
                    this.categoryChart.destroy();
                }
                
                this.categoryChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Tarefas por Categoria',
                            data: data,
                            backgroundColor: backgroundColors,
                            borderColor: backgroundColors.map(color => color.replace('0.7', '1')),
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                backgroundColor: 'rgba(0, 0, 0, 0.8)',
                                titleColor: '#fff',
                                bodyColor: '#fff',
                                borderColor: '#6c47c2',
                                borderWidth: 1,
                                padding: 12,
                                displayColors: false
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                grid: {
                                    color: 'rgba(0, 0, 0, 0.05)',
                                    drawBorder: false
                                },
                                ticks: {
                                    color: 'rgba(0, 0, 0, 0.6)',
                                    stepSize: 1
                                }
                            },
                            x: {
                                grid: {
                                    display: false
                                },
                                ticks: {
                                    color: 'rgba(0, 0, 0, 0.6)'
                                }
                            }
                        }
                    }
                });
            }
            
            // Load and render all stats
            loadAndRenderStats() {
                this.updateStats();
                this.renderWeeklyChart();
                this.renderPriorityChart();
                this.renderCategoryChart();
            }
        }
        
        // Initialize stats dashboard when page loads
        document.addEventListener('DOMContentLoaded', () => {
            // Check if user is authenticated
            if (!isAuthenticated()) {
                window.location.href = 'auth.html';
                return;
            }
            
            new StatsDashboard();
        });
    </script>
</body>
</html>
<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#6B46C1">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Planner">
    <link rel="apple-touch-icon" href="/icon-192.png">
    <link rel="manifest" href="manifest.json">
    <title>‚ú® Planner Premium ULTRA</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bcryptjs@2.4.3/dist/bcrypt.min.js"></script>
    <script defer src="https://va.vercel-scripts.com/v1/script.js" data-token="__VERCEL_ANALYTICS_TOKEN__"></script>
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root { 
            --primary: #6B46C1; --secondary: #EC4899; --success: #10B981; 
            --danger: #EF4444; --warning: #F59E0B; --dark: #1F2937; 
            --light: #F9FAFB; --gray: #E5E7EB; 
        }
        body { font-family: 'Segoe UI', sans-serif; background: linear-gradient(135deg, #667eea, #764ba2); color: var(--dark); min-height: 100vh; }
        
        @keyframes levelUp {
            0% { transform: scale(0.5) rotate(-10deg); opacity: 0; }
            50% { transform: scale(1.2) rotate(5deg); opacity: 1; }
            100% { transform: scale(1) rotate(0deg); opacity: 1; }
        }
        
        @keyframes confetti {
            0% { transform: translateY(0) rotate(0deg); opacity: 1; }
            100% { transform: translateY(100vh) rotate(720deg); opacity: 0; }
        }
        
        .confetti { position: fixed; width: 10px; height: 10px; z-index: 10000; pointer-events: none; }
        
        .level-up-modal {
            display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            z-index: 9999; background: white; padding: 3rem; border-radius: 20px;
            box-shadow: 0 25px 50px rgba(0,0,0,0.3); text-align: center; animation: levelUp 0.6s ease;
        }
        
        .level-up-modal.active { display: block; }
        .level-up-icon { font-size: 5em; margin-bottom: 1rem; }
        .level-up-title { font-size: 2em; font-weight: 800; background: linear-gradient(135deg, var(--primary), var(--secondary)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        
        .auth-container { min-height: 100vh; display: flex; align-items: center; justify-content: center; padding: 1rem; }
        .auth-box { background: white; border-radius: 20px; padding: 2rem; width: 100%; max-width: 400px; box-shadow: 0 25px 50px rgba(0,0,0,0.25); }
        .auth-logo { text-align: center; margin-bottom: 1.5rem; }
        .auth-logo-icon { font-size: 3em; }
        .auth-logo h1 { font-size: 1.4em; background: linear-gradient(135deg, var(--primary), var(--secondary)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .trial-badge { background: linear-gradient(135deg, #10B981, #059669); color: white; padding: 0.5rem 1rem; border-radius: 20px; font-size: 0.85em; font-weight: 700; margin: 0.8rem 0; display: inline-block; }
        .auth-tabs { display: flex; margin-bottom: 1.5rem; background: var(--gray); border-radius: 10px; padding: 4px; }
        .auth-tab { flex: 1; padding: 0.6rem; border: none; background: transparent; cursor: pointer; font-weight: 600; border-radius: 8px; color: #666; font-size: 0.9em; }
        .auth-tab.active { background: white; color: var(--primary); }
        .auth-form { display: none; }
        .auth-form.active { display: block; }
        .form-group { margin-bottom: 1rem; }
        .form-group label { display: block; margin-bottom: 0.3rem; font-weight: 600; font-size: 0.85em; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 0.75rem; border: 2px solid var(--gray); border-radius: 8px; font-size: 1em; font-family: inherit; }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus { outline: none; border-color: var(--primary); }
        .form-group textarea { min-height: 100px; resize: vertical; }
        .btn-auth { width: 100%; padding: 0.9rem; border: none; border-radius: 10px; font-weight: 700; cursor: pointer; background: linear-gradient(135deg, var(--primary), var(--secondary)); color: white; font-size: 1em; }
        .btn-auth:disabled { opacity: 0.6; cursor: not-allowed; }
        .auth-msg { padding: 0.7rem; border-radius: 8px; margin-bottom: 1rem; font-size: 0.85em; display: none; }
        .auth-error { background: #FEE2E2; color: #DC2626; }
        .auth-success { background: #D1FAE5; color: #059669; }
        
        .trial-banner { padding: 1rem; text-align: center; font-weight: 700; font-size: 0.9em; }
        .trial-banner.warning { background: linear-gradient(135deg, #F59E0B, #D97706); color: white; }
        .trial-banner.danger { background: linear-gradient(135deg, #EF4444, #DC2626); color: white; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.8; } }
        .update-banner { padding: 1rem; text-align: center; font-weight: 700; font-size: 0.9em; background: linear-gradient(135deg, var(--primary), var(--secondary)); color: white; }
        
        .eco-banner { background: linear-gradient(135deg, #10B981, #059669); color: white; padding: 1rem; text-align: center; font-weight: 600; }
        .eco-stats { display: flex; gap: 2rem; justify-content: center; margin-top: 0.5rem; }
        .eco-stat { font-size: 0.9em; }
        
        .paywall-overlay { display: none; position: fixed; z-index: 9999; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); align-items: center; justify-content: center; padding: 1rem; }
        .paywall-overlay.active { display: flex; }
        .paywall-box { background: white; border-radius: 20px; padding: 2.5rem; max-width: 500px; width: 100%; text-align: center; }
        .paywall-icon { font-size: 4em; margin-bottom: 1rem; }
        .paywall-title { font-size: 2em; font-weight: 800; margin-bottom: 0.5rem; background: linear-gradient(135deg, var(--primary), var(--secondary)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .price-box { background: linear-gradient(135deg, #F3E8FF, #E9D5FF); border-radius: 15px; padding: 1.5rem; margin-bottom: 1.5rem; }
        .price-amount { font-size: 3em; font-weight: 800; color: var(--primary); }
        .btn-subscribe { width: 100%; padding: 1.2rem; border: none; border-radius: 12px; font-weight: 800; font-size: 1.1em; cursor: pointer; background: linear-gradient(135deg, var(--primary), var(--secondary)); color: white; }
        
        .app-container { display: none; background: linear-gradient(135deg, #F9FAFB, #F3E8FF); min-height: 100vh; }
        .app-container.active { display: block; }
        .navbar { background: linear-gradient(135deg, var(--primary), var(--secondary)); color: white; padding: 1rem; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 0.5rem; }
        .navbar-title { font-size: 1.2em; font-weight: 800; }
        .navbar-user { display: flex; align-items: center; gap: 0.5rem; flex-wrap: wrap; }
        .user-badge { background: rgba(255,255,255,0.2); padding: 0.4rem 0.8rem; border-radius: 15px; font-size: 0.75em; }
        .level-badge { background: linear-gradient(135deg, #F59E0B, #D97706); padding: 0.4rem 0.8rem; border-radius: 15px; font-size: 0.75em; font-weight: 700; cursor: pointer; }
        .streak-badge { background: linear-gradient(135deg, #EF4444, #DC2626); padding: 0.4rem 0.8rem; border-radius: 15px; font-size: 0.75em; font-weight: 700; }
        .btn-nav { background: rgba(255,255,255,0.2); border: 1px solid white; color: white; padding: 0.4rem 0.8rem; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 0.8em; }
        .btn-nav:hover { background: white; color: var(--primary); }
        
        .tab-menu { display: flex; gap: 0.5rem; background: white; padding: 0.5rem; border-radius: 10px; margin: 1rem auto; max-width: 1200px; overflow-x: auto; }
        .tab-btn { flex: 1; padding: 0.7rem; border: none; background: transparent; cursor: pointer; font-weight: 600; border-radius: 6px; font-size: 0.85em; white-space: nowrap; }
        .tab-btn.active { background: linear-gradient(135deg, var(--primary), var(--secondary)); color: white; }
        
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        .container { max-width: 1400px; margin: 0 auto; padding: 1.5rem 1rem; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 1.5rem; }
        .stat-card { background: white; border-radius: 12px; padding: 1.5rem; box-shadow: 0 4px 15px rgba(0,0,0,0.08); text-align: center; }
        .stat-icon { font-size: 2.5em; margin-bottom: 0.5rem; }
        .stat-value { font-size: 2em; font-weight: 800; color: var(--primary); }
        .stat-label { color: #666; font-size: 0.85em; margin-top: 0.3rem; }
        
        .xp-bar { background: var(--gray); border-radius: 20px; height: 30px; overflow: hidden; margin: 1rem 0; position: relative; }
        .xp-fill { background: linear-gradient(135deg, #10B981, #059669); height: 100%; transition: width 0.5s ease; display: flex; align-items: center; justify-content: center; color: white; font-weight: 700; font-size: 0.85em; }
        
        .achievements-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 1rem; }
        .achievement { background: white; border-radius: 10px; padding: 1rem; text-align: center; box-shadow: 0 4px 15px rgba(0,0,0,0.08); }
        .achievement.locked { opacity: 0.3; }
        .achievement-icon { font-size: 2.5em; }
        .achievement-name { font-size: 0.75em; font-weight: 600; margin-top: 0.3rem; }
        
        .chart-container { background: white; border-radius: 12px; padding: 1.5rem; box-shadow: 0 4px 15px rgba(0,0,0,0.08); margin-bottom: 1.5rem; }
        .chart-title { font-size: 1.1em; font-weight: 700; margin-bottom: 1rem; }
        
        .planner-types { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 1.5rem; }
        .planner-card { background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 15px rgba(0,0,0,0.08); cursor: pointer; border-top: 4px solid; transition: transform 0.2s; }
        .planner-card:hover { transform: translateY(-3px); }
        .planner-header { color: white; padding: 1rem; text-align: center; }
        .planner-icon { font-size: 2em; }
        .planner-title { font-size: 0.95em; font-weight: 700; margin-top: 0.3rem; }
        .planner-body { padding: 1rem; }
        .btn-criar { width: 100%; padding: 0.6rem; background: linear-gradient(135deg, var(--primary), var(--secondary)); color: white; border: none; border-radius: 6px; font-weight: 700; cursor: pointer; font-size: 0.9em; }
        
        .planners-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 1rem; }
        .planner-item { color: white; border-radius: 10px; padding: 1rem; }
        .planner-item-nome { font-weight: 700; margin-bottom: 0.2rem; }
        .planner-item-info { font-size: 0.75em; opacity: 0.9; margin-bottom: 0.6rem; }
        .planner-item-acoes { display: flex; gap: 0.3rem; }
        .planner-item-acoes button { flex: 1; padding: 0.4rem; background: rgba(255,255,255,0.2); color: white; border: 1px solid white; border-radius: 4px; cursor: pointer; font-size: 0.7em; font-weight: 600; }
        
        .biblioteca-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 1rem; }
        .biblioteca-card { background: white; border-radius: 10px; padding: 1rem; text-align: center; cursor: pointer; box-shadow: 0 4px 15px rgba(0,0,0,0.08); transition: transform 0.2s; }
        .biblioteca-card:hover { transform: translateY(-3px); }
        .biblioteca-icon { font-size: 2.5em; margin-bottom: 0.5rem; }
        .biblioteca-title { font-weight: 700; font-size: 0.9em; }
        .biblioteca-subtitle { font-size: 0.75em; color: #666; margin-top: 0.2rem; }
        
        .tutorial-card { background: white; border-radius: 12px; padding: 1.5rem; margin-bottom: 1rem; box-shadow: 0 4px 15px rgba(0,0,0,0.08); cursor: pointer; }
        .tutorial-card:hover { box-shadow: 0 6px 20px rgba(0,0,0,0.12); }
        .tutorial-header { display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem; }
        .tutorial-icon { font-size: 2.5em; }
        .tutorial-title { font-size: 1.2em; font-weight: 700; }
        .tutorial-desc { color: #666; font-size: 0.9em; }
        
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); overflow-y: auto; }
        .modal-content { background: white; margin: 2% auto; padding: 2rem; border-radius: 12px; width: 95%; max-width: 900px; max-height: 90vh; overflow-y: auto; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; border-bottom: 2px solid var(--gray); padding-bottom: 1rem; }
        .close-modal { font-size: 1.5em; cursor: pointer; background: none; border: none; color: #999; }
        
        .form-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 1rem; }
        
        .tags-input { display: flex; flex-wrap: wrap; gap: 0.5rem; padding: 0.5rem; border: 2px solid var(--gray); border-radius: 8px; min-height: 45px; }
        .tag { background: linear-gradient(135deg, var(--primary), var(--secondary)); color: white; padding: 0.3rem 0.6rem; border-radius: 15px; font-size: 0.85em; display: flex; align-items: center; gap: 0.3rem; }
        .tag-remove { cursor: pointer; font-weight: bold; }
        .tag-input-field { border: none; outline: none; flex: 1; min-width: 100px; }
        
        .subtask-list { margin-top: 1rem; }
        .subtask-item { background: var(--light); padding: 0.7rem; border-radius: 6px; margin-bottom: 0.5rem; display: flex; gap: 0.6rem; align-items: center; }
        .subtask-checkbox { width: 18px; height: 18px; cursor: pointer; }
        .subtask-text { flex: 1; }
        
        .reminder-list { margin-top: 1rem; }
        .reminder-item { background: var(--light); padding: 0.7rem; border-radius: 6px; margin-bottom: 0.5rem; display: flex; justify-content: space-between; align-items: center; }
        
        .anexo-list { margin-top: 1rem; display: flex; flex-wrap: wrap; gap: 0.5rem; }
        .anexo-item { background: var(--light); padding: 0.5rem 0.8rem; border-radius: 6px; font-size: 0.85em; display: flex; align-items: center; gap: 0.5rem; }
        
        .tarefa-item { background: var(--light); padding: 1rem; border-radius: 8px; margin-bottom: 0.8rem; border-left: 4px solid var(--primary); cursor: pointer; transition: all 0.2s; }
        .tarefa-item:hover { transform: translateX(5px); box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .tarefa-header { display: flex; gap: 0.8rem; align-items: flex-start; margin-bottom: 0.5rem; }
        .tarefa-checkbox { width: 20px; height: 20px; cursor: pointer; margin-top: 0.2rem; }
        .tarefa-conteudo { flex: 1; }
        .tarefa-titulo { font-weight: 700; font-size: 1em; margin-bottom: 0.3rem; }
        .tarefa-descricao { font-size: 0.85em; color: #666; margin-bottom: 0.5rem; }
        .tarefa-meta { display: flex; flex-wrap: wrap; gap: 0.5rem; font-size: 0.75em; color: #666; }
        .tarefa-meta-item { background: white; padding: 0.2rem 0.5rem; border-radius: 4px; }
        .tarefa-actions { display: flex; gap: 0.5rem; }
        .btn-icon { padding: 0.3rem 0.6rem; background: var(--gray); border: none; border-radius: 4px; cursor: pointer; font-size: 0.85em; }
        .btn-icon:hover { background: var(--primary); color: white; }
        .btn-del { background: var(--danger); color: white; }
        
        .view-switcher { display: flex; gap: 0.5rem; background: white; padding: 0.5rem; border-radius: 8px; margin-bottom: 1rem; }
        .view-btn { flex: 1; padding: 0.6rem; border: none; background: transparent; cursor: pointer; font-weight: 600; border-radius: 6px; font-size: 0.85em; }
        .view-btn.active { background: var(--primary); color: white; }
        
        .kanban-board { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1rem; }
        .kanban-column { background: white; border-radius: 12px; padding: 1rem; }
        .kanban-header { font-weight: 700; margin-bottom: 1rem; padding-bottom: 0.5rem; border-bottom: 2px solid var(--gray); }
        .kanban-card { background: var(--light); padding: 1rem; border-radius: 8px; margin-bottom: 0.8rem; cursor: move; }
        
        .calendar-view { background: white; border-radius: 12px; padding: 1.5rem; }
        .calendar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 0.5rem; }
        .calendar-day-header { text-align: center; font-weight: 700; padding: 0.5rem; font-size: 0.85em; }
        .calendar-day { border: 1px solid var(--gray); border-radius: 8px; padding: 0.5rem; min-height: 100px; font-size: 0.85em; }
        .calendar-day-number { font-weight: 700; margin-bottom: 0.3rem; }
        .calendar-task { background: var(--primary); color: white; padding: 0.2rem 0.4rem; border-radius: 4px; font-size: 0.7em; margin-bottom: 0.2rem; cursor: pointer; }
        
        .timeline-view { background: white; border-radius: 12px; padding: 1.5rem; }
        .timeline-item { display: flex; gap: 1rem; margin-bottom: 1.5rem; }
        .timeline-date { min-width: 100px; font-weight: 700; color: var(--primary); }
        .timeline-content { flex: 1; border-left: 3px solid var(--primary); padding-left: 1rem; }
        
        .btn-primario { padding: 0.8rem 1.5rem; background: linear-gradient(135deg, var(--primary), var(--secondary)); color: white; border: none; border-radius: 8px; font-weight: 700; cursor: pointer; }
        .btn-primario:hover { opacity: 0.9; }
        .btn-secundario { padding: 0.8rem 1.5rem; background: var(--gray); color: var(--dark); border: none; border-radius: 8px; font-weight: 700; cursor: pointer; }
        .btn-secundario:hover { background: #d1d5db; }
        
        .loading { text-align: center; padding: 2rem; }
        .spinner { width: 40px; height: 40px; border: 4px solid var(--gray); border-top-color: var(--primary); border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 1rem; }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        .google-calendar-section { background: white; border-radius: 12px; padding: 2rem; box-shadow: 0 4px 15px rgba(0,0,0,0.08); }
        .gcal-header { text-align: center; margin-bottom: 2rem; }
        .gcal-icon { font-size: 4em; margin-bottom: 1rem; }
        .gcal-benefits { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem; margin-bottom: 2rem; }
        .gcal-benefit { text-align: center; }
        .gcal-benefit-icon { font-size: 2.5em; margin-bottom: 0.5rem; }
        .gcal-steps { background: var(--light); border-radius: 10px; padding: 1.5rem; }
        .gcal-step { margin-bottom: 1rem; padding-left: 2rem; position: relative; }
        .gcal-step:before { content: "‚úì"; position: absolute; left: 0; color: var(--success); font-weight: 700; }
        
        @media (max-width: 768px) {
            .modal-content { width: 98%; padding: 1rem; }
            .form-row { grid-template-columns: 1fr; }
            .kanban-board { grid-template-columns: 1fr; }
            .tab-menu { font-size: 0.75em; }
        }
        .install-btn { 
    position: fixed; 
    right: 16px; 
    bottom: 16px; 
    z-index: 10000; 
    padding: 0.5rem 0.8rem; 
    border: none; 
    border-radius: 999px; 
    font-weight: 700; 
    background: linear-gradient(135deg, var(--primary), var(--secondary)); 
    color: white; 
    box-shadow: 0 6px 12px rgba(0,0,0,0.15);
    cursor: pointer;
    font-size: 0.8em;
    transition: all 0.2s ease;
}

        .install-guide { position: fixed; inset: 0; background: rgba(0,0,0,0.7); z-index: 10000; display: none; align-items: center; justify-content: center; padding: 1rem; }
        .install-guide-box { background: white; border-radius: 16px; padding: 1.5rem; max-width: 420px; width: 100%; text-align: center; }
        .install-guide-title { font-weight: 800; margin-bottom: 0.75rem; font-size: 1.1em; color: #6B46C1; }
        .install-guide-step { margin: 0.4rem 0; font-size: 0.95em; }
        .install-guide-actions { margin-top: 1rem; }

.install-btn:hover {
    transform: scale(1.05); /* ‚Üê ADICIONEI efeito hover */
    box-shadow: 0 15px 30px rgba(0,0,0,0.3);
}

.install-btn:active {
    transform: scale(0.95); /* ‚Üê ADICIONEI efeito de clique */
}


    </style>
</head>
<body>
    <div class="loading" id="loadingScreen">
        <div class="spinner"></div>
        <p>Inicializando sistema avan√ßado...</p>
    </div>

    <div class="auth-container" id="authContainer" style="display:none;">
        <div class="auth-box">
            <div class="auth-logo">
                <div class="auth-logo-icon">‚ú®</div>
                <h1>Planner Premium ULTRA</h1>
                <div class="trial-badge">üéÅ 14 dias gr√°tis ‚Ä¢ R$ 19,99/m√™s</div>
            </div>
            <div class="auth-tabs">
                <button class="auth-tab active" onclick="showAuthTab('login')">Entrar</button>
                <button class="auth-tab" onclick="showAuthTab('signup')">Criar Conta</button>
            </div>
            <div id="authError" class="auth-msg auth-error"></div>
            <div id="authSuccess" class="auth-msg auth-success"></div>

            <form id="loginForm" class="auth-form active" onsubmit="handleLogin(event)">
                <div class="form-group"><label>Email</label><input type="email" id="loginEmail" required></div>
                <div class="form-group"><label>Senha</label><input type="password" id="loginPassword" required></div>
                <button type="submit" class="btn-auth" id="loginBtn">Entrar</button>
            </form>

            <form id="signupForm" class="auth-form" onsubmit="handleSignup(event)">
                <div class="form-group"><label>Nome Completo</label><input type="text" id="signupName" required></div>
                <div class="form-group"><label>Email</label><input type="email" id="signupEmail" required></div>
                <div class="form-group"><label>Senha (m√≠n. 6)</label><input type="password" id="signupPassword" minlength="6" required></div>
                <button type="submit" class="btn-auth" id="signupBtn">üéÅ Come√ßar Trial Gr√°tis</button>
            </form>
        </div>
    </div>

    <div class="paywall-overlay" id="paywallOverlay">
        <div class="paywall-box">
            <div class="paywall-icon">üîí</div>
            <h1 class="paywall-title">Trial Expirado</h1>
            <p style="color:#666; margin-bottom:2rem;">Assine agora para continuar!</p>
            <div class="price-box">
                <div class="price-amount">R$ 19,99</div>
                <div style="color:#666; font-size:0.9em;">por m√™s</div>
            </div>
            <button class="btn-subscribe" onclick="redirectToStripe()">üí≥ Assinar Agora</button>
        </div>
    </div>

    <div class="level-up-modal" id="levelUpModal">
        <div class="level-up-icon">üéâ</div>
        <h2 class="level-up-title">Level Up!</h2>
        <p style="font-size:1.5em; margin:1rem 0;">N√≠vel <span id="newLevel">2</span></p>
        <button class="btn-primario" onclick="closeLevelUp()">Continuar</button>
    </div>

    <div id="trialBanner" class="trial-banner" style="display:none;"></div>
    <div id="updateBanner" class="update-banner" style="display:none;"></div>
    
    <div class="eco-banner">
        üå± 100% Digital ‚Ä¢ Zero Papel
        <div class="eco-stats">
            <span class="eco-stat">üìÑ <span id="paperSaved">0</span> p√°ginas economizadas</span>
            <span class="eco-stat">üå≥ <span id="treesSaved">0</span> √°rvores salvas</span>
        </div>
    </div>

    <div class="app-container" id="appContainer">
        <div class="navbar">
            <div class="navbar-title">‚ú® Planner Premium ULTRA</div>
            <div class="navbar-user">
                <span class="level-badge" onclick="openTab('stats')" id="levelBadge">‚≠ê N√≠vel 1</span>
                <span class="streak-badge" id="streakBadge">üî• 0 dias</span>
                <span class="user-badge">üë§ <span id="userName">User</span></span>
                <select id="langSelect" class="btn-nav">
                    <option value="pt">Portugu√™s</option>
                    <option value="en">English</option>
                    <option value="es">Espa√±ol</option>
                    <option value="fr">Fran√ßais</option>
                    <option value="de">Deutsch</option>
                </select>
                <button id="subscribeNavBtn" class="btn-nav" onclick="redirectToStripe()" style="display:none;">Assinar</button>
                <button id="logoutBtn" class="btn-nav" onclick="logout()">Sair</button>
            </div>
        </div>

        <div class="container">
            <div class="tab-menu">
                <button class="tab-btn active" onclick="openTab('planners')">üìã Planners</button>
                <button class="tab-btn" onclick="openTab('biblioteca')">üìñ Biblioteca</button>
                <button class="tab-btn" onclick="openTab('tutoriais')">üìö Tutoriais</button>
                <button class="tab-btn" onclick="openTab('stats')">üìä Stats</button>
                <button class="tab-btn" onclick="openTab('achievements')">üèÜ Conquistas</button>
                <button class="tab-btn" onclick="openTab('calendar')">üìÖ Calend√°rio</button>
                <button class="tab-btn" onclick="openTab('google')">üîó Google</button>
            </div>

            <div id="plannersTab" class="tab-content active">
                <h2 id="headingCreatePlanner" style="margin-bottom:0.8rem;">Criar Novo Planner</h2>
                <div class="planner-types">
                    <div class="planner-card" style="border-top-color:#10B981;" onclick="criarPlanner('todo')">
                        <div class="planner-header" style="background:linear-gradient(135deg,#10B981,#059669);"><div class="planner-icon">‚úÖ</div><div class="planner-title">To-Do</div></div>
                        <div class="planner-body"><button class="btn-criar">Criar</button></div>
                    </div>
                    <div class="planner-card" style="border-top-color:#3B82F6;" onclick="criarPlanner('projeto')">
                        <div class="planner-header" style="background:linear-gradient(135deg,#3B82F6,#1D4ED8);"><div class="planner-icon">üèóÔ∏è</div><div class="planner-title">Projetos</div></div>
                        <div class="planner-body"><button class="btn-criar">Criar</button></div>
                    </div>
                    <div class="planner-card" style="border-top-color:#F59E0B;" onclick="criarPlanner('habitos')">
                        <div class="planner-header" style="background:linear-gradient(135deg,#F59E0B,#D97706);"><div class="planner-icon">üî•</div><div class="planner-title">H√°bitos</div></div>
                        <div class="planner-body"><button class="btn-criar">Criar</button></div>
                    </div>
                    <div class="planner-card" style="border-top-color:#8B5CF6;" onclick="criarPlanner('financeiro')">
                        <div class="planner-header" style="background:linear-gradient(135deg,#8B5CF6,#6D28D9);"><div class="planner-icon">üí∞</div><div class="planner-title">Financeiro</div></div>
                        <div class="planner-body"><button class="btn-criar">Criar</button></div>
                    </div>
                </div>
                <div style="background:white; border-radius:12px; padding:1.5rem; box-shadow: 0 4px 15px rgba(0,0,0,0.08);">
                    <h2 id="headingMeusPlanners" style="margin-bottom:1rem;">üìã Meus Planners</h2>
                    <div class="planners-grid" id="meusPlanners"></div>
                </div>
            </div>

            <div id="bibliotecaTab" class="tab-content">
                <h2 id="headingBibliotecaPremium" style="margin-bottom:1rem;">üìñ Biblioteca Premium (900+ P√°ginas)</h2>
                <div style="background:white; border-radius:12px; padding:1.5rem; box-shadow: 0 4px 15px rgba(0,0,0,0.08); margin-bottom:1.5rem;">
                    <h3 style="margin-bottom:1rem;">üìÖ Planejamento Temporal</h3>
                    <div class="biblioteca-grid">
                        <div class="biblioteca-card" onclick="criarPlannerBiblioteca('diario')">
                            <div class="biblioteca-icon">üìÖ</div>
                            <div class="biblioteca-title">P√°ginas Di√°rias</div>
                            <div class="biblioteca-subtitle">365 p√°ginas</div>
                        </div>
                        <div class="biblioteca-card" onclick="criarPlannerBiblioteca('semanal')">
                            <div class="biblioteca-icon">üìÜ</div>
                            <div class="biblioteca-title">P√°ginas Semanais</div>
                            <div class="biblioteca-subtitle">52 p√°ginas</div>
                        </div>
                        <div class="biblioteca-card" onclick="criarPlannerBiblioteca('mensal')">
                            <div class="biblioteca-icon">üóìÔ∏è</div>
                            <div class="biblioteca-title">P√°ginas Mensais</div>
                            <div class="biblioteca-subtitle">12 p√°ginas</div>
                        </div>
                        <div class="biblioteca-card" onclick="criarPlannerBiblioteca('anual')">
                            <div class="biblioteca-icon">üìä</div>
                            <div class="biblioteca-title">Vis√£o Anual</div>
                            <div class="biblioteca-subtitle">1 p√°gina</div>
                        </div>
                    </div>
                </div>
                
                <div style="background:white; border-radius:12px; padding:1.5rem; box-shadow: 0 4px 15px rgba(0,0,0,0.08); margin-bottom:1.5rem;">
                    <h3 style="margin-bottom:1rem;">üéØ Planejadores Tem√°ticos</h3>
                    <div class="biblioteca-grid">
                        <div class="biblioteca-card" onclick="criarPlannerBiblioteca('financeiro_biblio')">
                            <div class="biblioteca-icon">üí∞</div>
                            <div class="biblioteca-title">Financeiro</div>
                            <div class="biblioteca-subtitle">Controle total</div>
                        </div>
                        <div class="biblioteca-card" onclick="criarPlannerBiblioteca('saude')">
                            <div class="biblioteca-icon">üí™</div>
                            <div class="biblioteca-title">Sa√∫de</div>
                            <div class="biblioteca-subtitle">Bem-estar</div>
                        </div>
                        <div class="biblioteca-card" onclick="criarPlannerBiblioteca('leitura')">
                            <div class="biblioteca-icon">üìö</div>
                            <div class="biblioteca-title">Leitura</div>
                            <div class="biblioteca-subtitle">Livros & Metas</div>
                        </div>
                        <div class="biblioteca-card" onclick="criarPlannerBiblioteca('viagem')">
                            <div class="biblioteca-icon">‚úàÔ∏è</div>
                            <div class="biblioteca-title">Viagens</div>
                            <div class="biblioteca-subtitle">Planeje aventuras</div>
                        </div>
                        <div class="biblioteca-card" onclick="criarPlannerBiblioteca('metas')">
                            <div class="biblioteca-icon">üéØ</div>
                            <div class="biblioteca-title">Metas</div>
                            <div class="biblioteca-subtitle">Objetivos</div>
                        </div>
                        <div class="biblioteca-card" onclick="criarPlannerBiblioteca('habitos_biblio')">
                            <div class="biblioteca-icon">üî•</div>
                            <div class="biblioteca-title">H√°bitos</div>
                            <div class="biblioteca-subtitle">Tracker di√°rio</div>
                        </div>
                    </div>
                </div>
                
                <div style="background:white; border-radius:12px; padding:1.5rem; box-shadow: 0 4px 15px rgba(0,0,0,0.08);">
                    <h2 id="headingBibliotecaMeus" style="margin-bottom:1rem;">üìã Meus Planners da Biblioteca</h2>
                    <div class="planners-grid" id="meusPlannersBiblioteca"></div>
                </div>
            </div>

            <div id="tutoriaisTab" class="tab-content">
                <h2 id="headingTutoriais" style="margin-bottom:1.5rem;">üìö √Årea de Membros - Tutoriais Exclusivos</h2>
                <div id="tutoriaisLista"></div>
            </div>

            <div id="statsTab" class="tab-content">
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon">‚≠ê</div>
                        <div class="stat-value" id="statLevel">1</div>
                        <div id="labelLevel" class="stat-label">N√≠vel</div>
                        <div class="xp-bar">
                            <div class="xp-fill" id="xpBar" style="width:0%;">0/100 XP</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">üî•</div>
                        <div class="stat-value" id="statStreak">0</div>
                        <div id="labelStreak" class="stat-label">Dias de Streak</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">‚úÖ</div>
                        <div class="stat-value" id="statCompleted">0</div>
                        <div id="labelCompleted" class="stat-label">Tarefas Conclu√≠das</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">üìà</div>
                        <div class="stat-value" id="statRate">0%</div>
                        <div id="labelRate" class="stat-label">Taxa de Conclus√£o</div>
                    </div>
                </div>
                
                <div class="chart-container">
                    <h3 id="chartWeeklyTitle" class="chart-title">üìä Produtividade Semanal</h3>
                    <canvas id="weeklyChart" height="80"></canvas>
                </div>
                
                <div class="chart-container">
                    <h3 id="chartPriorityTitle" class="chart-title">üéØ Tarefas por Prioridade</h3>
                    <canvas id="priorityChart" height="80"></canvas>
                </div>
            </div>

            <div id="achievementsTab" class="tab-content">
                <h2 id="headingAchievements" style="margin-bottom:1rem;">üèÜ Conquistas Desbloqueadas</h2>
                <div class="achievements-grid" id="achievementsList"></div>
            </div>

            <div id="calendarTab" class="tab-content">
                <div class="calendar-view">
                    <div class="calendar-header">
                        <button id="btnCalPrev" class="btn-secundario" onclick="changeMonth(-1)">‚óÄ Anterior</button>
                        <h2 id="calendarTitle">Janeiro 2024</h2>
                        <button id="btnCalNext" class="btn-secundario" onclick="changeMonth(1)">Pr√≥ximo ‚ñ∂</button>
                    </div>
                    <div class="calendar-grid" id="calendarGrid"></div>
                </div>
            </div>

            <div id="googleTab" class="tab-content">
                <div class="google-calendar-section">
                    <div class="gcal-header">
                        <div class="gcal-icon">üìÖ</div>
                        <h2 id="headingGoogleCalendar">Integra√ß√£o Google Calendar</h2>
                        <p id="subheadingGoogleCalendar" style="color:#666; margin-top:0.5rem;">Sincronize suas tarefas com o Google Calendar</p>
                    </div>
                    
                    <div class="gcal-benefits">
                        <div class="gcal-benefit">
                            <div class="gcal-benefit-icon">üì±</div>
                            <h3>Acesso Universal</h3>
                            <p style="color:#666; font-size:0.9em;">Android, iPhone, Web, Desktop</p>
                        </div>
                        <div class="gcal-benefit">
                            <div class="gcal-benefit-icon">üîî</div>
                            <h3>Notifica√ß√µes Nativas</h3>
                            <p style="color:#666; font-size:0.9em;">Alertas em todos dispositivos</p>
                        </div>
                        <div class="gcal-benefit">
                            <div class="gcal-benefit-icon">üîÑ</div>
                            <h3>Sync Autom√°tico</h3>
                            <p style="color:#666; font-size:0.9em;">Sempre atualizado</p>
                        </div>
                    </div>
                    
                    <div class="gcal-steps">
                        <h3 style="margin-bottom:1rem;">Como Integrar:</h3>
                        <div class="gcal-step">Acesse suas configura√ß√µes do Google Calendar</div>
                        <div class="gcal-step">Clique em "Adicionar calend√°rio" ‚Üí "A partir de URL"</div>
                        <div class="gcal-step">Cole a URL abaixo e confirme</div>
                        <div class="gcal-step">Suas tarefas aparecer√£o automaticamente!</div>
                    </div>
                    
                    <div style="background:var(--light); border-radius:10px; padding:1rem; margin-top:1.5rem;">
                        <label id="labelGcalSyncUrl" style="font-weight:600; display:block; margin-bottom:0.5rem;">Sua URL de Sincroniza√ß√£o:</label>
                        <div style="display:flex; gap:0.5rem; flex-wrap:wrap;">
                            <input type="text" id="gcalUrl" readonly style="flex:1; min-width:220px; padding:0.7rem; border:2px solid var(--gray); border-radius:6px; font-family:monospace; font-size:0.85em;">
                            <button id="btnCopyGcal" class="btn-primario" onclick="copyGcalUrl()">üìã Copiar</button>
                            <button id="btnConnectGcal" class="btn-secundario" onclick="connectCalendarManual()">üîó Conectar Calendar</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Criar Planner -->
    <div id="modalCriar" class="modal">
        <div class="modal-content">
            <div class="modal-header"><h2><span id="modalIcone"></span> <span id="modalTitulo">Novo</span></h2><button class="close-modal" onclick="fecharModal('modalCriar')">&times;</button></div>
            <div class="form-group"><label>Nome *</label><input type="text" id="inputNome"></div>
            <div class="form-group"><label>Data de In√≠cio</label><input type="date" id="inputData"></div>
            <div style="display:flex; gap:0.5rem;">
                <button class="btn-secundario" style="flex:1;" onclick="fecharModal('modalCriar')">Cancelar</button>
                <button class="btn-primario" style="flex:1;" onclick="salvarPlanner()">Criar</button>
            </div>
        </div>
    </div>

    <!-- Modal Ver Planner -->
    <div id="modalVer" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2><span id="verIcone"></span> <span id="verNome">Planner</span></h2>
                <button class="close-modal" onclick="fecharModal('modalVer')">&times;</button>
            </div>

            <div class="view-switcher">
                <button class="view-btn active" onclick="switchView('list')">üìã Lista</button>
                <button class="view-btn" onclick="switchView('kanban')">üìä Kanban</button>
                <button class="view-btn" onclick="switchView('timeline')">üìà Timeline</button>
            </div>

            <button id="btnNovaTarefa" class="btn-primario" style="width:100%; margin-bottom:1.5rem;" onclick="abrirModalNovaTarefa()">+ Nova Tarefa Avan√ßada</button>

            <div style="display:flex; gap:0.5rem; margin-bottom:1rem;">
                <button id="btnExportCSV" class="btn-secundario" style="flex:1;" onclick="exportarExcel()">üì• Exportar Excel (CSV)</button>
                <button id="btnReportPDF" class="btn-secundario" style="flex:1;" onclick="baixarRelatorioPDF()">üìÑ Relat√≥rio PDF</button>
            </div>

            <div id="listView" class="tab-content active">
                <div id="listaTarefas"></div>
            </div>

            <div id="kanbanView" class="tab-content">
                <div class="kanban-board">
                    <div class="kanban-column">
                        <div class="kanban-header">üìã A Fazer</div>
                        <div id="kanbanTodo"></div>
                    </div>
                    <div class="kanban-column">
                        <div class="kanban-header">üöÄ Em Progresso</div>
                        <div id="kanbanProgress"></div>
                    </div>
                    <div class="kanban-column">
                        <div class="kanban-header">‚úÖ Conclu√≠do</div>
                        <div id="kanbanDone"></div>
                    </div>
                </div>
            </div>

            <div id="timelineView" class="tab-content">
                <div class="timeline-view" id="timelineContainer"></div>
            </div>
        </div>
    </div>

    <!-- Modal Nova Tarefa -->
    <div id="modalNovaTarefa" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>‚ú® Nova Tarefa Avan√ßada</h2>
                <button class="close-modal" onclick="fecharModal('modalNovaTarefa')">&times;</button>
            </div>

            <div class="form-group">
                <label>T√≠tulo da Tarefa *</label>
                <input type="text" id="novaTarefaTitulo" placeholder="Ex: Reuni√£o com cliente">
            </div>

            <div class="form-group">
                <label>Descri√ß√£o Completa</label>
                <textarea id="novaTarefaDescricao" placeholder="Descreva detalhes, objetivos, contexto..."></textarea>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>Categoria</label>
                    <select id="novaTarefaCategoria">
                        <option value="trabalho">üíº Trabalho</option>
                        <option value="pessoal">üè† Pessoal</option>
                        <option value="saude">üí™ Sa√∫de</option>
                        <option value="estudos">üìö Estudos</option>
                        <option value="financeiro">üí∞ Financeiro</option>
                        <option value="outro">üìå Outro</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Prioridade</label>
                    <select id="novaTarefaPrioridade">
                        <option value="baixa">üü¢ Baixa</option>
                        <option value="media">üü° M√©dia</option>
                        <option value="alta">üî¥ Alta</option>
                        <option value="urgente">üî• Urgente</option>
                        <option value="critica">‚ö° Cr√≠tica</option>
                    </select>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>Data</label>
                    <input type="date" id="novaTarefaData">
                </div>
                <div class="form-group">
                    <label>Hora</label>
                    <input type="time" id="novaTarefaHora">
                </div>
                <div class="form-group">
                    <label>Dura√ß√£o (min)</label>
                    <input type="number" id="novaTarefaDuracao" placeholder="60">
                </div>
            </div>

            <div class="form-group">
                <label>Repetir Tarefa</label>
                <select id="novaTarefaRepetir">
                    <option value="nao">N√£o repetir</option>
                    <option value="diario">üìÖ Diariamente</option>
                    <option value="semanal">üìÜ Semanalmente</option>
                    <option value="mensal">üóìÔ∏è Mensalmente</option>
                </select>
            </div>

            <div class="form-group">
                <label>Tags (pressione Enter para adicionar)</label>
                <div class="tags-input" id="tagsContainer">
                    <input type="text" class="tag-input-field" id="tagInput" placeholder="Digite e pressione Enter">
                </div>
            </div>

            <div class="form-group">
                <label>‚è∞ Lembretes</label>
                <div class="form-row">
                    <select id="lembreteSelect">
                        <option value="">Selecione...</option>
                        <option value="5min">5 minutos antes</option>
                        <option value="15min">15 minutos antes</option>
                        <option value="30min">30 minutos antes</option>
                        <option value="1h">1 hora antes</option>
                        <option value="1dia">1 dia antes</option>
                    </select>
                    <button type="button" class="btn-secundario" onclick="adicionarLembrete()">+ Adicionar</button>
                </div>
                <div class="reminder-list" id="lembretesLista"></div>
            </div>

            <div class="form-group">
                <label>‚úÖ Subtarefas</label>
                <div style="display:flex; gap:0.5rem; margin-bottom:0.5rem;">
                    <input type="text" id="subtarefaInput" placeholder="Nome da subtarefa" style="flex:1;">
                    <button type="button" class="btn-secundario" onclick="adicionarSubtarefa()">+ Adicionar</button>
                </div>
                <div class="subtask-list" id="subtarefasLista"></div>
            </div>

            <div class="form-group">
                <label>üîó Links e Anexos</label>
                <div style="display:flex; gap:0.5rem; margin-bottom:0.5rem;">
                    <input type="text" id="anexoInput" placeholder="Cole o link aqui" style="flex:1;">
                    <button type="button" class="btn-secundario" onclick="adicionarAnexo()">+ Adicionar</button>
                </div>
                <div class="anexo-list" id="anexosLista"></div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>Contexto</label>
                    <select id="novaTarefaContexto">
                        <option value="qualquer">üìç Qualquer lugar</option>
                        <option value="casa">üè† Casa</option>
                        <option value="escritorio">üè¢ Escrit√≥rio</option>
                        <option value="online">üíª Online</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Energia Necess√°ria</label>
                    <select id="novaTarefaEnergia">
                        <option value="baixa">üòä Baixa</option>
                        <option value="media">‚ö° M√©dia</option>
                        <option value="alta">üî• Alta</option>
                    </select>
                </div>
            </div>

            <div style="display:flex; gap:0.5rem; margin-top:1.5rem;">
                <button class="btn-secundario" style="flex:1;" onclick="fecharModal('modalNovaTarefa')">Cancelar</button>
                <button class="btn-primario" style="flex:1;" onclick="salvarNovaTarefa()">üíæ Salvar Tarefa</button>
            </div>
        </div>
    </div>

    <!-- Modal Biblioteca -->
    <div id="modalBiblioteca" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2><span id="biblioIcone"></span> <span id="biblioTitulo">Biblioteca</span></h2>
                <button class="close-modal" onclick="fecharModal('modalBiblioteca')">&times;</button>
            </div>
            <div id="biblioConteudo"></div>
        </div>
    </div>

    <!-- Modal Tutorial -->
    <div id="modalTutorial" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2><span id="tutorialIcone"></span> <span id="tutorialTitulo">Tutorial</span></h2>
                <button class="close-modal" onclick="fecharModal('modalTutorial')">&times;</button>
            </div>
            <div id="tutorialConteudo"></div>
        </div>
    </div>

    <div id="modalTarefaDetalhe" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="tarefaDetalheTitulo"></h2>
                <button class="close-modal" onclick="fecharModal('modalTarefaDetalhe')">&times;</button>
            </div>
            <div id="tarefaDetalheConteudo"></div>
        </div>
    </div>

    <script>
        const LANG_KEY = 'planner_ultra_lang';
        const i18n = {
            pt: {
                appTitle: '‚ú® Planner Premium ULTRA',
                logout: 'Sair',
                subscribe: 'Assinar',
                createPlanner: 'Criar Novo Planner',
                meusPlanners: 'üìã Meus Planners',
                bibliotecaPremium: 'üìñ Biblioteca Premium (900+ P√°ginas)',
                meusPlannersBiblio: 'üìã Meus Planners da Biblioteca',
                tutoriaisHeading: 'üìö √Årea de Membros - Tutoriais Exclusivos',
                achievementsHeading: 'üèÜ Conquistas Desbloqueadas',
                weeklyChart: 'üìä Produtividade Semanal',
                priorityChart: 'üéØ Tarefas por Prioridade',
                calendarPrev: '‚óÄ Anterior',
                calendarNext: 'Pr√≥ximo ‚ñ∂',
                googleHeading: 'Integra√ß√£o Google Calendar',
                googleSub: 'Sincronize suas tarefas com o Google Calendar',
                gcalSyncLabel: 'Sua URL de Sincroniza√ß√£o:',
                copy: 'üìã Copiar',
                connectCalendar: 'üîó Conectar Calendar',
                novaTarefaBtn: '+ Nova Tarefa Avan√ßada',
                exportCSV: 'üì• Exportar Excel (CSV)',
                reportPDF: 'üìÑ Relat√≥rio PDF',
                statLevel: 'N√≠vel',
                statStreak: 'Dias de Streak',
                statCompleted: 'Tarefas Conclu√≠das',
                statRate: 'Taxa de Conclus√£o',
                badgeLevel: 'N√≠vel',
                badgeDays: 'dias',
                msgFirstPlanner: 'Crie seu primeiro planner!',
                msgNoLibraryPlanners: 'Nenhum planner criado da biblioteca',
                msgNoTasks: 'Nenhuma tarefa criada',
                msgNoTasksShort: 'Nenhuma tarefa',
                alertNoPlannerOpen: '‚ùå Nenhum planner aberto!',
                alertNoTasksToExport: '‚ùå Nenhuma tarefa para exportar!',
                alertExportOk: '‚úÖ Excel exportado com sucesso!',
                alertExportErr: '‚ùå Erro ao exportar Excel',
                alertNoTasksReport: '‚ùå Nenhuma tarefa para gerar relat√≥rio!',
                alertReportOk: '‚úÖ Relat√≥rio baixado! Abra o arquivo HTML e use Ctrl+P para salvar como PDF.',
                alertReportErr: '‚ùå Erro ao gerar relat√≥rio',
                confirmDeleteTask: 'Deletar esta tarefa?',
                confirmDeletePlanner: 'Deletar planner e todas as tarefas?',
                msgCopied: '‚úÖ URL copiada! Cole no Google Calendar.',
                msgUrlUnavailable: '‚ùå URL indispon√≠vel',
                more: 'mais',
                noDate: 'Sem data',
                chartWeeklyDataset: 'Tarefas Conclu√≠das',
                prioHigh: 'Alta/Urgente',
                prioMedium: 'M√©dia',
                prioLow: 'Baixa'
            },
            en: {
                appTitle: '‚ú® Planner Premium ULTRA',
                logout: 'Log out',
                subscribe: 'Subscribe',
                createPlanner: 'Create New Planner',
                meusPlanners: 'üìã My Planners',
                bibliotecaPremium: 'üìñ Premium Library (900+ Pages)',
                meusPlannersBiblio: 'üìã My Library Planners',
                tutoriaisHeading: 'üìö Members Area - Exclusive Tutorials',
                achievementsHeading: 'üèÜ Unlocked Achievements',
                weeklyChart: 'üìä Weekly Productivity',
                priorityChart: 'üéØ Tasks by Priority',
                calendarPrev: '‚óÄ Previous',
                calendarNext: 'Next ‚ñ∂',
                googleHeading: 'Google Calendar Integration',
                googleSub: 'Sync your tasks with Google Calendar',
                gcalSyncLabel: 'Your Sync URL:',
                copy: 'üìã Copy',
                connectCalendar: 'üîó Connect Calendar',
                novaTarefaBtn: '+ New Advanced Task',
                exportCSV: 'üì• Export Excel (CSV)',
                reportPDF: 'üìÑ Report PDF',
                statLevel: 'Level',
                statStreak: 'Streak Days',
                statCompleted: 'Completed Tasks',
                statRate: 'Completion Rate',
                badgeLevel: 'Level',
                badgeDays: 'days',
                msgFirstPlanner: 'Create your first planner!',
                msgNoLibraryPlanners: 'No library planners yet',
                msgNoTasks: 'No tasks created',
                msgNoTasksShort: 'No tasks',
                alertNoPlannerOpen: '‚ùå No planner open!',
                alertNoTasksToExport: '‚ùå No tasks to export!',
                alertExportOk: '‚úÖ Excel exported successfully!',
                alertExportErr: '‚ùå Error exporting CSV',
                alertNoTasksReport: '‚ùå No tasks to generate report!',
                alertReportOk: '‚úÖ Report downloaded! Open HTML and use Ctrl+P to save as PDF.',
                alertReportErr: '‚ùå Error generating report',
                confirmDeleteTask: 'Delete this task?',
                confirmDeletePlanner: 'Delete planner and all tasks?',
                msgCopied: '‚úÖ URL copied! Paste into Google Calendar.',
                msgUrlUnavailable: '‚ùå URL unavailable',
                more: 'more',
                noDate: 'No date',
                chartWeeklyDataset: 'Completed Tasks',
                prioHigh: 'High/Urgent',
                prioMedium: 'Medium',
                prioLow: 'Low'
            },
            es: {
                appTitle: '‚ú® Planificador Premium ULTRA',
                logout: 'Salir',
                subscribe: 'Suscribirse',
                createPlanner: 'Crear Nuevo Planificador',
                meusPlanners: 'üìã Mis Planificadores',
                bibliotecaPremium: 'üìñ Biblioteca Premium (900+ P√°ginas)',
                meusPlannersBiblio: 'üìã Mis Planificadores de la Biblioteca',
                tutoriaisHeading: 'üìö √Årea de Miembros - Tutoriales Exclusivos',
                achievementsHeading: 'üèÜ Logros Desbloqueados',
                weeklyChart: 'üìä Productividad Semanal',
                priorityChart: 'üéØ Tareas por Prioridad',
                calendarPrev: '‚óÄ Anterior',
                calendarNext: 'Siguiente ‚ñ∂',
                googleHeading: 'Integraci√≥n con Google Calendar',
                googleSub: 'Sincroniza tus tareas con Google Calendar',
                gcalSyncLabel: 'Tu URL de Sincronizaci√≥n:',
                copy: 'üìã Copiar',
                connectCalendar: 'üîó Conectar Calendario',
                novaTarefaBtn: '+ Nueva Tarea Avanzada',
                exportCSV: 'üì• Exportar Excel (CSV)',
                reportPDF: 'üìÑ Informe PDF',
                statLevel: 'Nivel',
                statStreak: 'D√≠as de Racha',
                statCompleted: 'Tareas Completadas',
                statRate: 'Tasa de Finalizaci√≥n',
                badgeLevel: 'Nivel',
                badgeDays: 'd√≠as',
                msgFirstPlanner: '¬°Crea tu primer planificador!',
                msgNoLibraryPlanners: 'A√∫n no hay planificadores de biblioteca',
                msgNoTasks: 'No hay tareas creadas',
                msgNoTasksShort: 'No hay tareas',
                alertNoPlannerOpen: '‚ùå ¬°Ning√∫n planificador abierto!',
                alertNoTasksToExport: '‚ùå ¬°No hay tareas para exportar!',
                alertExportOk: '‚úÖ ¬°Excel exportado con √©xito!',
                alertExportErr: '‚ùå Error al exportar CSV',
                alertNoTasksReport: '‚ùå ¬°No hay tareas para generar informe!',
                alertReportOk: '‚úÖ Informe descargado. Abre el HTML y usa Ctrl+P para guardar como PDF.',
                alertReportErr: '‚ùå Error al generar informe',
                confirmDeleteTask: '¬øEliminar esta tarea?',
                confirmDeletePlanner: '¬øEliminar el planificador y todas las tareas?',
                msgCopied: '‚úÖ ¬°URL copiada! Pega en Google Calendar.',
                msgUrlUnavailable: '‚ùå URL no disponible',
                more: 'm√°s',
                noDate: 'Sin fecha',
                chartWeeklyDataset: 'Tareas Completadas',
                prioHigh: 'Alta/Urgente',
                prioMedium: 'Media',
                prioLow: 'Baja'
            },
            fr: {
                appTitle: '‚ú® Planner Premium ULTRA',
                logout: 'Se d√©connecter',
                subscribe: 'S‚Äôabonner',
                createPlanner: 'Cr√©er un nouveau planner',
                meusPlanners: 'üìã Mes Planners',
                bibliotecaPremium: 'üìñ Biblioth√®que Premium (900+ Pages)',
                meusPlannersBiblio: 'üìã Mes Planners de la Biblioth√®que',
                tutoriaisHeading: 'üìö Espace Membres - Tutoriels Exclusifs',
                achievementsHeading: 'üèÜ Succ√®s D√©bloqu√©s',
                weeklyChart: 'üìä Productivit√© Hebdomadaire',
                priorityChart: 'üéØ T√¢ches par Priorit√©',
                calendarPrev: '‚óÄ Pr√©c√©dent',
                calendarNext: 'Suivant ‚ñ∂',
                googleHeading: 'Int√©gration Google Calendar',
                googleSub: 'Synchronisez vos t√¢ches avec Google Calendar',
                gcalSyncLabel: 'Votre URL de Synchronisation :',
                copy: 'üìã Copier',
                connectCalendar: 'üîó Connecter Calendar',
                novaTarefaBtn: '+ Nouvelle T√¢che Avanc√©e',
                exportCSV: 'üì• Exporter Excel (CSV)',
                reportPDF: 'üìÑ Rapport PDF',
                statLevel: 'Niveau',
                statStreak: 'Jours de S√©rie',
                statCompleted: 'T√¢ches Termin√©es',
                statRate: 'Taux d‚ÄôAch√®vement',
                badgeLevel: 'Niveau',
                badgeDays: 'jours',
                msgFirstPlanner: 'Cr√©ez votre premier planner !',
                msgNoLibraryPlanners: 'Aucun planner biblioth√®que pour le moment',
                msgNoTasks: 'Aucune t√¢che cr√©√©e',
                msgNoTasksShort: 'Aucune t√¢che',
                alertNoPlannerOpen: '‚ùå Aucun planner ouvert !',
                alertNoTasksToExport: '‚ùå Aucune t√¢che √† exporter !',
                alertExportOk: '‚úÖ Excel export√© avec succ√®s !',
                alertExportErr: '‚ùå Erreur lors de l‚Äôexport CSV',
                alertNoTasksReport: '‚ùå Aucune t√¢che pour g√©n√©rer un rapport !',
                alertReportOk: '‚úÖ Rapport t√©l√©charg√©. Ouvrez le HTML et utilisez Ctrl+P pour enregistrer en PDF.',
                alertReportErr: '‚ùå Erreur lors de la g√©n√©ration du rapport',
                confirmDeleteTask: 'Supprimer cette t√¢che ?',
                confirmDeletePlanner: 'Supprimer le planner et toutes les t√¢ches ?',
                msgCopied: '‚úÖ URL copi√©e ! Collez-la dans Google Calendar.',
                msgUrlUnavailable: '‚ùå URL indisponible',
                more: 'de plus',
                noDate: 'Sans date',
                chartWeeklyDataset: 'T√¢ches termin√©es',
                prioHigh: 'Haute/Urgente',
                prioMedium: 'Moyenne',
                prioLow: 'Basse'
            },
            de: {
                appTitle: '‚ú® Planner Premium ULTRA',
                logout: 'Abmelden',
                subscribe: 'Abonnieren',
                createPlanner: 'Neuen Planer erstellen',
                meusPlanners: 'üìã Meine Planer',
                bibliotecaPremium: 'üìñ Premium-Bibliothek (900+ Seiten)',
                meusPlannersBiblio: 'üìã Meine Bibliotheksplaner',
                tutoriaisHeading: 'üìö Mitgliederbereich ‚Äì Exklusive Tutorials',
                achievementsHeading: 'üèÜ Freigeschaltete Erfolge',
                weeklyChart: 'üìä W√∂chentliche Produktivit√§t',
                priorityChart: 'üéØ Aufgaben nach Priorit√§t',
                calendarPrev: '‚óÄ Zur√ºck',
                calendarNext: 'Weiter ‚ñ∂',
                googleHeading: 'Google Kalender Integration',
                googleSub: 'Synchronisieren Sie Ihre Aufgaben mit Google Kalender',
                gcalSyncLabel: 'Ihre Synchronisierungs-URL:',
                copy: 'üìã Kopieren',
                connectCalendar: 'üîó Kalender verbinden',
                novaTarefaBtn: '+ Neue Erweiterte Aufgabe',
                exportCSV: 'üì• Excel exportieren (CSV)',
                reportPDF: 'üìÑ Bericht PDF',
                statLevel: 'Level',
                statStreak: 'Serie-Tage',
                statCompleted: 'Abgeschlossene Aufgaben',
                statRate: 'Abschlussrate',
                badgeLevel: 'Level',
                badgeDays: 'Tage',
                msgFirstPlanner: 'Erstellen Sie Ihren ersten Planer!',
                msgNoLibraryPlanners: 'Noch keine Bibliotheksplaner',
                msgNoTasks: 'Keine Aufgaben erstellt',
                msgNoTasksShort: 'Keine Aufgaben',
                alertNoPlannerOpen: '‚ùå Kein Planer ge√∂ffnet!',
                alertNoTasksToExport: '‚ùå Keine Aufgaben zum Exportieren!',
                alertExportOk: '‚úÖ Excel erfolgreich exportiert!',
                alertExportErr: '‚ùå Fehler beim CSV-Export',
                alertNoTasksReport: '‚ùå Keine Aufgaben f√ºr den Bericht!',
                alertReportOk: '‚úÖ Bericht heruntergeladen. √ñffnen Sie die HTML-Datei und verwenden Sie Strg+P, um als PDF zu speichern.',
                alertReportErr: '‚ùå Fehler beim Generieren des Berichts',
                confirmDeleteTask: 'Diese Aufgabe l√∂schen?',
                confirmDeletePlanner: 'Planer und alle Aufgaben l√∂schen?',
                msgCopied: '‚úÖ URL kopiert! In Google Kalender einf√ºgen.',
                msgUrlUnavailable: '‚ùå URL nicht verf√ºgbar',
                more: 'mehr',
                noDate: 'Kein Datum',
                chartWeeklyDataset: 'Abgeschlossene Aufgaben',
                prioHigh: 'Hoch/Dringend',
                prioMedium: 'Mittel',
                prioLow: 'Niedrig'
            }
        };

        let currentLang = localStorage.getItem(LANG_KEY) || 'pt';
        function getLocale() {
            return ({ pt: 'pt-BR', en: 'en-US', es: 'es-ES', fr: 'fr-FR', de: 'de-DE' }[currentLang]) || 'pt-BR';
        }
        function tr(k) { const t = i18n[currentLang] || i18n.pt; return (t[k] !== undefined ? t[k] : (i18n.pt[k] !== undefined ? i18n.pt[k] : k)); }

        function applyTranslations() {
            const t = i18n[currentLang] || i18n.pt;
            const setText = (id, text) => { const el = document.getElementById(id); if (el) el.textContent = text; };
            setText('headingCreatePlanner', t.createPlanner);
            setText('headingMeusPlanners', t.meusPlanners);
            setText('headingBibliotecaPremium', t.bibliotecaPremium);
            setText('headingBibliotecaMeus', t.meusPlannersBiblio);
            setText('headingTutoriais', t.tutoriaisHeading);
            setText('headingAchievements', t.achievementsHeading);
            setText('chartWeeklyTitle', t.weeklyChart);
            setText('chartPriorityTitle', t.priorityChart);
            setText('btnCalPrev', t.calendarPrev);
            setText('btnCalNext', t.calendarNext);
            setText('headingGoogleCalendar', t.googleHeading);
            setText('subheadingGoogleCalendar', t.googleSub);
            setText('labelGcalSyncUrl', t.gcalSyncLabel);
            setText('btnCopyGcal', t.copy);
            setText('btnConnectGcal', t.connectCalendar);
            setText('btnNovaTarefa', t.novaTarefaBtn);
            setText('btnExportCSV', t.exportCSV);
            setText('btnReportPDF', t.reportPDF);
            setText('labelLevel', t.statLevel);
            setText('labelStreak', t.statStreak);
            setText('labelCompleted', t.statCompleted);
            setText('labelRate', t.statRate);
            const titleEl = document.querySelector('.navbar-title'); if (titleEl) titleEl.textContent = t.appTitle;
            const subBtn = document.getElementById('subscribeNavBtn'); if (subBtn) subBtn.textContent = t.subscribe;
            const logoutBtn = document.getElementById('logoutBtn'); if (logoutBtn) logoutBtn.textContent = t.logout;
            document.querySelectorAll('.tab-menu .tab-btn').forEach((btn, idx) => {
                const tabKeys = ['üìã Planners','üìñ Biblioteca','üìö Tutoriais','üìä Stats','üèÜ Conquistas','üìÖ Calend√°rio','üîó Google'];
                const map = {
                    'pt': tabKeys,
                    'en': ['üìã Planners','üìñ Library','üìö Tutorials','üìä Stats','üèÜ Achievements','üìÖ Calendar','üîó Google'],
                    'es': ['üìã Planificadores','üìñ Biblioteca','üìö Tutoriales','üìä Estad√≠sticas','üèÜ Logros','üìÖ Calendario','üîó Google'],
                    'fr': ['üìã Planners','üìñ Biblioth√®que','üìö Tutoriels','üìä Statistiques','üèÜ Succ√®s','üìÖ Calendrier','üîó Google'],
                    'de': ['üìã Planer','üìñ Bibliothek','üìö Tutorials','üìä Statistik','üèÜ Erfolge','üìÖ Kalender','üîó Google']
                };
                const texts = map[currentLang] || tabKeys; btn.textContent = texts[idx];
            });
        }

        function setLanguage(lang) {
            currentLang = lang;
            localStorage.setItem(LANG_KEY, currentLang);
            applyTranslations();
            try { renderCharts(); renderCalendar(); renderAchievements(); } catch (_) {}
        }
        const SUPABASE_URL = 'https://szzirxygtjztusudfqsw.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InN6emlyeHlndGp6dHVzdWRmcXN3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM4NDk0NzEsImV4cCI6MjA3OTQyNTQ3MX0.zEMDaMA-DvcSiHmj4a3thB1Nnu9cEWGqfFes8R8lICA';
        const STRIPE_LINK = 'https://buy.stripe.com/00w8wPer71rq9zw2Em2VG00';
        
        let supabase = null;
        let currentUser = null;
        let planners = [];
        let plannerAberto = null;
        let tipoAtual = '';
        let currentView = 'list';
        let currentMonth = new Date().getMonth();
        let currentYear = new Date().getFullYear();
        let tempTags = [];
        let tempLembretes = [];
        let tempSubtarefas = [];
        let tempAnexos = [];
        let deferredPrompt = null;
        let alarmTimers = [];
        let calendarUrlPrivate = '';
        let googleToken = null;
        let googleConnected = false;
        const GOOGLE_CLIENT_ID = window.GOOGLE_CLIENT_ID || '';
        const OFFLINE_CAL_QUEUE_KEY = 'planner_ultra_offline_calendar';
        
        let tarefasCache = [];
        
        const tipos = {
            'todo': { nome: 'To-Do', icone: '‚úÖ', cor: '#10B981' },
            'projeto': { nome: 'Projeto', icone: 'üèóÔ∏è', cor: '#3B82F6' },
            'habitos': { nome: 'H√°bitos', icone: 'üî•', cor: '#F59E0B' },
            'financeiro': { nome: 'Financeiro', icone: 'üí∞', cor: '#8B5CF6' },
            'diario': { nome: 'Di√°rio', icone: 'üìÖ', cor: '#EC4899' },
            'semanal': { nome: 'Semanal', icone: 'üìÜ', cor: '#10B981' },
            'mensal': { nome: 'Mensal', icone: 'üóìÔ∏è', cor: '#F59E0B' },
            'anual': { nome: 'Anual', icone: 'üìä', cor: '#6B46C1' },
            'financeiro_biblio': { nome: 'Financeiro Premium', icone: 'üí∞', cor: '#8B5CF6' },
            'saude': { nome: 'Sa√∫de', icone: 'üí™', cor: '#EF4444' },
            'leitura': { nome: 'Leitura', icone: 'üìö', cor: '#3B82F6' },
            'viagem': { nome: 'Viagens', icone: '‚úàÔ∏è', cor: '#06B6D4' },
            'metas': { nome: 'Metas', icone: 'üéØ', cor: '#F59E0B' },
            'habitos_biblio': { nome: 'H√°bitos Tracker', icone: 'üî•', cor: '#EF4444' }
        };
        
        const achievements = [
            { id: 'first_task', name: 'Primeira Tarefa', icon: 'üéØ', requirement: 1 },
            { id: 'task_master', name: 'Mestre das Tarefas', icon: 'üëë', requirement: 10 },
            { id: 'century', name: 'Centen√°rio', icon: 'üíØ', requirement: 100 },
            { id: 'week_streak', name: 'Streak 7 Dias', icon: 'üî•', requirement: 7 },
            { id: 'month_streak', name: 'Streak 30 Dias', icon: 'üí™', requirement: 30 },
            { id: 'level_10', name: 'N√≠vel 10', icon: '‚≠ê', requirement: 10 },
            { id: 'planner_pro', name: 'Planejador Pro', icon: 'üìã', requirement: 5 }
        ];

        const APP_VERSION = '1.1.0';
        function trackAdminEvent(name, data) {
            try {
                if (!currentUser || currentUser.subscription_status !== 'admin') return;
                if (window.va && typeof window.va.track === 'function') {
                    window.va.track(name, data || {});
                }
            } catch (_) {}
        }
        function checkAppVersion() {
            const prev = localStorage.getItem('planner_ultra_version');
            if (prev && prev !== APP_VERSION) {
                const b = document.getElementById('updateBanner');
                if (b) {
                    b.innerHTML = `‚ú® Planner ULTRA atualizado para v${APP_VERSION} ‚Ä¢ melhorias de desempenho e novos recursos <button class="btn-nav" style="margin-left:.5rem" onclick="closeUpdateBanner()">Fechar</button>`;
                    b.style.display = 'block';
                }
            }
            localStorage.setItem('planner_ultra_version', APP_VERSION);
        }
        function closeUpdateBanner() { const b = document.getElementById('updateBanner'); if (b) b.style.display = 'none'; }
        const OFFLINE_TASKS_KEY = 'planner_ultra_offline_tarefas';
        const SESSION_KEY = 'planner_ultra_user';
        function getOfflineTasks() { try { return JSON.parse(localStorage.getItem(OFFLINE_TASKS_KEY) || '[]'); } catch (_) { return []; } }
        function setOfflineTasks(arr) { localStorage.setItem(OFFLINE_TASKS_KEY, JSON.stringify(arr)); }
        function addOfflineTask(t) { const arr = getOfflineTasks(); arr.push(t); setOfflineTasks(arr); }
        function saveSession(user) { localStorage.setItem(SESSION_KEY, JSON.stringify(user)); }
        function loadSession() { try { return JSON.parse(localStorage.getItem(SESSION_KEY) || 'null'); } catch (_) { return null; } }
        async function syncOfflineTasks() {
            if (!navigator.onLine || !supabase || !currentUser) return;
            const arr = getOfflineTasks();
            if (!arr.length) return;
            const remain = [];
            for (const t of arr) {
                try {
                    const { error } = await supabase.from('tarefas').insert([{
                        planner_id: t.planner_id,
                        titulo: t.titulo,
                        descricao: t.descricao,
                        categoria: t.categoria,
                        prioridade: t.prioridade,
                        data: t.data,
                        hora: t.hora,
                        duracao: t.duracao,
                        repetir: t.repetir,
                        contexto: t.contexto,
                        energia: t.energia,
                        tags: t.tags,
                        lembretes: t.lembretes,
                        subtarefas: t.subtarefas,
                        anexos: t.anexos,
                        done: t.done,
                        em_progresso: t.em_progresso
                    }]);
                    if (error) remain.push(t); else createCalendarEventForTask(t);
                } catch (_) { remain.push(t); }
            }
            setOfflineTasks(remain);
            if (plannerAberto) abrirPlanner(plannerAberto);
            renderPlanners();
        }

        const tutoriaisData = [
            {
                id: 'comeco',
                icon: 'üöÄ',
                title: 'Como Come√ßar',
                desc: 'Guia completo para dar seus primeiros passos',
                content: `
                    <h3>üöÄ Bem-vindo ao Planner Premium ULTRA!</h3>
                    <p style="margin:1rem 0;">Este tutorial vai te ensinar tudo para come√ßar com o p√© direito.</p>
                    
                    <h4 style="margin-top:1.5rem;">1Ô∏è‚É£ Crie seu primeiro planner</h4>
                    <p>V√° na aba "Planners" e escolha o tipo ideal para voc√™: To-Do, Projetos, H√°bitos ou Financeiro.</p>
                    
                    <h4 style="margin-top:1.5rem;">2Ô∏è‚É£ Adicione tarefas</h4>
                    <p>Clique em "Nova Tarefa Avan√ßada" e preencha todos os detalhes. Quanto mais informa√ß√µes, melhor!</p>
                    
                    <h4 style="margin-top:1.5rem;">3Ô∏è‚É£ Ganhe XP e suba de n√≠vel</h4>
                    <p>Cada tarefa conclu√≠da te d√° +20 XP. Complete tarefas diariamente para manter seu streak!</p>
                    
                    <h4 style="margin-top:1.5rem;">4Ô∏è‚É£ Explore a Biblioteca</h4>
                    <p>900+ p√°ginas prontas para voc√™ usar: di√°rias, semanais, mensais e planejadores tem√°ticos.</p>
                `
            },
            {
                id: 'gamificacao',
                icon: 'üéÆ',
                title: 'Sistema de Gamifica√ß√£o',
                desc: 'Entenda n√≠veis, XP, streaks e conquistas',
                content: `
                    <h3>üéÆ Sistema de Gamifica√ß√£o</h3>
                    
                    <h4 style="margin-top:1.5rem;">‚≠ê N√≠veis e XP</h4>
                    <ul style="margin-left:1.5rem; margin-top:0.5rem;">
                        <li>Criar planner: +50 XP</li>
                        <li>Completar tarefa: +20 XP</li>
                        <li>Cada n√≠vel requer: N√≠vel √ó 100 XP</li>
                        <li>Exemplo: N√≠vel 5 ‚Üí 500 XP necess√°rios</li>
                    </ul>
                    
                    <h4 style="margin-top:1.5rem;">üî• Streak</h4>
                    <p>Use o app todos os dias para manter seu streak ativo! Cada dia consecutivo aumenta o contador.</p>
                    
                    <h4 style="margin-top:1.5rem;">üèÜ Conquistas</h4>
                    <ul style="margin-left:1.5rem; margin-top:0.5rem;">
                        <li>üéØ Primeira Tarefa: Complete 1 tarefa</li>
                        <li>üëë Mestre das Tarefas: 10 tarefas</li>
                        <li>üíØ Centen√°rio: 100 tarefas</li>
                        <li>üî• Streak 7 dias</li>
                        <li>üí™ Streak 30 dias</li>
                        <li>‚≠ê N√≠vel 10</li>
                        <li>üìã 5 planners criados</li>
                    </ul>
                `
            },
            {
                id: 'tarefas',
                icon: '‚úÖ',
                title: 'Tarefas Avan√ßadas',
                desc: 'Domine todos os campos e recursos',
                content: `
                    <h3>‚úÖ Tarefas Avan√ßadas</h3>
                    
                    <h4 style="margin-top:1.5rem;">üìù Campos Principais</h4>
                    <ul style="margin-left:1.5rem; margin-top:0.5rem;">
                        <li><strong>T√≠tulo:</strong> Nome curto e claro</li>
                        <li><strong>Descri√ß√£o:</strong> Detalhes completos</li>
                        <li><strong>Categoria:</strong> Organize por √°rea da vida</li>
                        <li><strong>Prioridade:</strong> De Baixa a Cr√≠tica</li>
                        <li><strong>Data/Hora:</strong> Quando fazer</li>
                        <li><strong>Dura√ß√£o:</strong> Tempo estimado</li>
                    </ul>
                    
                    <h4 style="margin-top:1.5rem;">üéØ Recursos Avan√ßados</h4>
                    <ul style="margin-left:1.5rem; margin-top:0.5rem;">
                        <li><strong>Tags:</strong> Palavras-chave para busca</li>
                        <li><strong>Lembretes:</strong> De 5min a 1 dia antes</li>
                        <li><strong>Subtarefas:</strong> Divida em etapas</li>
                        <li><strong>Anexos:</strong> Links √∫teis</li>
                        <li><strong>Contexto:</strong> Onde fazer (casa, escrit√≥rio, etc)</li>
                        <li><strong>Energia:</strong> Quanta disposi√ß√£o precisa</li>
                    </ul>
                    
                    <h4 style="margin-top:1.5rem;">üí° Dica Pro</h4>
                    <p>Preencha TODOS os campos! Quanto mais informa√ß√µes, mais f√°cil planejar seu dia.</p>
                `
            },
            {
                id: 'kanban',
                icon: 'üìä',
                title: 'Vis√£o Kanban',
                desc: 'Gerencie tarefas visualmente',
                content: `
                    <h3>üìä Vis√£o Kanban</h3>
                    
                    <h4 style="margin-top:1.5rem;">üéØ O que √© Kanban?</h4>
                    <p>√â um m√©todo visual de organiza√ß√£o que divide tarefas em 3 colunas:</p>
                    
                    <ul style="margin-left:1.5rem; margin-top:1rem;">
                        <li><strong>üìã A Fazer:</strong> Tarefas pendentes</li>
                        <li><strong>üöÄ Em Progresso:</strong> O que voc√™ est√° fazendo agora</li>
                        <li><strong>‚úÖ Conclu√≠do:</strong> Tarefas finalizadas</li>
                    </ul>
                    
                    <h4 style="margin-top:1.5rem;">üîÑ Como Usar</h4>
                    <ol style="margin-left:1.5rem; margin-top:0.5rem;">
                        <li>Abra qualquer planner</li>
                        <li>Clique em "üìä Kanban" no topo</li>
                        <li>Visualize suas tarefas organizadas</li>
                        <li>Arraste cards entre colunas (futuro)</li>
                    </ol>
                    
                    <h4 style="margin-top:1.5rem;">üí° Melhor Pr√°tica</h4>
                    <p>Mantenha no m√°ximo 3 tarefas em "Em Progresso" para n√£o se sobrecarregar!</p>
                `
            },
            {
                id: 'google',
                icon: 'üìÖ',
                title: 'Google Calendar',
                desc: 'Sincronize com todos seus dispositivos',
                content: `
                    <h3>üìÖ Integra√ß√£o Google Calendar</h3>
                    
                    <h4 style="margin-top:1.5rem;">‚ú® Por que integrar?</h4>
                    <ul style="margin-left:1.5rem; margin-top:0.5rem;">
                        <li>üì± Acesso em Android, iPhone, Web e Desktop</li>
                        <li>üîî Notifica√ß√µes push nativas</li>
                        <li>üîÑ Sincroniza√ß√£o autom√°tica</li>
                        <li>üë• Compartilhe com fam√≠lia/equipe</li>
                    </ul>
                    
                    <h4 style="margin-top:1.5rem;">üîó Como Conectar</h4>
                    <ol style="margin-left:1.5rem; margin-top:0.5rem;">
                        <li>V√° na aba "üîó Google"</li>
                        <li>Copie sua URL personalizada</li>
                        <li>Abra Google Calendar</li>
                        <li>V√° em Configura√ß√µes ‚Üí Adicionar calend√°rio ‚Üí De URL</li>
                        <li>Cole a URL e confirme</li>
                        <li>Pronto! Suas tarefas aparecer√£o automaticamente</li>
                    </ol>
                    
                    <h4 style="margin-top:1.5rem;">üí° Dica</h4>
                    <p>Ative notifica√ß√µes no Google Calendar para nunca perder um prazo!</p>
                `
            },
            {
                id: 'produtividade',
                icon: '‚ö°',
                title: 'Dicas de Produtividade',
                desc: 'T√©cnicas comprovadas',
                content: `
                    <h3>‚ö° Dicas de Produtividade</h3>
                    
                    <h4 style="margin-top:1.5rem;">üçÖ T√©cnica Pomodoro</h4>
                    <p>Trabalhe 25min ‚Üí Pausa 5min ‚Üí Repita 4x ‚Üí Pausa longa 30min</p>
                    <p>Use o campo "Dura√ß√£o" para planejar seus pomodoros!</p>
                    
                    <h4 style="margin-top:1.5rem;">üê∏ Eat the Frog</h4>
                    <p>Fa√ßa a tarefa mais dif√≠cil/importante PRIMEIRO. Marque como "Cr√≠tica" ou "Urgente".</p>
                    
                    <h4 style="margin-top:1.5rem;">üìã Regra dos 2 Minutos</h4>
                    <p>Se algo leva menos de 2min, fa√ßa AGORA! N√£o adicione ao planner.</p>
                    
                    <h4 style="margin-top:1.5rem;">üéØ MIT (Most Important Tasks)</h4>
                    <p>Identifique 1-3 tarefas ESSENCIAIS do dia. Use prioridade "Alta" ou "Cr√≠tica".</p>
                    
                    <h4 style="margin-top:1.5rem;">‚ö° Energia √ó Tempo</h4>
                    <p>Tarefas que exigem alta energia ‚Üí manh√£</p>
                    <p>Tarefas autom√°ticas ‚Üí tarde/noite</p>
                    <p>Use o campo "Energia Necess√°ria"!</p>
                `
            },
            {
                id: 'relatorios',
                icon: 'üìà',
                title: 'Relat√≥rios e Stats',
                desc: 'Analise sua produtividade',
                content: `
                    <h3>üìà Relat√≥rios e Estat√≠sticas</h3>
                    
                    <h4 style="margin-top:1.5rem;">üìä Gr√°ficos Dispon√≠veis</h4>
                    <ul style="margin-left:1.5rem; margin-top:0.5rem;">
                        <li><strong>Produtividade Semanal:</strong> Tarefas completadas por dia</li>
                        <li><strong>Por Prioridade:</strong> Distribui√ß√£o alta/m√©dia/baixa</li>
                    </ul>
                    
                    <h4 style="margin-top:1.5rem;">üìâ M√©tricas Principais</h4>
                    <ul style="margin-left:1.5rem; margin-top:0.5rem;">
                        <li><strong>N√≠vel:</strong> Seu progresso geral</li>
                        <li><strong>Streak:</strong> Dias consecutivos ativos</li>
                        <li><strong>Tarefas Conclu√≠das:</strong> Total hist√≥rico</li>
                        <li><strong>Taxa de Conclus√£o:</strong> % de sucesso</li>
                    </ul>
                    
                    <h4 style="margin-top:1.5rem;">üí° Como Usar</h4>
                    <p>Analise seus padr√µes semanalmente:</p>
                    <ul style="margin-left:1.5rem; margin-top:0.5rem;">
                        <li>Qual dia voc√™ √© mais produtivo?</li>
                        <li>Est√° priorizando corretamente?</li>
                        <li>Sua taxa de conclus√£o est√° subindo?</li>
                    </ul>
                `
            },
            {
                id: 'atalhos',
                icon: '‚å®Ô∏è',
                title: 'Atalhos Avan√ßados',
                desc: 'Use o sistema como um pro',
                content: `
                    <h3>‚å®Ô∏è Atalhos e Truques Pro</h3>
                    
                    <h4 style="margin-top:1.5rem;">‚ö° Navega√ß√£o R√°pida</h4>
                    <ul style="margin-left:1.5rem; margin-top:0.5rem;">
                        <li>Use as abas do topo para alternar rapidamente</li>
                        <li>Clique no badge de n√≠vel para ir direto para Stats</li>
                        <li>ESC fecha qualquer modal aberto</li>
                    </ul>
                    
                    <h4 style="margin-top:1.5rem;">‚úèÔ∏è Cria√ß√£o R√°pida</h4>
                    <ul style="margin-left:1.5rem; margin-top:0.5rem;">
                        <li><strong>Tags:</strong> Digite e pressione ENTER</li>
                        <li><strong>Subtarefas:</strong> Adicione m√∫ltiplas rapidamente</li>
                        <li><strong>Data:</strong> Use o formato DD/MM/AAAA</li>
                    </ul>
                    
                    <h4 style="margin-top:1.5rem;">üéØ Organiza√ß√£o Pro</h4>
                    <ul style="margin-left:1.5rem; margin-top:0.5rem;">
                        <li>Use emojis no t√≠tulo das tarefas para identifica√ß√£o visual</li>
                        <li>Crie planners por projeto, n√£o por tipo</li>
                        <li>Revise sua Biblioteca Premium semanalmente</li>
                    </ul>
                    
                    <h4 style="margin-top:1.5rem;">üå± Sustentabilidade</h4>
                    <p>Veja no topo quantas p√°ginas e √°rvores voc√™ j√° economizou usando nosso planner digital!</p>
                `
            }
        ];

        async function init() {
            document.getElementById('inputData').value = new Date().toISOString().split('T')[0];
            document.getElementById('novaTarefaData').value = new Date().toISOString().split('T')[0];
            
            try {
                supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
                document.getElementById('loadingScreen').style.display = 'none';
                const saved = loadSession();
                if (saved) { loginUser(saved); } else { document.getElementById('authContainer').style.display = 'flex'; }
                setupTagInput();
                setupPWAInstall();
                window.addEventListener('online', syncOfflineTasks);
                window.addEventListener('online', syncOfflineCalendar);
                checkAppVersion();
                const sel = document.getElementById('langSelect');
                if (sel) {
                    sel.value = currentLang;
                    sel.addEventListener('change', (e) => setLanguage(e.target.value));
                }
                applyTranslations();
            } catch (err) {
                console.error('Erro:', err);
                alert('Erro ao conectar');
            }
        }
        
        init();
        window.addEventListener('load', () => {
            try { setupPWAInstall(); } catch (_) {}
        });

        function formatDateBR(date) {
            const d = new Date(date);
            const day = String(d.getDate()).padStart(2, '0');
            const month = String(d.getMonth() + 1).padStart(2, '0');
            const year = d.getFullYear();
            return `${day}/${month}/${year}`;
        }

        function setupTagInput() {
            const tagInput = document.getElementById('tagInput');
            if (tagInput) {
                tagInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        const tag = tagInput.value.trim();
                        if (tag && !tempTags.includes(tag)) {
                            tempTags.push(tag);
                            renderTags();
                            tagInput.value = '';
                        }
                    }
                });
            }
        }

        function renderTags() {
            const container = document.getElementById('tagsContainer');
            const tagInput = document.getElementById('tagInput');
            container.innerHTML = '';
            
            tempTags.forEach(tag => {
                const tagEl = document.createElement('div');
                tagEl.className = 'tag';
                tagEl.innerHTML = `${tag} <span class="tag-remove" onclick="removeTag('${tag}')">‚úï</span>`;
                container.appendChild(tagEl);
            });
            
            container.appendChild(tagInput);
        }

        function removeTag(tag) {
            tempTags = tempTags.filter(t => t !== tag);
            renderTags();
        }

        function adicionarLembrete() {
            const select = document.getElementById('lembreteSelect');
            const value = select.value;
            if (value && !tempLembretes.includes(value)) {
                tempLembretes.push(value);
                renderLembretes();
            }
        }

        function renderLembretes() {
            const container = document.getElementById('lembretesLista');
            const labels = {
                '5min': 'üîî 5 minutos antes',
                '15min': 'üîî 15 minutos antes',
                '30min': 'üîî 30 minutos antes',
                '1h': 'üîî 1 hora antes',
                '1dia': 'üîî 1 dia antes'
            };
            
            container.innerHTML = tempLembretes.map(l => `
                <div class="reminder-item">
                    <span>${labels[l]}</span>
                    <button class="btn-icon btn-del" onclick="removeLembrete('${l}')">‚úï</button>
                </div>
            `).join('');
        }

        function removeLembrete(lembrete) {
            tempLembretes = tempLembretes.filter(l => l !== lembrete);
            renderLembretes();
        }

        function adicionarSubtarefa() {
            const input = document.getElementById('subtarefaInput');
            const text = input.value.trim();
            if (text) {
                tempSubtarefas.push({ text, done: false });
                renderSubtarefas();
                input.value = '';
            }
        }

        function renderSubtarefas() {
            const container = document.getElementById('subtarefasLista');
            container.innerHTML = tempSubtarefas.map((s, i) => `
                <div class="subtask-item">
                    <input type="checkbox" class="subtask-checkbox" ${s.done ? 'checked' : ''} onchange="toggleSubtarefa(${i})">
                    <span class="subtask-text">${s.text}</span>
                    <button class="btn-icon btn-del" onclick="removeSubtarefa(${i})">‚úï</button>
                </div>
            `).join('');
        }

        function toggleSubtarefa(index) {
            tempSubtarefas[index].done = !tempSubtarefas[index].done;
            renderSubtarefas();
        }

        function removeSubtarefa(index) {
            tempSubtarefas.splice(index, 1);
            renderSubtarefas();
        }

        function adicionarAnexo() {
            const input = document.getElementById('anexoInput');
            const url = input.value.trim();
            if (url) {
                tempAnexos.push(url);
                renderAnexos();
                input.value = '';
            }
        }

        function renderAnexos() {
            const container = document.getElementById('anexosLista');
            container.innerHTML = tempAnexos.map((a, i) => `
                <div class="anexo-item">
                    üîó <a href="${a}" target="_blank">${a.substring(0, 30)}...</a>
                    <button class="btn-icon btn-del" onclick="removeAnexo(${i})">‚úï</button>
                </div>
            `).join('');
        }

        function removeAnexo(index) {
            tempAnexos.splice(index, 1);
            renderAnexos();
        }

        function showAuthTab(t) {
            document.querySelectorAll('.auth-tab').forEach((el,i) => el.classList.toggle('active', (t==='login'&&i===0)||(t==='signup'&&i===1)));
            document.getElementById('loginForm').classList.toggle('active', t==='login');
            document.getElementById('signupForm').classList.toggle('active', t==='signup');
            hideMsg();
        }
        
        function showError(m) { 
            document.getElementById('authError').textContent=m; 
            document.getElementById('authError').style.display='block'; 
            document.getElementById('authSuccess').style.display='none'; 
        }
        
        function showSuccess(m) { 
            document.getElementById('authSuccess').textContent=m; 
            document.getElementById('authSuccess').style.display='block'; 
            document.getElementById('authError').style.display='none'; 
        }
        
        function hideMsg() { 
            document.getElementById('authError').style.display='none'; 
            document.getElementById('authSuccess').style.display='none'; 
        }

        async function handleSignup(e) {
    e.preventDefault();
    const name = document.getElementById('signupName').value.trim();
    const email = document.getElementById('signupEmail').value.trim().toLowerCase();
    const pass = document.getElementById('signupPassword').value;
    
    if (!name) {
        showError('‚ùå Digite seu nome!');
        return;
    }
    
    if (pass.length < 6) { 
        showError('‚ùå Senha deve ter no m√≠nimo 6 caracteres!'); 
        return; 
    }
    
    const btn = document.getElementById('signupBtn');
    btn.disabled = true;
    btn.textContent = 'Criando...';
    
    try {
        const { data: existing } = await supabase.from('users').select('email').eq('email', email).maybeSingle();
        
        if (existing) {
            showError('‚ùå Email j√° cadastrado!');
            btn.disabled = false;
            btn.textContent = 'üéÅ Come√ßar Trial Gr√°tis';
            return;
        }
        
        const trialEndDate = new Date();
        trialEndDate.setDate(trialEndDate.getDate() + 14);
        
        const userData = {
            email: email,
            name: name,
            password: pass,
            trial_end: trialEndDate.toISOString().split('T')[0],
            subscription_status: 'trial',
            xp: 0,
            level: 1,
            streak: 0,
            last_activity: new Date().toISOString().split('T')[0],
            paper_saved: 0,
            achievements: []
        };
        
        const { data: newUser, error } = await supabase.from('users').insert([userData]).select().single();
        
        if (error) throw error;
        
        showSuccess('‚úÖ Conta criada! Entrando...');
        setTimeout(() => loginUser(newUser), 1000);
        
    } catch (err) {
        console.error('Erro:', err);
        showError('‚ùå ' + (err.message || 'Erro ao criar conta'));
        btn.disabled = false;
        btn.textContent = 'üéÅ Come√ßar Trial Gr√°tis';
    }
}

        function setupPWAInstall() {
    console.log('üöÄ Iniciando setup PWA...');
    
    // Registrar Service Worker
    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('/sw.js')
            .then(reg => {
                console.log('‚úÖ Service Worker registrado:', reg);
                try {
                    reg.update();
                    document.addEventListener('visibilitychange', () => { if (document.visibilityState === 'visible') reg.update(); });
                    navigator.serviceWorker.addEventListener('controllerchange', () => { window.location.reload(); });
                    navigator.serviceWorker.addEventListener('message', (e) => { if (e.data && e.data.type === 'SW_ACTIVATED') { reg.update(); } });
                } catch (_) {}
            })
            .catch(err => {
                console.error('‚ùå Erro no Service Worker:', err);
            });
    }
    
    // Detectar evento de instala√ß√£o
    window.addEventListener('beforeinstallprompt', (e) => {
        console.log('üéâ Evento beforeinstallprompt disparado!');
        e.preventDefault();
        deferredPrompt = e;
        
        const btn = document.getElementById('installBtn');
        if (btn) {
            btn.style.display = 'block';
            console.log('‚úÖ Bot√£o de instala√ß√£o exibido!');
        }
    });
    
    // Ap√≥s instala√ß√£o
    window.addEventListener('appinstalled', () => {
        console.log('‚úÖ App instalado com sucesso!');
        const btn = document.getElementById('installBtn');
        if (btn) btn.style.display = 'none';
        deferredPrompt = null;
    });
    
    // Clique no bot√£o
    const btn = document.getElementById('installBtn');
    if (btn) {
        btn.addEventListener('click', async () => {
            console.log('üëÜ Bot√£o de instala√ß√£o clicado!');
            const isIOS = /iphone|ipad|ipod/i.test(navigator.userAgent);
            const isStandalone = window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone === true;
            if (!deferredPrompt) {
                if (isIOS && !isStandalone) {
                    const g = document.getElementById('installGuide');
                    if (g) g.style.display = 'flex';
                    return;
                }
                alert('Instala√ß√£o n√£o dispon√≠vel neste navegador. Tente pelo Chrome ou Edge.');
                return;
            }
            btn.disabled = true;
            btn.textContent = 'Instalando...';
            try {
                await deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                console.log('Resultado da instala√ß√£o:', outcome);
                deferredPrompt = null;
                btn.style.display = 'none';
            } catch (err) {
                console.error('‚ùå Erro ao instalar:', err);
                alert('‚ùå Erro ao instalar o app');
            } finally {
                btn.disabled = false;
                btn.textContent = 'Instalar agora';
            }
        });
    }
    
    // Detectar modo instalado e exibir bot√£o quando n√£o instalado (inclui iOS)
    const isIOS = /iphone|ipad|ipod/i.test(navigator.userAgent);
    const isStandalone = window.matchMedia('(display-mode: standalone)').matches || 
                        window.navigator.standalone === true;
    const btnInit = document.getElementById('installBtn');
    if (btnInit) btnInit.style.display = isStandalone ? 'none' : 'block';
    const close = document.getElementById('closeInstallGuide');
    if (close) close.addEventListener('click', () => { const g = document.getElementById('installGuide'); if (g) g.style.display = 'none'; });

}

        async function handleLogin(e) {
    e.preventDefault();
    const email = document.getElementById('loginEmail').value.trim().toLowerCase();
    const pass = document.getElementById('loginPassword').value;
    
    const btn = document.getElementById('loginBtn');
    btn.disabled = true;
    btn.textContent = 'Entrando...';
    
    try {
        const isDev = ['localhost','127.0.0.1'].includes(window.location.hostname);
        if (isDev && email === 'admin@local' && pass === 'admin123') {
            const adminUser = {
                email,
                name: 'Administrador',
                subscription_status: 'admin',
                xp: 0,
                level: 99,
                streak: 0,
                last_activity: new Date().toISOString().split('T')[0],
                paper_saved: 0
            };
            loginUser(adminUser);
            trackAdminEvent('login', { plan: 'admin', dev: true });
            btn.disabled = false;
            btn.textContent = 'Entrar';
            return;
        }
        const { data: user, error } = await supabase
            .rpc('verify_login', { user_email: email, user_password: pass })
            .single();
        if (error || !user) {
            showError('‚ùå Email ou senha incorretos!');
            btn.disabled = false;
            btn.textContent = 'Entrar';
            return;
        }
        loginUser(user);
        trackAdminEvent('login', { plan: user.subscription_status });
        
    } catch (err) {
        console.error('Erro:', err);
        showError('‚ùå Erro ao fazer login');
        btn.disabled = false;
        btn.textContent = 'Entrar';
    }
}

        function checkSubscriptionStatus(user) {
            const today = new Date().toISOString().split('T')[0];
            const trialEnd = user.trial_end;
            const status = user.subscription_status;
            const navBtn = document.getElementById('subscribeNavBtn');
            
            if (status === 'admin') {
                document.getElementById('trialBanner').style.display = 'none';
                document.getElementById('paywallOverlay').classList.remove('active');
                if (navBtn) navBtn.style.display = 'none';
                return true;
            }
            
            if (status === 'active') {
                document.getElementById('trialBanner').style.display = 'none';
                document.getElementById('paywallOverlay').classList.remove('active');
                if (navBtn) navBtn.style.display = 'none';
                return true;
            }
            
            if (status === 'trial' && trialEnd) {
                const daysLeft = Math.ceil((new Date(trialEnd) - new Date(today)) / (1000 * 60 * 60 * 24));
                if (daysLeft <= 0) {
                    document.getElementById('paywallOverlay').classList.add('active');
                    if (navBtn) navBtn.style.display = 'inline-block';
                    return false;
                }
                if (daysLeft <= 2) {
                    const banner = document.getElementById('trialBanner');
                    banner.innerHTML = `üî• √öLTIMO DIA! <button class="btn-nav" style="margin-left:.5rem" onclick="redirectToStripe()">Assine agora</button>`;
                    banner.className = 'trial-banner danger';
                    banner.style.display = 'block';
                    banner.onclick = redirectToStripe;
                    if (navBtn) navBtn.style.display = 'inline-block';
                } else if (daysLeft <= 5) {
                    const banner = document.getElementById('trialBanner');
                    banner.innerHTML = `‚è∞ ${daysLeft} dias restantes ‚Ä¢ <button class="btn-nav" onclick="redirectToStripe()">Assine agora</button>`;
                    banner.className = 'trial-banner warning';
                    banner.style.display = 'block';
                    banner.onclick = redirectToStripe;
                    if (navBtn) navBtn.style.display = 'inline-block';
                }
                return true;
            }
            document.getElementById('paywallOverlay').classList.add('active');
            if (navBtn) navBtn.style.display = 'inline-block';
            return false;
        }

        async function loginUser(user) {
            currentUser = user;
            if (!checkSubscriptionStatus(user)) return;
            
            await updateStreak();
            
            const { data: userPlanners } = await supabase.from('planners').select('*').eq('user_email', user.email);
            planners = userPlanners || [];
            
            document.getElementById('authContainer').style.display = 'none';
            document.getElementById('appContainer').classList.add('active');
            document.getElementById('userName').textContent = user.name.split(' ')[0];
            
            updateGamification();
            updateEcoStats();
            renderPlanners();
            renderAchievements();
            renderCharts();
            saveSession(user);
            syncOfflineTasks();
            renderCalendar();
            renderTutoriais();
            updateGoogleCalendarUrl();
            connectGoogleCalendarAuto();
            autoConnectCalendarOnLogin();
        }

        async function updateStreak() {
            const today = new Date().toISOString().split('T')[0];
            const lastActivity = currentUser.last_activity;
            
            if (lastActivity !== today) {
                const yesterday = new Date();
                yesterday.setDate(yesterday.getDate() - 1);
                const yesterdayStr = yesterday.toISOString().split('T')[0];
                
                let newStreak = currentUser.streak || 0;
                if (lastActivity === yesterdayStr) {
                    newStreak++;
                } else if (lastActivity !== today) {
                    newStreak = 1;
                }
                
                await supabase.from('users').update({ 
                    streak: newStreak, 
                    last_activity: today 
                }).eq('email', currentUser.email);
                
                currentUser.streak = newStreak;
            }
        }

        async function addXP(amount) {
            const newXP = (currentUser.xp || 0) + amount;
            const currentLevel = currentUser.level || 1;
            const xpForNextLevel = currentLevel * 100;
            
            let newLevel = currentLevel;
            let finalXP = newXP;
            
            if (newXP >= xpForNextLevel) {
                newLevel++;
                finalXP = newXP - xpForNextLevel;
                showLevelUp(newLevel);
                checkAchievements();
            }
            
            await supabase.from('users').update({ xp: finalXP, level: newLevel }).eq('email', currentUser.email);
            currentUser.xp = finalXP;
            currentUser.level = newLevel;
            updateGamification();
        }

        function showLevelUp(level) {
            document.getElementById('newLevel').textContent = level;
            document.getElementById('levelUpModal').classList.add('active');
            createConfetti();
        }

        function closeLevelUp() {
            document.getElementById('levelUpModal').classList.remove('active');
        }

        function createConfetti() {
            const colors = ['#EC4899', '#6B46C1', '#10B981', '#F59E0B', '#3B82F6'];
            for (let i = 0; i < 50; i++) {
                setTimeout(() => {
                    const confetti = document.createElement('div');
                    confetti.className = 'confetti';
                    confetti.style.left = Math.random() * 100 + '%';
                    confetti.style.background = colors[Math.floor(Math.random() * colors.length)];
                    confetti.style.animation = `confetti ${2 + Math.random() * 2}s linear forwards`;
                    document.body.appendChild(confetti);
                    setTimeout(() => confetti.remove(), 4000);
                }, i * 30);
            }
        }

        function updateGamification() {
            const level = currentUser.level || 1;
            const xp = currentUser.xp || 0;
            const streak = currentUser.streak || 0;
            const xpForNextLevel = level * 100;
            const xpPercent = (xp / xpForNextLevel) * 100;
            
            document.getElementById('levelBadge').textContent = `‚≠ê ${tr('badgeLevel')} ${level}`;
            document.getElementById('streakBadge').textContent = `üî• ${streak} ${tr('badgeDays')}`;
            document.getElementById('statLevel').textContent = level;
            document.getElementById('statStreak').textContent = streak;
            document.getElementById('xpBar').style.width = xpPercent + '%';
            document.getElementById('xpBar').textContent = `${xp}/${xpForNextLevel} XP`;
        }

        async function updateEcoStats() {
            const paperSaved = currentUser.paper_saved || 0;
            const treesSaved = Math.floor(paperSaved / 10000);
            
            document.getElementById('paperSaved').textContent = paperSaved.toLocaleString('pt-BR');
            document.getElementById('treesSaved').textContent = treesSaved;
        }

        async function incrementPaperSaved(pages = 1) {
            const newPaperSaved = (currentUser.paper_saved || 0) + pages;
            await supabase.from('users').update({ paper_saved: newPaperSaved }).eq('email', currentUser.email);
            currentUser.paper_saved = newPaperSaved;
            updateEcoStats();
        }

        async function checkAchievements() {
            const { data: tarefas } = await supabase.from('tarefas').select('*').in('planner_id', planners.map(p => p.id));
            const completed = tarefas?.filter(t => t.done).length || 0;
            
            const unlockedAchievements = [];
            if (completed >= 1) unlockedAchievements.push('first_task');
            if (completed >= 10) unlockedAchievements.push('task_master');
            if (completed >= 100) unlockedAchievements.push('century');
            if (currentUser.streak >= 7) unlockedAchievements.push('week_streak');
            if (currentUser.streak >= 30) unlockedAchievements.push('month_streak');
            if (currentUser.level >= 10) unlockedAchievements.push('level_10');
            if (planners.length >= 5) unlockedAchievements.push('planner_pro');
            
            await supabase.from('users').update({ 
                achievements: unlockedAchievements 
            }).eq('email', currentUser.email);
            
            currentUser.achievements = unlockedAchievements;
        }

        function renderAchievements() {
            const userAchievements = currentUser.achievements || [];
            const html = achievements.map(a => {
                const unlocked = userAchievements.includes(a.id);
                return `
                    <div class="achievement ${unlocked ? '' : 'locked'}">
                        <div class="achievement-icon">${a.icon}</div>
                        <div class="achievement-name">${a.name}</div>
                    </div>
                `;
            }).join('');
            document.getElementById('achievementsList').innerHTML = html;
        }

        async function renderCharts() {
            const { data: tarefas } = await supabase.from('tarefas').select('*').in('planner_id', planners.map(p => p.id));
            if (!tarefas || tarefas.length === 0) {
                document.getElementById('statCompleted').textContent = 0;
                document.getElementById('statRate').textContent = '0%';
                return;
            }
            
            const completed = tarefas.filter(t => t.done).length;
            const total = tarefas.length;
            const rate = total > 0 ? Math.round((completed / total) * 100) : 0;
            
            document.getElementById('statCompleted').textContent = completed;
            document.getElementById('statRate').textContent = rate + '%';
            
            const last7Days = [];
            for (let i = 6; i >= 0; i--) {
                const d = new Date();
                d.setDate(d.getDate() - i);
                last7Days.push(d.toISOString().split('T')[0]);
            }
            
            const weeklyData = last7Days.map(date => {
                return tarefas.filter(t => t.done && t.data === date).length;
            });
            
            new Chart(document.getElementById('weeklyChart'), {
                type: 'line',
                data: {
                    labels: last7Days.map(d => new Date(d).toLocaleDateString(getLocale(), {weekday:'short'})),
                    datasets: [{
                        label: tr('chartWeeklyDataset'),
                        data: weeklyData,
                        borderColor: '#6B46C1',
                        backgroundColor: 'rgba(107, 70, 193, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: { responsive: true, maintainAspectRatio: true }
            });
            
            const prioData = {
                alta: tarefas.filter(t => t.prioridade === 'alta' || t.prioridade === 'urgente' || t.prioridade === 'critica').length,
                media: tarefas.filter(t => t.prioridade === 'media').length,
                baixa: tarefas.filter(t => t.prioridade === 'baixa').length
            };
            
            new Chart(document.getElementById('priorityChart'), {
                type: 'doughnut',
                data: {
                    labels: [tr('prioHigh'), tr('prioMedium'), tr('prioLow')],
                    datasets: [{
                        data: [prioData.alta, prioData.media, prioData.baixa],
                        backgroundColor: ['#EF4444', '#F59E0B', '#10B981']
                    }]
                },
                options: { responsive: true, maintainAspectRatio: true }
            });
        }

        function redirectToStripe() {
            window.open(`${STRIPE_LINK}?client_reference_id=${currentUser.email}`, '_blank');
        }

        function logout() {
            currentUser = null;
            planners = [];
            document.getElementById('appContainer').classList.remove('active');
            document.getElementById('authContainer').style.display = 'flex';
            document.getElementById('paywallOverlay').classList.remove('active');
            showAuthTab('login');
        }

        function openTab(tab) {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            const tabs = ['planners', 'biblioteca', 'tutoriais', 'stats', 'achievements', 'calendar', 'google'];
            const index = tabs.indexOf(tab);
            if (index !== -1) {
                document.querySelectorAll('.tab-btn')[index].classList.add('active');
                document.getElementById(tab + 'Tab').classList.add('active');
                
                if (tab === 'stats') renderCharts();
                if (tab === 'achievements') renderAchievements();
                if (tab === 'calendar') renderCalendar();
            }
        }

        async function renderPlanners() {
            const c = document.getElementById('meusPlanners');
            const biblioPlannersEl = document.getElementById('meusPlannersBiblioteca');
            
            if (!planners.length) {
                c.innerHTML = `<p style="text-align:center;color:#999;">${tr('msgFirstPlanner')}</p>`;
                if (biblioPlannersEl) biblioPlannersEl.innerHTML = `<p style="text-align:center;color:#999;">${tr('msgNoLibraryPlanners')}</p>`;
                return;
            }
            
            // Separar planners normais dos da biblioteca
            const plannersNormais = planners.filter(p => ['todo', 'projeto', 'habitos', 'financeiro'].includes(p.tipo));
            const plannersBiblioteca = planners.filter(p => !['todo', 'projeto', 'habitos', 'financeiro'].includes(p.tipo));
            
            // Renderizar planners normais
            if (plannersNormais.length === 0) {
                c.innerHTML = `<p style="text-align:center;color:#999;">${tr('msgFirstPlanner')}</p>`;
            } else {
                const htmlNormais = await Promise.all(plannersNormais.map(async p => {
                    let numServer = 0;
                    try {
                        const { data: tarefas } = await supabase.from('tarefas').select('*').eq('planner_id', p.id);
                        numServer = tarefas?.length || 0;
                    } catch (_) {}
                    const numOffline = getOfflineTasks().filter(t => t.planner_id === p.id).length;
                    const numTarefas = numServer + numOffline;
                    return `
                        <div class="planner-item" style="background:linear-gradient(135deg,${tipos[p.tipo]?.cor || '#6B46C1'},${tipos[p.tipo]?.cor || '#6B46C1'}dd);">
                            <div class="planner-item-nome">${tipos[p.tipo]?.icone || 'üìã'} ${p.nome}</div>
                            <div class="planner-item-info">${numTarefas} tarefa${numTarefas !== 1 ? 's' : ''}</div>
                            <div class="planner-item-acoes">
                                <button onclick="abrirPlanner(${p.id})">Abrir</button>
                                <button onclick="deletarPlanner(${p.id})">Deletar</button>
                            </div>
                        </div>
                    `;
                }));
                c.innerHTML = htmlNormais.join('');
            }
            
            // Renderizar planners da biblioteca
            if (biblioPlannersEl) {
                if (plannersBiblioteca.length === 0) {
                    biblioPlannersEl.innerHTML = `<p style="text-align:center;color:#999;">${tr('msgNoLibraryPlanners')}</p>`;
                } else {
                    const htmlBiblioteca = await Promise.all(plannersBiblioteca.map(async p => {
                        let numServer = 0;
                        try {
                            const { data: tarefas } = await supabase.from('tarefas').select('*').eq('planner_id', p.id);
                            numServer = tarefas?.length || 0;
                        } catch (_) {}
                        const numOffline = getOfflineTasks().filter(t => t.planner_id === p.id).length;
                        const numTarefas = numServer + numOffline;
                        return `
                            <div class="planner-item" style="background:linear-gradient(135deg,${tipos[p.tipo]?.cor || '#6B46C1'},${tipos[p.tipo]?.cor || '#6B46C1'}dd);">
                                <div class="planner-item-nome">${tipos[p.tipo]?.icone || 'üìã'} ${p.nome}</div>
                                <div class="planner-item-info">${numTarefas} tarefa${numTarefas !== 1 ? 's' : ''}</div>
                                <div class="planner-item-acoes">
                                    <button onclick="abrirPlanner(${p.id})">Abrir</button>
                                    <button onclick="deletarPlanner(${p.id})">Deletar</button>
                                </div>
                            </div>
                        `;
                    }));
                    biblioPlannersEl.innerHTML = htmlBiblioteca.join('');
                }
            }
        }

        async function criarPlannerBiblioteca(tipo) {
            const nomes = {
                'diario': 'Meu Planner Di√°rio 2024',
                'semanal': 'Planejamento Semanal 2024',
                'mensal': 'Vis√£o Mensal 2024',
                'anual': 'Metas Anuais 2024',
                'financeiro_biblio': 'Controle Financeiro Pessoal',
                'saude': 'Jornada de Sa√∫de & Bem-estar',
                'leitura': 'Lista de Leitura 2024',
                'viagem': 'Minhas Viagens',
                'metas': 'Metas & Objetivos 2024',
                'habitos_biblio': 'Tracker de H√°bitos Di√°rios'
            };
            
            const nomeDefault = nomes[tipo] || 'Novo Planner';
            
            try {
                const { data: newPlanner, error } = await supabase.from('planners').insert([{
                    user_email: currentUser.email,
                    tipo: tipo,
                    nome: nomeDefault
                }]).select().single();
                
                if (error) throw error;
                
                planners.push(newPlanner);
                await addXP(50);
                await incrementPaperSaved(20); // Biblioteca economiza mais p√°ginas
                
                renderPlanners();
                
                // Abrir automaticamente ap√≥s criar
                setTimeout(() => abrirPlanner(newPlanner.id), 300);
                
                alert(`‚úÖ ${tipos[tipo].nome} criado com sucesso! +50 XP`);
            } catch (err) {
                console.error('Erro:', err);
                alert('‚ùå Erro ao criar planner da biblioteca');
            }
        }

        function criarPlanner(tipo) {
            tipoAtual = tipo;
            const t = tipos[tipo];
            document.getElementById('modalIcone').textContent = t.icone;
            document.getElementById('modalTitulo').textContent = 'Novo ' + t.nome;
            document.getElementById('inputNome').value = '';
            document.getElementById('modalCriar').style.display = 'block';
        }

        async function salvarPlanner() {
            const nome = document.getElementById('inputNome').value.trim();
            if (!nome) { alert('‚ùå Digite um nome!'); return; }
            
            try {
                const { data: newPlanner, error } = await supabase.from('planners').insert([{
                    user_email: currentUser.email,
                    tipo: tipoAtual,
                    nome: nome
                }]).select().single();
                
                if (error) throw error;
                planners.push(newPlanner);
                fecharModal('modalCriar');
                renderPlanners();
                await addXP(50);
                await incrementPaperSaved(10);
            } catch (err) {
                console.error('Erro:', err);
                alert('‚ùå Erro ao criar');
            }
        }

        async function abrirPlanner(id) {
            const p = planners.find(x => x.id === id);
            if (!p) return;
            
            plannerAberto = id;
            document.getElementById('verIcone').textContent = tipos[p.tipo]?.icone || 'üìã';
            document.getElementById('verNome').textContent = p.nome;
            
            let tarefasServer = [];
            try {
                if (navigator.onLine) {
                    const { data } = await supabase.from('tarefas').select('*').eq('planner_id', id).order('id');
                    tarefasServer = data || [];
                }
            } catch (_) {}
            const offlineAll = getOfflineTasks();
            const merged = [...tarefasServer, ...offlineAll.filter(t => t.planner_id === id)];
            tarefasCache = merged;
            renderTarefas(merged);
            try { scheduleTaskAlarms(); } catch (_) {}
            document.getElementById('modalVer').style.display = 'block';
        }

        function switchView(view) {
            currentView = view;
            document.querySelectorAll('.view-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('#modalVer .tab-content').forEach(content => content.classList.remove('active'));
            
            if (view === 'list') {
                document.querySelector('.view-btn:nth-child(1)').classList.add('active');
                document.getElementById('listView').classList.add('active');
            } else if (view === 'kanban') {
                document.querySelector('.view-btn:nth-child(2)').classList.add('active');
                document.getElementById('kanbanView').classList.add('active');
                renderKanban();
            } else if (view === 'timeline') {
                document.querySelector('.view-btn:nth-child(3)').classList.add('active');
                document.getElementById('timelineView').classList.add('active');
                renderTimeline();
            }
        }

        async function renderTarefas(tarefas) {
            const c = document.getElementById('listaTarefas');
            if (!tarefas.length) {
                c.innerHTML = `<p style="text-align:center;color:#999;">${tr('msgNoTasks')}</p>`;
                return;
            }
            tarefasCache = tarefas;
            
            const prioIcons = {
                'baixa': 'üü¢',
                'media': 'üü°',
                'alta': 'üî¥',
                'urgente': 'üî•',
                'critica': '‚ö°'
            };
            
            c.innerHTML = tarefas.map(t => {
                const data = t.data ? formatDateBR(t.data) : '';
                const hora = t.hora || '';
                const descricao = t.descricao ? t.descricao.substring(0, 80) + '...' : '';
                
                return `
                    <div class="tarefa-item">
                        <div class="tarefa-header">
                            <input type="checkbox" class="tarefa-checkbox" ${t.done ? 'checked' : ''} onchange="toggleTarefa('${t.id}')">
                            <div class="tarefa-conteudo" onclick="abrirDetalheTarefa('${t.id}')">
                                <div class="tarefa-titulo" style="${t.done ? 'text-decoration:line-through;opacity:0.6;' : ''}">${prioIcons[t.prioridade] || 'üìå'} ${t.titulo}</div>
                                ${descricao ? `<div class="tarefa-descricao">${descricao}</div>` : ''}
                                <div class="tarefa-meta">
                                    ${data ? `<span class="tarefa-meta-item">üìÖ ${data}${hora ? ' ' + hora : ''}</span>` : ''}
                                    ${t.categoria ? `<span class="tarefa-meta-item">${getCategoriaIcon(t.categoria)} ${t.categoria}</span>` : ''}
                                    ${t.duracao ? `<span class="tarefa-meta-item">‚è±Ô∏è ${t.duracao}min</span>` : ''}
                                </div>
                            </div>
                        </div>
                        <div class="tarefa-actions">
                            <button class="btn-icon btn-del" onclick="deletarTarefa('${t.id}')">üóëÔ∏è</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function getCategoriaIcon(cat) {
            const icons = {
                'trabalho': 'üíº',
                'pessoal': 'üè†',
                'saude': 'üí™',
                'estudos': 'üìö',
                'financeiro': 'üí∞',
                'outro': 'üìå'
            };
            return icons[cat] || 'üìå';
        }

        function abrirDetalheTarefa(id) {
            let t = tarefasCache.find(x => String(x.id) === String(id));
            if (!t && navigator.onLine && !String(id).startsWith('local-')) {
                const realId = typeof id === 'string' ? Number(id) : id;
                supabase.from('tarefas').select('*').eq('id', realId).single().then(({ data }) => {
                    if (data) { t = data; renderDetalheTarefa(t); }
                });
            } else {
                renderDetalheTarefa(t);
            }
        }
        function renderDetalheTarefa(t) {
            if (!t) return;
            document.getElementById('tarefaDetalheTitulo').textContent = t.titulo || 'Tarefa';
            const info = [
                t.descricao ? `<div style="margin:.3rem 0;">${t.descricao}</div>` : '',
                t.categoria ? `<div class="tarefa-meta-item" style="display:inline-block;margin:.2rem 0;">${getCategoriaIcon(t.categoria)} ${t.categoria}</div>` : '',
                t.prioridade ? `<div class="tarefa-meta-item" style="display:inline-block;margin:.2rem 0;">Prioridade: ${t.prioridade}</div>` : '',
                t.data ? `<div class="tarefa-meta-item" style="display:inline-block;margin:.2rem 0;">Data: ${formatDateBR(t.data)} ${t.hora || ''}</div>` : '',
                t.duracao ? `<div class="tarefa-meta-item" style="display:inline-block;margin:.2rem 0;">Dura√ß√£o: ${t.duracao}min</div>` : '',
                t.repetir ? `<div class="tarefa-meta-item" style="display:inline-block;margin:.2rem 0;">Repetir: ${t.repetir}</div>` : '',
                t.contexto ? `<div class="tarefa-meta-item" style="display:inline-block;margin:.2rem 0;">Contexto: ${t.contexto}</div>` : '',
                t.energia ? `<div class="tarefa-meta-item" style="display:inline-block;margin:.2rem 0;">Energia: ${t.energia}</div>` : ''
            ].join('');
            const tags = (t.tags || []).length ? `<div style="margin-top:.5rem;"><strong>Tags:</strong> ${(t.tags||[]).join(', ')}</div>` : '';
            const lembretes = (t.lembretes || []).length ? `<div style="margin-top:.5rem;"><strong>Lembretes:</strong> ${(t.lembretes||[]).join(', ')}</div>` : '';
            const subtarefas = (t.subtarefas || []).length ? `<div style="margin-top:.5rem;"><strong>Subtarefas:</strong><ul style="margin:.4rem 0 0 1rem;">${(t.subtarefas||[]).map(s=>`<li>${s}</li>`).join('')}</ul></div>` : '';
            const anexos = (t.anexos || []).length ? `<div style="margin-top:.5rem;"><strong>Anexos:</strong><ul style="margin:.4rem 0 0 1rem;">${(t.anexos||[]).map(a=>`<li><a href=\"${a}\" target=\"_blank\">${a}</a></li>`).join('')}</ul></div>` : '';
            document.getElementById('tarefaDetalheConteudo').innerHTML = info + tags + lembretes + subtarefas + anexos;
            document.getElementById('modalTarefaDetalhe').style.display = 'block';
        }

        async function renderKanban() {
            let tarefas = [];
            try {
                if (navigator.onLine) {
                    const { data } = await supabase.from('tarefas').select('*').eq('planner_id', plannerAberto);
                    tarefas = data || [];
                }
            } catch (_) {}
            const offlineAll = getOfflineTasks();
            tarefas = [...tarefas, ...offlineAll.filter(t => t.planner_id === plannerAberto)];
            if (!tarefas) return;
            
            const todo = tarefas.filter(t => !t.done && !t.em_progresso);
            const progress = tarefas.filter(t => !t.done && t.em_progresso);
            const done = tarefas.filter(t => t.done);
            
            document.getElementById('kanbanTodo').innerHTML = renderKanbanCards(todo);
            document.getElementById('kanbanProgress').innerHTML = renderKanbanCards(progress);
            document.getElementById('kanbanDone').innerHTML = renderKanbanCards(done);
        }

        function renderKanbanCards(tarefas) {
            if (!tarefas.length) return `<p style="color:#999;font-size:0.85em;">${tr('msgNoTasksShort')}</p>`;
            
            return tarefas.map(t => `
                <div class="kanban-card" onclick="abrirDetalheTarefa('${t.id}')">
                    <div style="font-weight:700; margin-bottom:0.5rem;">${t.titulo}</div>
                    <div style="font-size:0.85em; color:#666;">${t.data ? formatDateBR(t.data) : tr('noDate')}</div>
                </div>
            `).join('');
        }

        function requestNotifications() {
            try { if ('Notification' in window && Notification.permission === 'default') Notification.requestPermission(); } catch (_) {}
        }
        function playAlarm() {
            try {
                const ctx = new (window.AudioContext || window.webkitAudioContext)();
                const g = ctx.createGain();
                g.connect(ctx.destination);
                let count = 0;
                const beep = () => {
                    const o = ctx.createOscillator();
                    o.type = 'square';
                    o.frequency.setValueAtTime(1200, ctx.currentTime);
                    o.connect(g);
                    g.gain.setValueAtTime(0.001, ctx.currentTime);
                    g.gain.exponentialRampToValueAtTime(0.8, ctx.currentTime + 0.05);
                    o.start();
                    setTimeout(()=>{ g.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.3); o.stop(ctx.currentTime + 0.35); }, 300);
                };
                const iv = setInterval(() => {
                    beep();
                    try { navigator.vibrate([300,150,300]); } catch(_){}
                    count++;
                    if (count >= 20) clearInterval(iv);
                }, 800);
            } catch (_) {}
        }
        async function scheduleTaskAlarms() {
            alarmTimers.forEach(t=>clearTimeout(t));
            alarmTimers = [];
            requestNotifications();
            const now = Date.now();
            const soon = 7*24*60*60*1000;
            const reg = 'serviceWorker' in navigator ? await navigator.serviceWorker.getRegistration() : null;
            for (const t of tarefasCache) {
                if (!t.data || !t.hora) continue;
                const ts = new Date(`${t.data}T${t.hora}:00`).getTime();
                if (isNaN(ts)) continue;
                const delay = ts - now;
                if (delay < 0 || delay > soon) continue;
                if (reg && 'showNotification' in reg && 'Notification' in window) {
                    try {
                        if (Notification.permission === 'granted' && 'showTrigger' in Notification) {
                            reg.showNotification(`Tarefa: ${t.titulo}`, { body: 'Hora de fazer', tag: `task-${t.id}`, showTrigger: new TimestampTrigger(ts) });
                            continue;
                        }
                    } catch (_) {}
                }
                const timer = setTimeout(() => { playAlarm(); try { if (Notification.permission === 'granted') new Notification(`Tarefa: ${t.titulo}`, { body: 'Hora de fazer' }); } catch(_){} }, delay);
                alarmTimers.push(timer);
            }
        }

        async function renderTimeline() {
            let tarefas = [];
            try {
                if (navigator.onLine) {
                    const { data } = await supabase.from('tarefas').select('*').eq('planner_id', plannerAberto).order('data');
                    tarefas = data || [];
                }
            } catch (_) {}
            const offlineAll = getOfflineTasks();
            tarefas = [...tarefas, ...offlineAll.filter(t => t.planner_id === plannerAberto)];
            if (!tarefas || !tarefas.length) {
                document.getElementById('timelineContainer').innerHTML = `<p style="text-align:center;color:#999;">${tr('msgNoTasksShort')}</p>`;
                return;
            }
            
            const grouped = {};
            tarefas.forEach(t => {
                const date = t.data ? formatDateBR(t.data) : 'Sem data';
                if (!grouped[date]) grouped[date] = [];
                grouped[date].push(t);
            });
            
            const html = Object.keys(grouped).map(date => `
                <div class="timeline-item">
                    <div class="timeline-date">${date}</div>
                    <div class="timeline-content">
                        ${grouped[date].map(t => `<div style=\"margin-bottom:0.5rem;\"><strong onclick=\"abrirDetalheTarefa('${t.id}')\">${t.titulo}</strong>${t.hora ? ' - ' + t.hora : ''}</div>`).join('')}
                    </div>
                </div>
            `).join('');
            
            document.getElementById('timelineContainer').innerHTML = html;
        }

        function abrirModalNovaTarefa() {
            tempTags = [];
            tempLembretes = [];
            tempSubtarefas = [];
            tempAnexos = [];
            
            document.getElementById('novaTarefaTitulo').value = '';
            document.getElementById('novaTarefaDescricao').value = '';
            document.getElementById('novaTarefaData').value = new Date().toISOString().split('T')[0];
            document.getElementById('novaTarefaHora').value = '';
            document.getElementById('novaTarefaDuracao').value = '';
            
            renderTags();
            renderLembretes();
            renderSubtarefas();
            renderAnexos();
            
            document.getElementById('modalNovaTarefa').style.display = 'block';
        }

        async function salvarNovaTarefa() {
            const titulo = document.getElementById('novaTarefaTitulo').value.trim();
            if (!titulo) { alert('‚ùå Digite o t√≠tulo da tarefa!'); return; }
            
            const descricao = document.getElementById('novaTarefaDescricao').value.trim();
            const categoria = document.getElementById('novaTarefaCategoria').value;
            const prioridade = document.getElementById('novaTarefaPrioridade').value;
            const data = document.getElementById('novaTarefaData').value;
            const hora = document.getElementById('novaTarefaHora').value;
            const duracao = parseInt(document.getElementById('novaTarefaDuracao').value) || null;
            const repetir = document.getElementById('novaTarefaRepetir').value;
            const contexto = document.getElementById('novaTarefaContexto').value;
            const energia = document.getElementById('novaTarefaEnergia').value;
            
            try {
                const novaTarefa = {
                    planner_id: plannerAberto,
                    titulo,
                    descricao,
                    categoria,
                    prioridade,
                    data,
                    hora,
                    duracao,
                    repetir,
                    contexto,
                    energia,
                    tags: tempTags,
                    lembretes: tempLembretes,
                    subtarefas: tempSubtarefas,
                    anexos: tempAnexos,
                    done: false,
                    em_progresso: false
                };
                
                let insertedOnline = false;
                if (navigator.onLine) {
                    const { error } = await supabase.from('tarefas').insert([novaTarefa]);
                    if (!error) insertedOnline = true;
                }
                if (!insertedOnline) {
                    const localId = 'local-' + Date.now() + '-' + Math.random().toString(36).slice(2);
                    addOfflineTask({ ...novaTarefa, id: localId });
                }
                
                trackAdminEvent('task_created', { priority: prioridade, online: insertedOnline });

                fecharModal('modalNovaTarefa');
                await addXP(30);
                await incrementPaperSaved(3);
                abrirPlanner(plannerAberto);
                renderPlanners();
                createCalendarEventForTask(novaTarefa);
            } catch (err) {
                console.error('Erro:', err);
                alert('‚ùå Erro ao criar tarefa');
            }
        }

        async function toggleTarefa(id) {
            try {
                if (String(id).startsWith('local-')) {
                    const arr = getOfflineTasks();
                    const idx = arr.findIndex(x => x.id === id);
                    if (idx >= 0) {
                        arr[idx].done = !arr[idx].done;
                        setOfflineTasks(arr);
                        abrirPlanner(plannerAberto);
                        renderPlanners();
                        return;
                    }
                } else {
                    const realId = typeof id === 'string' ? Number(id) : id;
                    const { data: t } = await supabase.from('tarefas').select('done').eq('id', realId).single();
                    await supabase.from('tarefas').update({ done: !t.done }).eq('id', realId);
                    if (!t.done) {
                        await addXP(20);
                        await incrementPaperSaved(1);
                    }
                    await checkAchievements();
                    abrirPlanner(plannerAberto);
                    renderPlanners();
                }
            } catch (err) {
                console.error('Erro:', err);
            }
        }

        async function deletarTarefa(id) {
            if (!confirm(tr('confirmDeleteTask'))) return;
            try {
                if (String(id).startsWith('local-')) {
                    const arr = getOfflineTasks().filter(x => x.id !== id);
                    setOfflineTasks(arr);
                    abrirPlanner(plannerAberto);
                    renderPlanners();
                } else {
                    const realId = typeof id === 'string' ? Number(id) : id;
                    await supabase.from('tarefas').delete().eq('id', realId);
                    abrirPlanner(plannerAberto);
                    renderPlanners();
                }
            } catch (err) {
                console.error('Erro:', err);
            }
        }

        async function deletarPlanner(id) {
            if (!confirm(tr('confirmDeletePlanner'))) return;
            try {
                await supabase.from('tarefas').delete().eq('planner_id', id);
                await supabase.from('planners').delete().eq('id', id);
                planners = planners.filter(x => x.id !== id);
                renderPlanners();
            } catch (err) {
                console.error('Erro:', err);
            }
        }

        async function renderCalendar() {
            const titleStr = new Date(currentYear, currentMonth, 1).toLocaleDateString(getLocale(), { month: 'long', year: 'numeric' });
            document.getElementById('calendarTitle').textContent = titleStr.charAt(0).toUpperCase() + titleStr.slice(1);
            
            const firstDay = new Date(currentYear, currentMonth, 1).getDay();
            const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
            
            let tarefas = [];
            try {
                if (navigator.onLine) {
                    const { data } = await supabase.from('tarefas').select('*').in('planner_id', planners.map(p => p.id));
                    tarefas = data || [];
                }
            } catch (_) {}
            const offlineAll = getOfflineTasks();
            tarefas = [...tarefas, ...offlineAll];
            
            const week = [];
            for (let i = 0; i < 7; i++) {
                const d = new Date(2024, 0, 7 + i);
                week.push(d.toLocaleDateString(getLocale(), { weekday: 'short' }));
            }
            let html = week.map(w => `<div class="calendar-day-header">${w}</div>`).join('');
            
            for (let i = 0; i < firstDay; i++) {
                html += '<div class="calendar-day"></div>';
            }
            
            for (let day = 1; day <= daysInMonth; day++) {
                const dateStr = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const dayTasks = tarefas?.filter(t => t.data === dateStr) || [];
                
                html += `
                    <div class="calendar-day">
                        <div class="calendar-day-number">${day}</div>
                        ${dayTasks.slice(0, 3).map(t => `<div class="calendar-task" title="${t.titulo}">${t.titulo.substring(0, 15)}</div>`).join('')}
                        ${dayTasks.length > 3 ? `<div style="font-size:0.7em; color:#666;">+${dayTasks.length - 3} ${tr('more')}</div>` : ''}
                    </div>
                `;
            }
            
            document.getElementById('calendarGrid').innerHTML = html;
        }

        function changeMonth(delta) {
            currentMonth += delta;
            if (currentMonth > 11) {
                currentMonth = 0;
                currentYear++;
            } else if (currentMonth < 0) {
                currentMonth = 11;
                currentYear--;
            }
            renderCalendar();
        }

        function renderTutoriais() {
            const html = tutoriaisData.map(t => `
                <div class="tutorial-card" onclick="abrirTutorial('${t.id}')">
                    <div class="tutorial-header">
                        <div class="tutorial-icon">${t.icon}</div>
                        <div>
                            <div class="tutorial-title">${t.title}</div>
                            <div class="tutorial-desc">${t.desc}</div>
                        </div>
                    </div>
                </div>
            `).join('');
            document.getElementById('tutoriaisLista').innerHTML = html;
        }

        function abrirTutorial(id) {
            const tutorial = tutoriaisData.find(t => t.id === id);
            if (!tutorial) return;
            
            document.getElementById('tutorialIcone').textContent = tutorial.icon;
            document.getElementById('tutorialTitulo').textContent = tutorial.title;
            document.getElementById('tutorialConteudo').innerHTML = tutorial.content;
            document.getElementById('modalTutorial').style.display = 'block';
        }

        function abrirBiblioteca(tipo) {
            // Esta fun√ß√£o ainda mostra informa√ß√µes, mas agora tamb√©m sugere criar
            const bibliotecaData = {
                'diario': {
                    icon: 'üìÖ',
                    title: 'P√°ginas Di√°rias',
                    content: `
                        <h3>üìÖ P√°ginas Di√°rias (365 p√°ginas)</h3>
                        <p style="margin:1rem 0;">Cada dia do ano tem uma p√°gina dedicada para voc√™ planejar em detalhes.</p>
                        <h4 style="margin-top:1.5rem;">O que incluir:</h4>
                        <ul style="margin-left:1.5rem;">
                            <li>‚úÖ Lista de tarefas do dia</li>
                            <li>üéØ 3 prioridades principais</li>
                            <li>üíß Rastreamento de √°gua</li>
                            <li>üçé Refei√ß√µes e nutri√ß√£o</li>
                            <li>üìù Reflex√£o e gratid√£o</li>
                            <li>‚è∞ Hor√°rio das atividades</li>
                        </ul>
                        <p style="margin-top:1rem; font-style:italic; color:#666;">üí° Dica: Use este planner para ter total controle do seu dia!</p>
                    `
                },
                'semanal': {
                    icon: 'üìÜ',
                    title: 'P√°ginas Semanais',
                    content: `
                        <h3>üìÜ P√°ginas Semanais (52 p√°ginas)</h3>
                        <p style="margin:1rem 0;">Vis√£o completa de cada semana do ano.</p>
                        <h4 style="margin-top:1.5rem;">Conte√∫do:</h4>
                        <ul style="margin-left:1.5rem;">
                            <li>üìã Objetivos da semana</li>
                            <li>üìÖ Vista de 7 dias</li>
                            <li>üéØ Metas semanais</li>
                            <li>üìä Revis√£o de progresso</li>
                            <li>üí™ H√°bitos a desenvolver</li>
                            <li>üìù Notas e insights</li>
                        </ul>
                        <p style="margin-top:1rem; font-style:italic; color:#666;">üí° Dica: Revise domingo √† noite e planeje a semana!</p>
                    `
                },
                'mensal': {
                    icon: 'üóìÔ∏è',
                    title: 'P√°ginas Mensais',
                    content: `
                        <h3>üóìÔ∏è P√°ginas Mensais (12 p√°ginas)</h3>
                        <p style="margin:1rem 0;">Um m√™s inteiro em uma p√°gina!</p>
                        <h4 style="margin-top:1.5rem;">Inclui:</h4>
                        <ul style="margin-left:1.5rem;">
                            <li>üìÖ Calend√°rio do m√™s</li>
                            <li>üéØ Objetivos mensais</li>
                            <li>üí∞ Or√ßamento e finan√ßas</li>
                            <li>üìä Balan√ßo geral</li>
                            <li>üèÜ Conquistas do m√™s</li>
                            <li>üìà An√°lise de resultados</li>
                        </ul>
                        <p style="margin-top:1rem; font-style:italic; color:#666;">üí° Dica: Fa√ßa uma revis√£o mensal sempre no dia 1!</p>
                    `
                },
                'anual': {
                    icon: 'üìä',
                    title: 'Vis√£o Anual',
                    content: `
                        <h3>üìä Vis√£o Anual (1 p√°gina especial)</h3>
                        <p style="margin:1rem 0;">Planeje o ano completo de uma vez!</p>
                        <h4 style="margin-top:1.5rem;">Componentes:</h4>
                        <ul style="margin-left:1.5rem;">
                            <li>üéØ Metas anuais (pessoal, profissional, sa√∫de)</li>
                            <li>üìÖ 12 meses em vis√£o geral</li>
                            <li>üí∞ Planejamento financeiro anual</li>
                            <li>‚úàÔ∏è Viagens planejadas</li>
                            <li>üéì Cursos e aprendizados</li>
                            <li>üìà Indicadores de progresso</li>
                        </ul>
                        <p style="margin-top:1rem; font-style:italic; color:#666;">üí° Dica: Defina 3-5 metas principais e revise trimestralmente!</p>
                    `
                },
                'financeiro': {
                    icon: 'üí∞',
                    title: 'Planejador Financeiro',
                    content: `
                        <h3>üí∞ Planejador Financeiro Completo</h3>
                        <p style="margin:1rem 0;">Controle total das suas finan√ßas!</p>
                        <h4 style="margin-top:1.5rem;">Recursos:</h4>
                        <ul style="margin-left:1.5rem;">
                            <li>üíµ Rastreamento de receitas</li>
                            <li>üí∏ Controle de despesas por categoria</li>
                            <li>üìä Or√ßamento mensal</li>
                            <li>üéØ Metas de economia</li>
                            <li>üí≥ Gerenciamento de d√≠vidas</li>
                            <li>üìà Investimentos e patrim√¥nio</li>
                            <li>üìù Notas de compras importantes</li>
                        </ul>
                        <p style="margin-top:1rem; font-style:italic; color:#666;">üí° Dica: Atualize diariamente e revise semanalmente!</p>
                    `
                },
                'saude': {
                    icon: 'üí™',
                    title: 'Planejador de Sa√∫de',
                    content: `
                        <h3>üí™ Planejador de Sa√∫de e Bem-estar</h3>
                        <p style="margin:1rem 0;">Cuide do seu corpo e mente!</p>
                        <h4 style="margin-top:1.5rem;">Inclui:</h4>
                        <ul style="margin-left:1.5rem;">
                            <li>üèãÔ∏è Treinos e exerc√≠cios</li>
                            <li>üçé Planejamento de refei√ß√µes</li>
                            <li>üíß Rastreador de √°gua (8 copos/dia)</li>
                            <li>üò¥ Controle de sono</li>
                            <li>üßò Medita√ß√£o e mindfulness</li>
                            <li>üìä Medidas e peso</li>
                            <li>üíä Medicamentos e suplementos</li>
                        </ul>
                        <p style="margin-top:1rem; font-style:italic; color:#666;">üí° Dica: Consist√™ncia √© a chave! Use diariamente.</p>
                    `
                },
                'leitura': {
                    icon: 'üìö',
                    title: 'Planejador de Leitura',
                    content: `
                        <h3>üìö Planejador de Leitura</h3>
                        <p style="margin:1rem 0;">Organize seus livros e metas de leitura!</p>
                        <h4 style="margin-top:1.5rem;">Recursos:</h4>
                        <ul style="margin-left:1.5rem;">
                            <li>üìñ Lista de livros a ler</li>
                            <li>‚úÖ Livros conclu√≠dos</li>
                            <li>‚≠ê Avalia√ß√µes e notas</li>
                            <li>üìù Cita√ß√µes favoritas</li>
                            <li>üéØ Meta anual de livros</li>
                            <li>üìä Estat√≠sticas de leitura</li>
                            <li>üí≠ Reflex√µes sobre cada livro</li>
                        </ul>
                        <p style="margin-top:1rem; font-style:italic; color:#666;">üí° Dica: Meta realista: 1-2 livros por m√™s!</p>
                    `
                },
                'viagem': {
                    icon: '‚úàÔ∏è',
                    title: 'Planejador de Viagens',
                    content: `
                        <h3>‚úàÔ∏è Planejador de Viagens</h3>
                        <p style="margin:1rem 0;">Planeje aventuras inesquec√≠veis!</p>
                        <h4 style="margin-top:1.5rem;">Componentes:</h4>
                        <ul style="margin-left:1.5rem;">
                            <li>üó∫Ô∏è Destinos desejados</li>
                            <li>üìÖ Datas e itiner√°rio</li>
                            <li>üí∞ Or√ßamento da viagem</li>
                            <li>‚úàÔ∏è Voos e transportes</li>
                            <li>üè® Hospedagem</li>
                            <li>üìù Checklist de mala</li>
                            <li>üì∏ Lugares para visitar</li>
                            <li>üçΩÔ∏è Restaurantes recomendados</li>
                        </ul>
                        <p style="margin-top:1rem; font-style:italic; color:#666;">üí° Dica: Comece a planejar 3-6 meses antes!</p>
                    `
                },
                'metas': {
                    icon: 'üéØ',
                    title: 'Planejador de Metas',
                    content: `
                        <h3>üéØ Planejador de Metas e Objetivos</h3>
                        <p style="margin:1rem 0;">Transforme sonhos em realidade!</p>
                        <h4 style="margin-top:1.5rem;">Sistema SMART:</h4>
                        <ul style="margin-left:1.5rem;">
                            <li>üéØ <strong>S</strong>pecific - Espec√≠fica</li>
                            <li>üìä <strong>M</strong>easurable - Mensur√°vel</li>
                            <li>‚úÖ <strong>A</strong>chievable - Ating√≠vel</li>
                            <li>üí° <strong>R</strong>elevant - Relevante</li>
                            <li>‚è∞ <strong>T</strong>ime-bound - Temporal</li>
                        </ul>
                        <h4 style="margin-top:1.5rem;">√Åreas de Vida:</h4>
                        <ul style="margin-left:1.5rem;">
                            <li>üíº Carreira</li>
                            <li>üí∞ Financeiro</li>
                            <li>üí™ Sa√∫de</li>
                            <li>üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Relacionamentos</li>
                            <li>üéì Educa√ß√£o</li>
                            <li>üåü Desenvolvimento Pessoal</li>
                        </ul>
                        <p style="margin-top:1rem; font-style:italic; color:#666;">üí° Dica: Revise suas metas semanalmente!</p>
                    `
                },
                'habitos': {
                    icon: 'üî•',
                    title: 'Tracker de H√°bitos',
                    content: `
                        <h3>üî• Tracker de H√°bitos</h3>
                        <p style="margin:1rem 0;">Construa h√°bitos poderosos!</p>
                        <h4 style="margin-top:1.5rem;">H√°bitos Populares:</h4>
                        <ul style="margin-left:1.5rem;">
                            <li>üíß Beber 2L de √°gua</li>
                            <li>üèÉ Exerc√≠cio 30min</li>
                            <li>üìö Ler 20 p√°ginas</li>
                            <li>üßò Medita√ß√£o 10min</li>
                            <li>üò¥ Dormir 8h</li>
                            <li>üçé Comer saud√°vel</li>
                            <li>üìù Gratid√£o di√°ria</li>
                            <li>üö´ Sem redes sociais</li>
                        </ul>
                        <h4 style="margin-top:1.5rem;">Sistema de Tracking:</h4>
                        <ul style="margin-left:1.5rem;">
                            <li>‚úÖ Marque cada dia completo</li>
                            <li>üî• Veja seu streak crescer</li>
                            <li>üìä Analise padr√µes</li>
                            <li>üéØ Ajuste conforme necess√°rio</li>
                        </ul>
                        <p style="margin-top:1rem; font-style:italic; color:#666;">üí° Dica: Comece com 3-5 h√°bitos. Adicione mais gradualmente!</p>
                    `
                }
            };
            
            const biblio = bibliotecaData[tipo];
            if (!biblio) return;
            
            document.getElementById('biblioIcone').textContent = biblio.icon;
            document.getElementById('biblioTitulo').textContent = biblio.title;
            document.getElementById('biblioConteudo').innerHTML = biblio.content;
            document.getElementById('modalBiblioteca').style.display = 'block';
            
            incrementPaperSaved(5);
        }

        function updateGoogleCalendarUrl() {
            const baseUrl = window.location.origin;
            calendarUrlPrivate = `${baseUrl}/api/calendar/${currentUser.email}`;
            const masked = `${baseUrl}/api/calendar/********`;
            const el = document.getElementById('gcalUrl');
            if (el) el.value = masked;
        }

        function copyGcalUrl() {
            try { navigator.clipboard.writeText(calendarUrlPrivate).then(()=>alert(tr('msgCopied'))); }
            catch(_) {
                const input = document.getElementById('gcalUrl');
                if (input) { input.value = calendarUrlPrivate; input.select(); document.execCommand('copy'); input.value = '********'; }
                alert(tr('msgCopied'));
            }
        }
        function connectCalendarManual() {
            try {
                if (!calendarUrlPrivate) { alert(tr('msgUrlUnavailable')); return; }
                const url = `https://calendar.google.com/calendar/u/0/r?cid=${encodeURIComponent(calendarUrlPrivate)}`;
                window.open(url, '_blank');
                localStorage.setItem('planner_ultra_calendar_connected', 'yes');
            } catch (_) {}
        }

        function autoConnectCalendarOnLogin() {
            try {
                const domain = (currentUser.email || '').split('@')[1] || '';
                const already = localStorage.getItem('planner_ultra_calendar_connected');
                if (!calendarUrlPrivate) return;
                if (already === 'yes') return;
                if (domain.includes('gmail.com') || domain.includes('.google')) {
                    const url = `https://calendar.google.com/calendar/u/0/r?cid=${encodeURIComponent(calendarUrlPrivate)}`;
                    window.open(url, '_blank');
                    localStorage.setItem('planner_ultra_calendar_connected', 'yes');
                }
            } catch (_) {}
        }

        function getOfflineCalendarQueue() { try { return JSON.parse(localStorage.getItem(OFFLINE_CAL_QUEUE_KEY) || '[]'); } catch (_) { return []; } }
        function setOfflineCalendarQueue(arr) { localStorage.setItem(OFFLINE_CAL_QUEUE_KEY, JSON.stringify(arr)); }
        function addOfflineCalendarEvent(t) { const q = getOfflineCalendarQueue(); q.push(t); setOfflineCalendarQueue(q); }
        async function loadGoogleScripts() {
            if (!GOOGLE_CLIENT_ID) return false;
            await new Promise(r => { if (window.google && window.google.accounts) return r(); const s = document.createElement('script'); s.src = 'https://accounts.google.com/gsi/client'; s.onload = r; document.head.appendChild(s); });
            await new Promise(r => { if (window.gapi) return r(); const s = document.createElement('script'); s.src = 'https://apis.google.com/js/api.js'; s.onload = r; document.head.appendChild(s); });
            await new Promise(r => gapi.load('client', r));
            await gapi.client.init({ discoveryDocs: ['https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest'] });
            return true;
        }
        async function connectGoogleCalendarAuto() {
            try {
                const ok = await loadGoogleScripts();
                if (!ok) return;
                const existing = localStorage.getItem('planner_ultra_google_token');
                if (existing) { googleToken = existing; googleConnected = true; gapi.client.setToken({ access_token: googleToken }); syncOfflineCalendar(); return; }
                const tc = google.accounts.oauth2.initTokenClient({ client_id: GOOGLE_CLIENT_ID, scope: 'https://www.googleapis.com/auth/calendar.events', callback: t => { googleToken = t.access_token; googleConnected = true; localStorage.setItem('planner_ultra_google_token', googleToken); gapi.client.setToken({ access_token: googleToken }); syncOfflineCalendar(); } });
                tc.requestAccessToken({ prompt: '' });
            } catch (_) {}
        }
        async function createCalendarEventForTask(t) {
            try {
                if (!googleConnected || !t || !t.data || !t.hora) { addOfflineCalendarEvent(t); return; }
                const tz = Intl.DateTimeFormat().resolvedOptions().timeZone;
                const start = new Date(`${t.data}T${t.hora}:00`);
                const end = new Date(start.getTime() + ((t.duracao || 30) * 60000));
                const ev = {
                    summary: t.titulo || 'Tarefa',
                    description: t.descricao || '',
                    start: { dateTime: start.toISOString(), timeZone: tz },
                    end: { dateTime: end.toISOString(), timeZone: tz },
                    reminders: { useDefault: true }
                };
                await gapi.client.calendar.events.insert({ calendarId: 'primary', resource: ev });
            } catch (_) { addOfflineCalendarEvent(t); }
        }
        async function syncOfflineCalendar() {
            if (!googleConnected) return;
            const q = getOfflineCalendarQueue();
            if (!q.length) return;
            const remain = [];
            for (const t of q) {
                try { await createCalendarEventForTask(t); } catch(_) { remain.push(t); }
            }
            setOfflineCalendarQueue(remain);
        }

        function fecharModal(id) {
            document.getElementById(id).style.display = 'none';
        }

        async function exportarExcel() {
            if (!plannerAberto) {
                alert(tr('alertNoPlannerOpen'));
                return;
            }

            try {
                const { data: tarefas } = await supabase.from('tarefas').select('*').eq('planner_id', plannerAberto).order('data');
                
                if (!tarefas || tarefas.length === 0) {
                    alert(tr('alertNoTasksToExport'));
                    return;
                }

                // Criar CSV
                let csv = 'T√≠tulo,Descri√ß√£o,Categoria,Prioridade,Data,Hora,Dura√ß√£o (min),Status,Tags,Contexto,Energia\n';
                
                tarefas.forEach(t => {
                    const titulo = `"${(t.titulo || '').replace(/"/g, '""')}"`;
                    const descricao = `"${(t.descricao || '').replace(/"/g, '""')}"`;
                    const categoria = t.categoria || '';
                    const prioridade = t.prioridade || '';
                    const data = t.data ? formatDateBR(t.data) : '';
                    const hora = t.hora || '';
                    const duracao = t.duracao || '';
                    const status = t.done ? 'Conclu√≠da' : 'Pendente';
                    const tags = t.tags ? t.tags.join('; ') : '';
                    const contexto = t.contexto || '';
                    const energia = t.energia || '';
                    
                    csv += `${titulo},${descricao},${categoria},${prioridade},${data},${hora},${duracao},${status},${tags},${contexto},${energia}\n`;
                });

                // Download
                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                const plannerNome = planners.find(p => p.id === plannerAberto)?.nome || 'planner';
                
                link.setAttribute('href', url);
                link.setAttribute('download', `${plannerNome}_tarefas.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

                alert(tr('alertExportOk'));
                await incrementPaperSaved(tarefas.length);
            } catch (err) {
                console.error('Erro ao exportar:', err);
                alert(tr('alertExportErr'));
            }
        }

        async function baixarRelatorioPDF() {
            if (!plannerAberto) {
                alert(tr('alertNoPlannerOpen'));
                return;
            }

            try {
                const planner = planners.find(p => p.id === plannerAberto);
                const { data: tarefas } = await supabase.from('tarefas').select('*').eq('planner_id', plannerAberto);
                
                if (!tarefas || tarefas.length === 0) {
                    alert(tr('alertNoTasksReport'));
                    return;
                }

                const completed = tarefas.filter(t => t.done).length;
                const pending = tarefas.length - completed;
                const rate = Math.round((completed / tarefas.length) * 100);

                // Criar HTML do relat√≥rio
                let html = `
<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Relat√≥rio - ${planner.nome}</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 40px; max-width: 900px; margin: 0 auto; }
        h1 { color: #6B46C1; border-bottom: 3px solid #EC4899; padding-bottom: 10px; }
        .stats { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin: 30px 0; }
        .stat-box { background: #F3E8FF; padding: 20px; border-radius: 10px; text-align: center; }
        .stat-value { font-size: 2em; font-weight: bold; color: #6B46C1; }
        .stat-label { color: #666; margin-top: 5px; }
        table { width: 100%; border-collapse: collapse; margin-top: 30px; }
        th { background: #6B46C1; color: white; padding: 12px; text-align: left; }
        td { padding: 10px; border-bottom: 1px solid #ddd; }
        tr:nth-child(even) { background: #f9f9f9; }
        .done { color: #10B981; font-weight: bold; }
        .pending { color: #F59E0B; font-weight: bold; }
        .footer { margin-top: 40px; text-align: center; color: #666; font-size: 0.9em; }
    </style>
</head>
<body>
    <h1>üìä Relat√≥rio: ${planner.nome}</h1>
    <p><strong>Gerado em:</strong> ${new Date().toLocaleDateString('pt-BR')} √†s ${new Date().toLocaleTimeString('pt-BR')}</p>
    
    <div class="stats">
        <div class="stat-box">
            <div class="stat-value">${tarefas.length}</div>
            <div class="stat-label">Total de Tarefas</div>
        </div>
        <div class="stat-box">
            <div class="stat-value">${completed}</div>
            <div class="stat-label">Conclu√≠das</div>
        </div>
        <div class="stat-box">
            <div class="stat-value">${rate}%</div>
            <div class="stat-label">Taxa de Sucesso</div>
        </div>
    </div>

    <table>
        <thead>
            <tr>
                <th>T√≠tulo</th>
                <th>Prioridade</th>
                <th>Data</th>
                <th>Status</th>
            </tr>
        </thead>
        <tbody>
`;

                tarefas.forEach(t => {
                    const prioIcons = { 'baixa': 'üü¢', 'media': 'üü°', 'alta': 'üî¥', 'urgente': 'üî•', 'critica': '‚ö°' };
                    const statusClass = t.done ? 'done' : 'pending';
                    const statusText = t.done ? '‚úÖ Conclu√≠da' : '‚è≥ Pendente';
                    
                    html += `
            <tr>
                <td>${prioIcons[t.prioridade] || 'üìå'} ${t.titulo}</td>
                <td>${t.prioridade || '-'}</td>
                <td>${t.data ? formatDateBR(t.data) : '-'}</td>
                <td class="${statusClass}">${statusText}</td>
            </tr>
`;
                });

                html += `
        </tbody>
    </table>

    <div class="footer">
        <p>üå± Relat√≥rio gerado pelo Planner Premium ULTRA</p>
        <p>100% Digital ‚Ä¢ Zero Papel ‚Ä¢ Sustent√°vel</p>
    </div>
</body>
</html>
`;

                // Download HTML como PDF simulation
                const blob = new Blob([html], { type: 'text/html;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                
                link.setAttribute('href', url);
                link.setAttribute('download', `Relat√≥rio_${planner.nome}.html`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

                alert(tr('alertReportOk'));
                await incrementPaperSaved(5);
            } catch (err) {
                console.error('Erro ao gerar relat√≥rio:', err);
                alert(tr('alertReportErr'));
            }
        }

        window.onclick = e => {
            if (e.target.classList.contains('modal')) e.target.style.display = 'none';
        };
    </script>
    <button id="installBtn" class="install-btn" style="display:none;">Instalar agora</button>
    <div id="installGuide" class="install-guide" style="display:none;">
        <div class="install-guide-box">
            <div class="install-guide-title">Instalar no iPhone</div>
            <div class="install-guide-step">1. Abra o menu Compartilhar do Safari (√≠cone ‚¨ÜÔ∏è).</div>
            <div class="install-guide-step">2. Toque em "Adicionar √† Tela de In√≠cio".</div>
            <div class="install-guide-step">3. Confirme.</div>
            <div class="install-guide-actions">
                <button id="closeInstallGuide" class="btn-primario">Entendi</button>
            </div>
        </div>
    </div>
</body>
</html>

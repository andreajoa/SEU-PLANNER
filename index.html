<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‚ú® Planner Premium ULTRA</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --primary: #6B46C1; --secondary: #EC4899; --accent: #F59E0B;
            --success: #10B981; --danger: #EF4444; --dark: #1F2937;
            --light: #F9FAFB; --gray: #E5E7EB;
        }
        body { font-family: 'Segoe UI', sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: var(--dark); min-height: 100vh; }
        
        /* Auth Styles */
        .auth-container { min-height: 100vh; display: flex; align-items: center; justify-content: center; padding: 1rem; }
        .auth-box { background: white; border-radius: 20px; padding: 2.5rem 2rem; width: 100%; max-width: 400px; box-shadow: 0 25px 50px rgba(0,0,0,0.25); }
        .auth-logo { text-align: center; margin-bottom: 1.5rem; }
        .auth-logo-icon { font-size: 3.5em; }
        .auth-logo h1 { font-size: 1.5em; background: linear-gradient(135deg, var(--primary), var(--secondary)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
        .auth-tabs { display: flex; margin-bottom: 1.5rem; background: var(--gray); border-radius: 10px; padding: 4px; }
        .auth-tab { flex: 1; padding: 0.7rem; border: none; background: transparent; cursor: pointer; font-weight: 600; border-radius: 8px; transition: all 0.3s; color: #666; }
        .auth-tab.active { background: white; color: var(--primary); box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .auth-form { display: none; }
        .auth-form.active { display: block; }
        .form-group { margin-bottom: 1rem; }
        .form-group label { display: block; margin-bottom: 0.4rem; font-weight: 600; color: var(--dark); font-size: 0.85em; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 0.8rem; border: 2px solid var(--gray); border-radius: 10px; font-size: 1em; transition: all 0.2s; }
        .form-group input:focus, .form-group select:focus { outline: none; border-color: var(--primary); }
        .color-picker { display: flex; align-items: center; gap: 1rem; }
        .color-picker input[type="color"] { width: 60px; height: 45px; border: none; border-radius: 8px; cursor: pointer; }
        .color-preview { flex: 1; height: 45px; border-radius: 8px; border: 2px solid var(--gray); }
        .btn-auth { width: 100%; padding: 1rem; border: none; border-radius: 10px; font-weight: 700; font-size: 1em; cursor: pointer; background: linear-gradient(135deg, var(--primary), var(--secondary)); color: white; transition: all 0.3s; }
        .btn-auth:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(107,70,193,0.35); }
        .auth-msg { padding: 0.8rem; border-radius: 8px; margin-bottom: 1rem; font-size: 0.9em; display: none; }
        .auth-error { background: #FEE2E2; color: #DC2626; }
        .auth-success { background: #D1FAE5; color: #059669; }

        /* App Styles */
        .app-container { display: none; }
        .app-container.active { display: block; background: linear-gradient(135deg, #F9FAFB 0%, #F3E8FF 100%); min-height: 100vh; }
        .navbar { background: linear-gradient(135deg, var(--primary), var(--secondary)); color: white; padding: 1rem 1.5rem; position: sticky; top: 0; z-index: 100; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem; }
        .navbar-title { font-size: 1.4em; font-weight: 800; }
        .navbar-user { display: flex; align-items: center; gap: 0.8rem; flex-wrap: wrap; }
        .user-info { display: flex; align-items: center; gap: 0.5rem; background: rgba(255,255,255,0.2); padding: 0.4rem 1rem; border-radius: 20px; font-size: 0.9em; }
        .btn-nav { background: rgba(255,255,255,0.2); border: 2px solid white; color: white; padding: 0.5rem 1rem; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 0.8em; transition: all 0.3s; }
        .btn-nav:hover { background: white; color: var(--primary); }
        .container { max-width: 1100px; margin: 0 auto; padding: 1.5rem 1rem; }
        .welcome-card { background: white; border-radius: 16px; padding: 1.5rem; margin-bottom: 1.5rem; box-shadow: 0 4px 15px rgba(0,0,0,0.08); }
        .planner-types { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 1rem; margin-bottom: 1.5rem; }
        .planner-card { background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 15px rgba(0,0,0,0.08); transition: all 0.3s; border-top: 4px solid; }
        .planner-card:hover { transform: translateY(-5px); }
        .planner-header { color: white; padding: 1.2rem; text-align: center; }
        .planner-icon { font-size: 2em; }
        .planner-title { font-size: 1em; font-weight: 700; margin-top: 0.3rem; }
        .planner-body { padding: 1rem; }
        .btn-criar { width: 100%; padding: 0.7rem; background: linear-gradient(135deg, var(--primary), var(--secondary)); color: white; border: none; border-radius: 8px; font-weight: 700; cursor: pointer; transition: all 0.3s; }
        .btn-criar:hover { transform: translateY(-2px); }
        .meus-planners { background: white; border-radius: 16px; padding: 1.5rem; box-shadow: 0 4px 15px rgba(0,0,0,0.08); }
        .meus-planners h2 { margin-bottom: 1rem; font-size: 1.2em; }
        .planners-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 1rem; }
        .planner-item { color: white; border-radius: 12px; padding: 1.2rem; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .planner-item-nome { font-size: 1.1em; font-weight: 700; margin-bottom: 0.3rem; }
        .planner-item-info { font-size: 0.8em; opacity: 0.9; margin-bottom: 0.8rem; }
        .planner-item-acoes { display: flex; gap: 0.4rem; flex-wrap: wrap; }
        .planner-item-acoes button { flex: 1; padding: 0.5rem; background: rgba(255,255,255,0.2); color: white; border: 1px solid white; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 0.75em; min-width: 60px; }
        .planner-item-acoes button:hover { background: white; color: var(--dark); }

        /* Modal */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); overflow-y: auto; }
        .modal-content { background: white; margin: 3% auto; padding: 1.5rem; border-radius: 16px; width: 92%; max-width: 550px; max-height: 90vh; overflow-y: auto; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; }
        .modal-header h2 { font-size: 1.3em; }
        .close-modal { font-size: 1.8em; cursor: pointer; color: #999; background: none; border: none; line-height: 1; }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
        .form-actions { display: flex; gap: 0.8rem; margin-top: 1rem; }
        .btn-primario, .btn-secundario { flex: 1; padding: 0.7rem; border: none; border-radius: 8px; font-weight: 700; cursor: pointer; font-size: 0.95em; }
        .btn-primario { background: linear-gradient(135deg, var(--primary), var(--secondary)); color: white; }
        .btn-secundario { background: var(--gray); color: var(--dark); }
        .contador { background: linear-gradient(135deg, var(--primary), var(--secondary)); color: white; padding: 1rem; border-radius: 8px; text-align: center; margin-bottom: 1rem; }
        .contador-numero { font-size: 1.8em; font-weight: 700; }
        .tarefa-item { background: var(--light); padding: 0.8rem; border-radius: 8px; margin-bottom: 0.6rem; display: flex; gap: 0.8rem; align-items: center; border-left: 4px solid var(--primary); }
        .tarefa-item.concluida { opacity: 0.5; }
        .tarefa-item.concluida .tarefa-titulo { text-decoration: line-through; }
        .tarefa-checkbox { width: 20px; height: 20px; cursor: pointer; accent-color: var(--primary); }
        .tarefa-conteudo { flex: 1; }
        .tarefa-titulo { font-weight: 600; font-size: 0.95em; }
        .tarefa-meta { font-size: 0.75em; color: #666; margin-top: 0.2rem; }
        .btn-del { padding: 0.3rem 0.6rem; background: var(--danger); color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.8em; }
        .empty-msg { color: #999; text-align: center; padding: 1.5rem; font-size: 0.9em; }

        @media (max-width: 600px) {
            .navbar { flex-direction: column; text-align: center; }
            .form-row { grid-template-columns: 1fr; }
            .modal-content { margin: 5% auto; padding: 1.2rem; }
        }
    </style>
</head>
<body>
    <!-- Auth -->
    <div class="auth-container" id="authContainer">
        <div class="auth-box">
            <div class="auth-logo">
                <div class="auth-logo-icon">‚ú®</div>
                <h1>Planner Premium ULTRA</h1>
            </div>
            <div class="auth-tabs">
                <button class="auth-tab active" onclick="showTab('login')">Entrar</button>
                <button class="auth-tab" onclick="showTab('signup')">Criar Conta</button>
            </div>
            <div id="authError" class="auth-msg auth-error"></div>
            <div id="authSuccess" class="auth-msg auth-success"></div>

            <form id="loginForm" class="auth-form active" onsubmit="handleLogin(event)">
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="loginEmail" placeholder="seu@email.com" required>
                </div>
                <div class="form-group">
                    <label>Senha</label>
                    <input type="password" id="loginPassword" placeholder="Sua senha" required>
                </div>
                <button type="submit" class="btn-auth">Entrar</button>
            </form>

            <form id="signupForm" class="auth-form" onsubmit="handleSignup(event)">
                <div class="form-group">
                    <label>Nome Completo</label>
                    <input type="text" id="signupName" placeholder="Seu nome" required>
                </div>
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="signupEmail" placeholder="seu@email.com" required>
                </div>
                <div class="form-group">
                    <label>Senha (m√≠n. 6 caracteres)</label>
                    <input type="password" id="signupPassword" placeholder="Sua senha" minlength="6" required>
                </div>
                <div class="form-group">
                    <label>Confirmar Senha</label>
                    <input type="password" id="signupConfirm" placeholder="Repita a senha" required>
                </div>
                <button type="submit" class="btn-auth">Criar Conta</button>
            </form>
        </div>
    </div>

    <!-- App -->
    <div class="app-container" id="appContainer">
        <div class="navbar">
            <div class="navbar-title">‚ú® Planner Premium</div>
            <div class="navbar-user">
                <div class="user-info">üë§ <span id="userName">Usu√°rio</span></div>
                <button class="btn-nav" onclick="logout()">Sair</button>
            </div>
        </div>
        <div class="container">
            <div class="welcome-card">
                <h1 style="font-size:1.5em; margin-bottom:0.3rem;">Ol√°, <span id="welcomeName">Usu√°rio</span>! üëã</h1>
                <p style="color:#666; font-size:0.9em;">Crie e organize seus planners.</p>
            </div>

            <h2 style="margin-bottom:1rem; font-size:1.1em;">Criar Novo Planner</h2>
            <div class="planner-types">
                <div class="planner-card" style="border-top-color:#10B981;" onclick="criarPlanner('todo')">
                    <div class="planner-header" style="background:linear-gradient(135deg,#10B981,#059669);"><div class="planner-icon">‚úÖ</div><div class="planner-title">To-Do List</div></div>
                    <div class="planner-body"><button class="btn-criar">Criar</button></div>
                </div>
                <div class="planner-card" style="border-top-color:#3B82F6;" onclick="criarPlanner('projeto')">
                    <div class="planner-header" style="background:linear-gradient(135deg,#3B82F6,#1D4ED8);"><div class="planner-icon">üèóÔ∏è</div><div class="planner-title">Projetos</div></div>
                    <div class="planner-body"><button class="btn-criar">Criar</button></div>
                </div>
                <div class="planner-card" style="border-top-color:#F59E0B;" onclick="criarPlanner('habitos')">
                    <div class="planner-header" style="background:linear-gradient(135deg,#F59E0B,#D97706);"><div class="planner-icon">üî•</div><div class="planner-title">H√°bitos</div></div>
                    <div class="planner-body"><button class="btn-criar">Criar</button></div>
                </div>
                <div class="planner-card" style="border-top-color:#8B5CF6;" onclick="criarPlanner('financeiro')">
                    <div class="planner-header" style="background:linear-gradient(135deg,#8B5CF6,#6D28D9);"><div class="planner-icon">üí∞</div><div class="planner-title">Financeiro</div></div>
                    <div class="planner-body"><button class="btn-criar">Criar</button></div>
                </div>
            </div>

            <div class="meus-planners">
                <h2>üìã Meus Planners</h2>
                <div class="planners-grid" id="meusPlanners"><p class="empty-msg">Nenhum planner ainda.</p></div>
            </div>
        </div>
    </div>

    <!-- Modal Criar -->
    <div id="modalCriar" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2><span id="modalIcone"></span> <span id="modalTitulo">Novo Planner</span></h2>
                <button class="close-modal" onclick="fecharModal('modalCriar')">&times;</button>
            </div>
            <div class="form-group">
                <label>Nome do Planner *</label>
                <input type="text" id="inputNome" placeholder="Ex: Metas 2025">
            </div>
            <div class="form-group">
                <label>Cor do Planner</label>
                <div class="color-picker">
                    <input type="color" id="inputCor" value="#6B46C1" onchange="updateColorPreview()">
                    <div class="color-preview" id="colorPreview" style="background:#6B46C1;"></div>
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>√çcone</label>
                    <input type="text" id="inputIcone" maxlength="2" value="‚ú®">
                </div>
                <div class="form-group">
                    <label>Hor√°rio do Alarme</label>
                    <input type="time" id="inputAlarme" value="09:00">
                </div>
            </div>
            <div class="form-group">
                <label>Data de In√≠cio</label>
                <input type="date" id="inputDataInicio">
            </div>
            <div class="form-actions">
                <button class="btn-secundario" onclick="fecharModal('modalCriar')">Cancelar</button>
                <button class="btn-primario" onclick="salvarPlanner()">Criar Planner</button>
            </div>
        </div>
    </div>

    <!-- Modal Ver -->
    <div id="modalVer" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2><span id="verIcone"></span> <span id="verNome">Planner</span></h2>
                <button class="close-modal" onclick="fecharModal('modalVer')">&times;</button>
            </div>
            <div class="contador">
                <div class="contador-numero" id="contadorTarefas">0</div>
                <div class="contador-texto">Tarefas</div>
            </div>
            <div id="alarmeInfo" style="background:#FEF3C7; padding:0.8rem; border-radius:8px; margin-bottom:1rem; font-size:0.85em; display:none;">
                üîî Alarme: <strong id="alarmeHora">09:00</strong>
            </div>
            <div class="form-group">
                <label>Nova Tarefa *</label>
                <input type="text" id="inputTituloTarefa" placeholder="T√≠tulo da tarefa">
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>Prioridade</label>
                    <select id="inputPrioridade">
                        <option value="baixa">üü¢ Baixa</option>
                        <option value="media" selected>üü° M√©dia</option>
                        <option value="alta">üî¥ Alta</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Data</label>
                    <input type="date" id="inputDataMeta">
                </div>
            </div>
            <div class="form-group">
                <label>Hor√°rio Lembrete</label>
                <input type="time" id="inputHoraTarefa">
            </div>
            <button class="btn-primario" style="width:100%; margin-bottom:1rem;" onclick="adicionarTarefa()">+ Adicionar Tarefa</button>
            <div id="listaTarefas"></div>
            <div class="form-actions" style="margin-top:1rem;">
                <button class="btn-secundario" onclick="compartilharWhatsApp()">üì± WhatsApp</button>
                <button class="btn-secundario" onclick="enviarEmail()">üìß Email</button>
                <button class="btn-primario" onclick="baixarPDF()">üì• Baixar</button>
            </div>
            <button class="btn-secundario" style="width:100%; margin-top:0.8rem;" onclick="fecharModal('modalVer')">Fechar</button>
        </div>
    </div>

    <script>
        // Database em mem√≥ria (simulando persist√™ncia)
        const db = { users: {}, planners: {} };
        let currentUser = null;
        let planners = [];
        let planerAtualAberto = null;
        let tipoAtual = '';

        const tiposPlanner = {
            'todo': { nome: 'To-Do List', icone: '‚úÖ', cor: '#10B981' },
            'projeto': { nome: 'Projeto', icone: 'üèóÔ∏è', cor: '#3B82F6' },
            'habitos': { nome: 'H√°bitos', icone: 'üî•', cor: '#F59E0B' },
            'financeiro': { nome: 'Financeiro', icone: 'üí∞', cor: '#8B5CF6' }
        };

        // Auth
        function showTab(tab) {
            document.querySelectorAll('.auth-tab').forEach((t,i) => {
                t.classList.toggle('active', (tab==='login' && i===0) || (tab==='signup' && i===1));
            });
            document.getElementById('loginForm').classList.toggle('active', tab==='login');
            document.getElementById('signupForm').classList.toggle('active', tab==='signup');
            hideMsg();
        }

        function showError(msg) { 
            const el = document.getElementById('authError'); 
            el.textContent = msg; 
            el.style.display = 'block'; 
            document.getElementById('authSuccess').style.display = 'none'; 
        }
        function showSuccess(msg) { 
            const el = document.getElementById('authSuccess'); 
            el.textContent = msg; 
            el.style.display = 'block'; 
            document.getElementById('authError').style.display = 'none'; 
        }
        function hideMsg() { 
            document.getElementById('authError').style.display = 'none'; 
            document.getElementById('authSuccess').style.display = 'none'; 
        }

        function handleSignup(e) {
            e.preventDefault();
            const name = document.getElementById('signupName').value.trim();
            const email = document.getElementById('signupEmail').value.trim().toLowerCase();
            const pass = document.getElementById('signupPassword').value;
            const confirm = document.getElementById('signupConfirm').value;

            if (pass !== confirm) { showError('As senhas n√£o coincidem!'); return; }
            if (pass.length < 6) { showError('Senha deve ter m√≠nimo 6 caracteres!'); return; }
            if (db.users[email]) { showError('Este email j√° est√° cadastrado!'); return; }

            db.users[email] = { name, email, password: pass };
            db.planners[email] = [];
            showSuccess('Conta criada! Entrando...');
            setTimeout(() => loginUser(db.users[email]), 800);
        }

        function handleLogin(e) {
            e.preventDefault();
            const email = document.getElementById('loginEmail').value.trim().toLowerCase();
            const pass = document.getElementById('loginPassword').value;

            if (!db.users[email]) { showError('Email n√£o encontrado!'); return; }
            if (db.users[email].password !== pass) { showError('Senha incorreta!'); return; }

            loginUser(db.users[email]);
        }

        function loginUser(user) {
            currentUser = user;
            planners = db.planners[user.email] || [];
            document.getElementById('authContainer').style.display = 'none';
            document.getElementById('appContainer').classList.add('active');
            document.getElementById('userName').textContent = user.name.split(' ')[0];
            document.getElementById('welcomeName').textContent = user.name.split(' ')[0];
            renderPlanners();
            requestNotificationPermission();
        }

        function logout() {
            currentUser = null;
            planners = [];
            document.getElementById('appContainer').classList.remove('active');
            document.getElementById('authContainer').style.display = 'flex';
            document.getElementById('loginEmail').value = '';
            document.getElementById('loginPassword').value = '';
            hideMsg();
            showTab('login');
        }

        function renderPlanners() {
            const c = document.getElementById('meusPlanners');
            if (!planners.length) { c.innerHTML = '<p class="empty-msg">Nenhum planner ainda. Crie o primeiro!</p>'; return; }
            c.innerHTML = planners.map(p => `
                <div class="planner-item" style="background:linear-gradient(135deg,${p.cor},${p.cor}dd);">
                    <div class="planner-item-nome">${p.icone} ${p.nome}</div>
                    <div class="planner-item-info">${p.tarefas.length} tarefas ${p.alarme ? '‚Ä¢ üîî '+p.alarme : ''}</div>
                    <div class="planner-item-acoes">
                        <button onclick="abrirPlanner(${p.id})">Abrir</button>
                        <button onclick="deletarPlanner(${p.id})">Deletar</button>
                    </div>
                </div>
            `).join('');
        }

        function updateColorPreview() {
            document.getElementById('colorPreview').style.background = document.getElementById('inputCor').value;
        }

        function criarPlanner(tipo) {
            tipoAtual = tipo;
            const cfg = tiposPlanner[tipo];
            document.getElementById('modalIcone').textContent = cfg.icone;
            document.getElementById('modalTitulo').textContent = 'Novo ' + cfg.nome;
            document.getElementById('inputNome').value = '';
            document.getElementById('inputCor').value = cfg.cor;
            document.getElementById('colorPreview').style.background = cfg.cor;
            document.getElementById('inputIcone').value = cfg.icone;
            document.getElementById('inputAlarme').value = '09:00';
            document.getElementById('inputDataInicio').value = new Date().toISOString().split('T')[0];
            document.getElementById('modalCriar').style.display = 'block';
        }

        function salvarPlanner() {
            const nome = document.getElementById('inputNome').value.trim();
            if (!nome) { alert('Digite um nome!'); return; }

            const novoPlanner = {
                id: Date.now(),
                tipo: tipoAtual,
                nome: nome,
                icone: document.getElementById('inputIcone').value || 'üìã',
                cor: document.getElementById('inputCor').value,
                alarme: document.getElementById('inputAlarme').value,
                dataInicio: document.getElementById('inputDataInicio').value,
                tarefas: []
            };

            planners.push(novoPlanner);
            db.planners[currentUser.email] = planners;
            fecharModal('modalCriar');
            renderPlanners();

            // Configurar alarme
            if (novoPlanner.alarme) {
                agendarAlarme(novoPlanner);
            }
        }

        function abrirPlanner(id) {
            const p = planners.find(x => x.id === id);
            if (!p) return;
            planerAtualAberto = id;
            document.getElementById('verIcone').textContent = p.icone;
            document.getElementById('verNome').textContent = p.nome;
            document.getElementById('contadorTarefas').textContent = p.tarefas.length;
            
            if (p.alarme) {
                document.getElementById('alarmeInfo').style.display = 'block';
                document.getElementById('alarmeHora').textContent = p.alarme;
            } else {
                document.getElementById('alarmeInfo').style.display = 'none';
            }
            
            renderTarefas();
            document.getElementById('modalVer').style.display = 'block';
        }

        function renderTarefas() {
            const p = planners.find(x => x.id === planerAtualAberto);
            const c = document.getElementById('listaTarefas');
            if (!p.tarefas.length) { c.innerHTML = '<p class="empty-msg">Nenhuma tarefa ainda.</p>'; return; }
            c.innerHTML = p.tarefas.map((t, i) => `
                <div class="tarefa-item ${t.concluida ? 'concluida' : ''}" style="border-left-color:${t.prioridade==='alta'?'#EF4444':t.prioridade==='media'?'#F59E0B':'#10B981'};">
                    <input type="checkbox" class="tarefa-checkbox" ${t.concluida ? 'checked' : ''} onchange="toggleTarefa(${i})">
                    <div class="tarefa-conteudo">
                        <div class="tarefa-titulo">${t.titulo}</div>
                        <div class="tarefa-meta">${t.data ? 'üìÖ '+t.data : ''} ${t.hora ? '‚è∞ '+t.hora : ''}</div>
                    </div>
                    <button class="btn-del" onclick="deletarTarefa(${i})">‚úï</button>
                </div>
            `).join('');
        }

        function adicionarTarefa() {
            const titulo = document.getElementById('inputTituloTarefa').value.trim();
            if (!titulo) { alert('Digite o t√≠tulo!'); return; }
            const p = planners.find(x => x.id === planerAtualAberto);
            const novaTarefa = {
                titulo: titulo,
                prioridade: document.getElementById('inputPrioridade').value,
                data: document.getElementById('inputDataMeta').value,
                hora: document.getElementById('inputHoraTarefa').value,
                concluida: false
            };
            p.tarefas.push(novaTarefa);
            db.planners[currentUser.email] = planners;
            
            // Agendar lembrete se tiver hora
            if (novaTarefa.hora && novaTarefa.data) {
                agendarLembreteTarefa(novaTarefa, p.nome);
            }
            
            document.getElementById('inputTituloTarefa').value = '';
            document.getElementById('inputDataMeta').value = '';
            document.getElementById('inputHoraTarefa').value = '';
            document.getElementById('contadorTarefas').textContent = p.tarefas.length;
            renderTarefas();
        }

        function toggleTarefa(i) {
            const p = planners.find(x => x.id === planerAtualAberto);
            p.tarefas[i].concluida = !p.tarefas[i].concluida;
            db.planners[currentUser.email] = planners;
            renderTarefas();
        }

        function deletarTarefa(i) {
            const p = planners.find(x => x.id === planerAtualAberto);
            p.tarefas.splice(i, 1);
            db.planners[currentUser.email] = planners;
            document.getElementById('contadorTarefas').textContent = p.tarefas.length;
            renderTarefas();
        }

        function deletarPlanner(id) {
            if (!confirm('Deletar este planner?')) return;
            planners = planners.filter(x => x.id !== id);
            db.planners[currentUser.email] = planners;
            renderPlanners();
        }

        function fecharModal(id) { document.getElementById(id).style.display = 'none'; }

        // Compartilhar WhatsApp
        function compartilharWhatsApp() {
            const p = planners.find(x => x.id === planerAtualAberto);
            if (!p) return;
            let msg = `‚ú® *${p.icone} ${p.nome}*\n\n`;
            msg += `üìã *Tarefas (${p.tarefas.length}):*\n`;
            p.tarefas.forEach((t, i) => {
                msg += `${t.concluida ? '‚úÖ' : '‚¨ú'} ${t.titulo}`;
                if (t.data) msg += ` (${t.data})`;
                msg += '\n';
            });
            if (p.alarme) msg += `\nüîî Alarme: ${p.alarme}`;
            msg += '\n\n_Criado com Planner Premium ULTRA_';
            window.open('https://wa.me/?text=' + encodeURIComponent(msg), '_blank');
        }

        // Enviar Email
        function enviarEmail() {
            const p = planners.find(x => x.id === planerAtualAberto);
            if (!p) return;
            let subject = `${p.icone} ${p.nome} - Planner Premium`;
            let body = `${p.icone} ${p.nome}\n\n`;
            body += `TAREFAS (${p.tarefas.length}):\n\n`;
            p.tarefas.forEach((t, i) => {
                body += `${i+1}. [${t.concluida ? 'X' : ' '}] ${t.titulo}`;
                if (t.data) body += ` - Data: ${t.data}`;
                if (t.hora) body += ` √†s ${t.hora}`;
                body += '\n';
            });
            if (p.alarme) body += `\nAlarme configurado: ${p.alarme}`;
            body += '\n\n---\nCriado com Planner Premium ULTRA';
            window.location.href = `mailto:?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
        }

        // Baixar PDF (TXT)
        function baixarPDF() {
            const p = planners.find(x => x.id === planerAtualAberto);
            if (!p) return;
            let txt = `‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n`;
            txt += `   ${p.icone} ${p.nome.toUpperCase()}\n`;
            txt += `‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\n`;
            if (p.alarme) txt += `üîî Alarme: ${p.alarme}\n`;
            if (p.dataInicio) txt += `üìÖ In√≠cio: ${p.dataInicio}\n`;
            txt += `\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n`;
            txt += `   TAREFAS (${p.tarefas.length})\n`;
            txt += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n`;
            p.tarefas.forEach((t, i) => {
                const status = t.concluida ? '‚úÖ' : '‚¨ú';
                const prio = t.prioridade === 'alta' ? 'üî¥' : t.prioridade === 'media' ? 'üü°' : 'üü¢';
                txt += `${status} ${prio} ${t.titulo}\n`;
                if (t.data || t.hora) {
                    txt += `   üìÖ ${t.data || '-'} ‚è∞ ${t.hora || '-'}\n`;
                }
                txt += '\n';
            });
            txt += `\n‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n`;
            txt += `   Criado com Planner Premium ULTRA ‚ú®\n`;
            txt += `‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n`;
            
            const blob = new Blob([txt], { type: 'text/plain;charset=utf-8' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `${p.nome.replace(/\s+/g, '_')}_planner.txt`;
            a.click();
        }

        // Notifica√ß√µes e Alarmes
        function requestNotificationPermission() {
            if ('Notification' in window && Notification.permission === 'default') {
                Notification.requestPermission();
            }
        }

        function agendarAlarme(planner) {
            if (!('Notification' in window) || Notification.permission !== 'granted') return;
            
            const [h, m] = planner.alarme.split(':').map(Number);
            const agora = new Date();
            const alarmeHoje = new Date();
            alarmeHoje.setHours(h, m, 0, 0);
            
            let diff = alarmeHoje - agora;
            if (diff < 0) diff += 24 * 60 * 60 * 1000; // Pr√≥ximo dia
            
            setTimeout(() => {
                new Notification(`üîî ${planner.icone} ${planner.nome}`, {
                    body: `Hora de verificar seu planner! ${planner.tarefas.length} tarefas.`,
                    icon: '‚ú®',
                    requireInteraction: true
                });
                // Tentar vibrar (mobile)
                if (navigator.vibrate) navigator.vibrate([200, 100, 200, 100, 200]);
            }, diff);
        }

        function agendarLembreteTarefa(tarefa, plannerNome) {
            if (!('Notification' in window) || Notification.permission !== 'granted') return;
            
            const [h, m] = tarefa.hora.split(':').map(Number);
            const dataAlvo = new Date(tarefa.data + 'T' + tarefa.hora);
            const agora = new Date();
            
            let diff = dataAlvo - agora;
            if (diff > 0) {
                setTimeout(() => {
                    new Notification(`‚è∞ Lembrete: ${tarefa.titulo}`, {
                        body: `Tarefa do planner "${plannerNome}"`,
                        requireInteraction: true
                    });
                    if (navigator.vibrate) navigator.vibrate([200, 100, 200]);
                }, diff);
            }
        }

        // Fechar modal clicando fora
        window.onclick = function(e) {
            if (e.target.classList.contains('modal')) e.target.style.display = 'none';
        };

        // Inicializa√ß√£o
        document.getElementById('inputDataInicio').value = new Date().toISOString().split('T')[0];
    </script>
</body>
</html>
